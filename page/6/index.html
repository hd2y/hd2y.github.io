<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>华灯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="盈月舞清风，华灯自摇曳。">
<meta property="og:type" content="website">
<meta property="og:title" content="华灯">
<meta property="og:url" content="http://example.com/page/6/index.html">
<meta property="og:site_name" content="华灯">
<meta property="og:description" content="盈月舞清风，华灯自摇曳。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="hd2y">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="华灯" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">华灯</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-190529-server-of-tcp-protocol" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/server-of-tcp-protocol/" class="article-date">
  <time class="dt-published" datetime="2019-05-29T08:14:00.000Z" itemprop="datePublished">2019-05-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/server-of-tcp-protocol/">TCP协议之服务端</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>之前介绍过串口通讯，相对来说串口通讯是比较简单的，不用关心另外一端的连接状态，只需要打开串口，监听接收事件即可。发送也很简单，一个<code>Write</code>方法控制。</p>
<p>但是串口的问题也很明显，我们无法得知另外一端是否可用，只能通过通讯协议里进行指定，设置心跳包或者指定接收后进行响应。打开监听简单，但是维持监听判断监听状态就相对麻烦一些。</p>
<p>对于开发来说，<code>Socket</code>通信（网口）要麻烦一些，因为需要了解<code>TCP/UPD</code>协议，还区分了服务端与客户端，但是硬件连入局域网就可以通信，所以使用<code>Socket</code>通信也是一种主流的解决方案。</p>
<p>关于基础的知识比如什么是<code>Socket</code>通信，什么是<code>TCP</code>协议，这里也不做展开，有兴趣的可以自己搜索相关资料了解。</p>
<h2 id="Socket通信调试工具"><a href="#Socket通信调试工具" class="headerlink" title="Socket通信调试工具"></a><code>Socket</code>通信调试工具</h2><p>个人使用较多的是<code>TCP/UDP Socket 调试工具</code>。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver1_1562747097761.png" alt="tcpserver1"></p>
<p>使用中可能存在的一些问题：</p>
<ol>
<li>偶发关闭了另外一端，会导致调试工具异常；</li>
<li>编码默认本地字符集，所以经常导致中文乱码，需要收集16进制自行解析编码；</li>
<li>在收集数据的时候，接收区会添加接收的时间，解析时需要我们自己将这些字符替换掉；</li>
</ol>
<p>当然这些基本也不会影响我们的调试工作。</p>
<h2 id="单客户端"><a href="#单客户端" class="headerlink" title="单客户端"></a>单客户端</h2><p>首先我们使用调试工具进行模拟，调试工具中创建一个<code>TCP Server</code>，监听端口根据自己需求设置。因为我们没有监听指定端口的需求，只是进行模拟测试，我们这里设置监听<code>5555</code>端口进行测试：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver11_1562747097860.png" alt="tcpserver11"></p>
<p>如上图，创建的<code>TCP Server</code>自动启动了监听。</p>
<p>服务端创建成功，我们就需要创建一个客户端进行连接，来进行数据的通讯，同样的我们选择<code>TCP Client</code>进行创建，并连接到本机的<code>5555</code>端口：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver2_1562747097762.png" alt="tcpserver2"></p>
<p>这时我们就可以点击TCP Client下打开的客户端向服务端发送消息，或选择<code>TCP Server</code>服务端下连接的客户端，向指定客户端发送消息：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver3_1562747097762.png" alt="tcpserver3"></p>
<p>那么，我们应该怎样在程序中打开服务端，监听客户端请求呢？可以参考以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SocketTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TcpServerTest.Test();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TcpServerTest</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 服务端地址默认本地</span></span><br><span class="line">            IPAddress address = IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">            <span class="comment">// 提醒用户输入要监听的端口</span></span><br><span class="line">            Console.Write(<span class="string">&quot;请输入您要监听的端口：&quot;</span>);</span><br><span class="line">            <span class="built_in">string</span> input = Console.ReadLine();</span><br><span class="line">            <span class="built_in">int</span> port;</span><br><span class="line">            <span class="keyword">while</span> (!<span class="built_in">int</span>.TryParse(input, <span class="keyword">out</span> port))</span><br><span class="line">            &#123;</span><br><span class="line">                Console.Write(<span class="string">&quot;您输入的端口错误，请重新输入：&quot;</span>);</span><br><span class="line">                input = Console.ReadLine();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 创建并打开监听</span></span><br><span class="line">                TcpListener listener = <span class="keyword">new</span> TcpListener(address, port);</span><br><span class="line">                listener.Start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                ConsoleLogger.Info(<span class="string">$&quot;启用服务端 <span class="subst">&#123;listener.Server.LocalEndPoint&#125;</span> 成功，等待客户端连接。&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待客户端的连接请求</span></span><br><span class="line">                TcpClient client = listener.AcceptTcpClient();</span><br><span class="line"></span><br><span class="line">                ConsoleLogger.Info(<span class="string">$&quot;客户端连接成功：<span class="subst">&#123;client.Client.RemoteEndPoint.ToString()&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 建立与客户端的数据流</span></span><br><span class="line">                <span class="keyword">using</span> NetworkStream stream = client.GetStream();</span><br><span class="line">                <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];<span class="comment">//设置缓存长度</span></span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> length = stream.Read(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line">                        <span class="keyword">if</span> (length &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConsoleLogger.Info(<span class="string">$&quot;[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]接收到数据: <span class="subst">&#123;Console.InputEncoding.GetString(buffer, <span class="number">0</span>, length)&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 回发接收到的消息给客户端</span></span><br><span class="line">                            client.Client.Send(buffer, <span class="number">0</span>, length, SocketFlags.None);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            ConsoleLogger.Info(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]关闭&quot;</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (Exception exc)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ConsoleLogger.Error(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]引发未处理异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception exc)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleLogger.Error(<span class="string">$&quot;TCP服务端测试出现了未经处理的异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ConsoleLogger.Info(<span class="string">&quot;测试结束&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConsoleLogger</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">object</span> sync = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Error</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.White;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.Red;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span> Error: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Info</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.Black;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.White;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>  Info: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上例子展示了一个服务端的创建与监听过程，连接成功后如果接收到客户端的消息，“复读”该消息发送给客户端。</p>
<p>我们可以进行测试，首先运行项目，在控制台创建服务端，并开启监听。服务端创建成功后，使用Socket的调试工具创建一个TCP客户端，与服务端进行通讯测试，结束后断开连接：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver6_1562747097787.png" alt="tcpserver6"></p>
<h2 id="多客户端连接"><a href="#多客户端连接" class="headerlink" title="多客户端连接"></a>多客户端连接</h2><p>如上例子正如测试结果一样，只能接受一个客户端的连接，当该客户端连接成功后，其他客户端如果再申请与服务端进行连接，虽然不会被拒绝，但是发送消息将无法获得响应。</p>
<p>关于如何建立与多个客户端连接，这里有两种方案。</p>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>使用<code>while</code>循环，配合<code>AcceptTcpClient</code>方法，不停的监听来自客户端的请求。</p>
<p>循环中，一旦客户端连接成功，开启一个线程处理服务端与客户端的数据交互。然后循环继续，等待下一个客户端连接。</p>
<p>这里我们将测试用例中的<code>Test</code>方法进行改写：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 服务端地址默认本地</span></span><br><span class="line">    IPAddress address = IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    <span class="comment">// 提醒用户输入要监听的端口</span></span><br><span class="line">    Console.Write(<span class="string">&quot;请输入您要监听的端口：&quot;</span>);</span><br><span class="line">    <span class="built_in">string</span> input = Console.ReadLine();</span><br><span class="line">    <span class="built_in">int</span> port;</span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">int</span>.TryParse(input, <span class="keyword">out</span> port))</span><br><span class="line">    &#123;</span><br><span class="line">        Console.Write(<span class="string">&quot;您输入的端口错误，请重新输入：&quot;</span>);</span><br><span class="line">        input = Console.ReadLine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建并打开监听</span></span><br><span class="line">        TcpListener listener = <span class="keyword">new</span> TcpListener(address, port);</span><br><span class="line">        listener.Start();</span><br><span class="line"></span><br><span class="line">        ConsoleLogger.Info(<span class="string">$&quot;启用服务端 <span class="subst">&#123;listener.Server.LocalEndPoint&#125;</span> 成功，等待客户端连接。&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待客户端的连接请求</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            TcpClient client = listener.AcceptTcpClient();</span><br><span class="line">            ConsoleLogger.Info(<span class="string">$&quot;客户端连接成功：<span class="subst">&#123;client.Client.RemoteEndPoint.ToString()&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 建立与客户端的数据流</span></span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">using</span> NetworkStream stream = client.GetStream();</span><br><span class="line">                <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];<span class="comment">//设置缓存长度</span></span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> length = stream.Read(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line">                        <span class="keyword">if</span> (length &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConsoleLogger.Info(<span class="string">$&quot;[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]接收到数据: <span class="subst">&#123;Console.InputEncoding.GetString(buffer, <span class="number">0</span>, length)&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 回发接收到的消息给客户端</span></span><br><span class="line">                            client.Client.Send(buffer, <span class="number">0</span>, length, SocketFlags.None);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            ConsoleLogger.Info(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]关闭&quot;</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (Exception exc)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ConsoleLogger.Error(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]引发未处理异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception exc)</span><br><span class="line">    &#123;</span><br><span class="line">        ConsoleLogger.Error(<span class="string">$&quot;TCP服务端测试出现了未经处理的异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ConsoleLogger.Info(<span class="string">&quot;测试结束&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver7_1562747097800.png" alt="tcpserver7"></p>
<h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><p>递归本质上和循环类似，其利用的是异步等待TCP客户端连接方法<code>BeginAcceptTcpClient</code>的回调。</p>
<p>我们可以在回调中，使用<code>EndAcceptTcpClient</code>来异步的接受传入的连接，并创建客户端实例。而创建成功后，我们可以继续调用回调函数，来异步的接收下一个客户端的连接请求。</p>
<p>下面例子将回调函数写为匿名函数，实际开发中也可以使用普通函数：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 服务端地址默认本地</span></span><br><span class="line">    IPAddress address = IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    <span class="comment">// 提醒用户输入要监听的端口</span></span><br><span class="line">    Console.Write(<span class="string">&quot;请输入您要监听的端口：&quot;</span>);</span><br><span class="line">    <span class="built_in">string</span> input = Console.ReadLine();</span><br><span class="line">    <span class="built_in">int</span> port;</span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">int</span>.TryParse(input, <span class="keyword">out</span> port))</span><br><span class="line">    &#123;</span><br><span class="line">        Console.Write(<span class="string">&quot;您输入的端口错误，请重新输入：&quot;</span>);</span><br><span class="line">        input = Console.ReadLine();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建并打开监听</span></span><br><span class="line">        TcpListener listener = <span class="keyword">new</span> TcpListener(address, port);</span><br><span class="line">        listener.Start();</span><br><span class="line"></span><br><span class="line">        ConsoleLogger.Info(<span class="string">$&quot;启用服务端 <span class="subst">&#123;listener.Server.LocalEndPoint&#125;</span> 成功，等待客户端连接。&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步等待客户端的连接请求的回调</span></span><br><span class="line">        AsyncCallback callback = <span class="literal">null</span>;</span><br><span class="line">        callback = <span class="keyword">new</span> AsyncCallback((asyncResult) =&gt; </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 因为没有使用函数而是使用匿名方法 这里也可以直接用可以访问到的局部变量listener</span></span><br><span class="line">            <span class="keyword">if</span> (asyncResult.AsyncState <span class="keyword">is</span> TcpListener tcpListener)</span><br><span class="line">            &#123;</span><br><span class="line">                TcpClient client = tcpListener.EndAcceptTcpClient(asyncResult);</span><br><span class="line">                ConsoleLogger.Info(<span class="string">$&quot;客户端连接成功：<span class="subst">&#123;client.Client.RemoteEndPoint.ToString()&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 建立与客户端的数据流</span></span><br><span class="line">                Task.Factory.StartNew(() =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> NetworkStream stream = client.GetStream();</span><br><span class="line">                    <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];<span class="comment">//设置缓存长度</span></span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">try</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">int</span> length = stream.Read(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line">                            <span class="keyword">if</span> (length &gt; <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                ConsoleLogger.Info(<span class="string">$&quot;[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]接收到数据: <span class="subst">&#123;Console.InputEncoding.GetString(buffer, <span class="number">0</span>, length)&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 回发接收到的消息给客户端</span></span><br><span class="line">                                client.Client.Send(buffer, <span class="number">0</span>, length, SocketFlags.None);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                ConsoleLogger.Info(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]关闭&quot;</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        catch (Exception exc)</span><br><span class="line">                        &#123;</span><br><span class="line">                            ConsoleLogger.Error(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]引发未处理异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                tcpListener.BeginAcceptTcpClient(callback, tcpListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步等待客户端的连接请求</span></span><br><span class="line">        listener.BeginAcceptTcpClient(callback, listener);</span><br><span class="line"></span><br><span class="line">        Console.ReadKey();<span class="comment">//避免控制台退出</span></span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception exc)</span><br><span class="line">    &#123;</span><br><span class="line">        ConsoleLogger.Error(<span class="string">$&quot;TCP服务端测试出现了未经处理的异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ConsoleLogger.Info(<span class="string">&quot;测试结束&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver8_1562747097819.png" alt="tcpserver8"></p>
<p>由上图可以看出两者差别并不大，主要的区别在于循环是一个同步方法，而递归使用的是异步方法。</p>
<h2 id="向指定客户端发送消息"><a href="#向指定客户端发送消息" class="headerlink" title="向指定客户端发送消息"></a>向指定客户端发送消息</h2><p>控制台中如果控制向客户端发送消息，肯定要允许我们输入，来客户端并可以输入需要发送的消息。</p>
<p>所以这里我们需要将等待客户端连接请求与提示输入放在两个线程中进行，这里我们直接使用多客户端中“递归”的例子进行改造（当然也可以使用循环的例子，开启一个线程将循环放到另外一个线程中执行）。</p>
<p>因为我们的测试方法是静态方法，所以首先我们需要定义一个静态集合变量来存储连接的客户端。</p>
<p>客户端连接成功后，我们需要将客户端存储到集合中，方便我们遍历，当客户端断开连接后，我们需要将客户端从该集合中移除。因为涉及到多线程，这里建议使用线程安全的集合，或者在操作集合的位置加锁。</p>
<p>调整后代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Concurrent;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SocketTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            TcpServerTest.Test();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TcpServerTest</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">object</span> sync = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">List</span>&lt;<span class="title">TcpClient</span>&gt; clients</span> = <span class="keyword">new</span> List&lt;TcpClient&gt;();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 服务端地址默认本地</span></span><br><span class="line">            IPAddress address = IPAddress.Parse(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">            <span class="comment">// 提醒用户输入要监听的端口</span></span><br><span class="line">            Console.Write(<span class="string">&quot;请输入您要监听的端口：&quot;</span>);</span><br><span class="line">            <span class="built_in">string</span> input = Console.ReadLine();</span><br><span class="line">            <span class="built_in">int</span> port;</span><br><span class="line">            <span class="keyword">while</span> (!<span class="built_in">int</span>.TryParse(input, <span class="keyword">out</span> port))</span><br><span class="line">            &#123;</span><br><span class="line">                Console.Write(<span class="string">&quot;您输入的端口错误，请重新输入：&quot;</span>);</span><br><span class="line">                input = Console.ReadLine();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 创建并打开监听</span></span><br><span class="line">                TcpListener listener = <span class="keyword">new</span> TcpListener(address, port);</span><br><span class="line">                listener.Start();</span><br><span class="line"></span><br><span class="line">                ConsoleLogger.Info(<span class="string">$&quot;启用服务端 <span class="subst">&#123;listener.Server.LocalEndPoint&#125;</span> 成功，等待客户端连接。&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 异步等待客户端的连接请求的回调</span></span><br><span class="line">                AsyncCallback callback = <span class="literal">null</span>;</span><br><span class="line">                callback = <span class="keyword">new</span> AsyncCallback((asyncResult) =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 因为没有使用函数而是使用匿名方法 这里也可以直接用可以访问到的局部变量listener</span></span><br><span class="line">                    <span class="keyword">if</span> (asyncResult.AsyncState <span class="keyword">is</span> TcpListener tcpListener)</span><br><span class="line">                    &#123;</span><br><span class="line">                        TcpClient client = tcpListener.EndAcceptTcpClient(asyncResult);</span><br><span class="line">                        <span class="keyword">lock</span> (sync)</span><br><span class="line">                        &#123;</span><br><span class="line">                            clients.Add(client);</span><br><span class="line">                        &#125;</span><br><span class="line">                        ConsoleLogger.Info(<span class="string">$&quot;客户端连接成功：<span class="subst">&#123;client.Client.RemoteEndPoint.ToString()&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 建立与客户端的数据流</span></span><br><span class="line">                        Task.Factory.StartNew(() =&gt;</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">using</span> NetworkStream stream = client.GetStream();</span><br><span class="line">                            <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];<span class="comment">//设置缓存长度</span></span><br><span class="line">                            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">try</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="built_in">int</span> length = stream.Read(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line">                                    <span class="keyword">if</span> (length &gt; <span class="number">0</span>)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        ConsoleLogger.Receive(<span class="string">$&quot;[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]接收到数据: <span class="subst">&#123;Console.InputEncoding.GetString(buffer, <span class="number">0</span>, length)&#125;</span>&quot;</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        ConsoleLogger.Info(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]关闭&quot;</span>);</span><br><span class="line">                                        <span class="keyword">lock</span> (sync)</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="keyword">if</span> (clients.Contains(client))</span><br><span class="line">                                            &#123;</span><br><span class="line">                                                clients.Remove(client);</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                catch (Exception exc)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    ConsoleLogger.Error(<span class="string">$&quot;客户端[<span class="subst">&#123;client.Client.RemoteEndPoint&#125;</span>]引发未处理异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                                    <span class="keyword">lock</span> (sync)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (clients.Contains(client))</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            clients.Remove(client);</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line">                        tcpListener.BeginAcceptTcpClient(callback, tcpListener);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 异步等待客户端的连接请求</span></span><br><span class="line">                listener.BeginAcceptTcpClient(callback, listener);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ConsoleLogger.Prompt(<span class="string">&quot;请输入选择你要执行的操作：\r\nall:查看所有客户端列表\r\nall &#123;message&#125;:向所有客户端发送消息\r\nClientNo &#123;message&#125;:向指定客户端发送消息&quot;</span>);</span><br><span class="line">                    input = Console.ReadLine();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">string</span>.Equals(input, <span class="string">&quot;all&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">lock</span> (sync)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clients.Count == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                ConsoleLogger.Error(<span class="string">$&quot;当前还未与客户端建立连接。&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                ConsoleLogger.Info(<span class="string">$&quot;当前共有<span class="subst">&#123;clients.Count&#125;</span>个客户端连接：&quot;</span>);</span><br><span class="line">                                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; clients.Count; i++)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    ConsoleLogger.Info(<span class="string">$&quot;Client No <span class="subst">&#123;i&#125;</span>：<span class="subst">&#123;clients[i].Client.RemoteEndPoint&#125;</span>&quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (Regex.IsMatch(input, <span class="string">&quot;^all (.+)$&quot;</span>, RegexOptions.IgnoreCase))</span><br><span class="line">                    &#123;</span><br><span class="line">                        Match match = Regex.Match(input, <span class="string">&quot;^all (.+)$&quot;</span>, RegexOptions.IgnoreCase);</span><br><span class="line">                        <span class="built_in">string</span> message = match.Groups[<span class="number">1</span>].Value;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">lock</span> (sync)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clients.Count == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                ConsoleLogger.Error(<span class="string">$&quot;当前还未与客户端建立连接。&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; clients.Count; i++)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">try</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        ConsoleLogger.Send(<span class="string">$&quot;向客户端[<span class="subst">&#123;clients[i].Client.RemoteEndPoint&#125;</span>]发送消息：<span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                                        clients[i].Client.Send(Console.InputEncoding.GetBytes(message));</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    catch (Exception exc)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        ConsoleLogger.Error(<span class="string">$&quot;向客户端[<span class="subst">&#123;clients[i].Client.RemoteEndPoint&#125;</span>]发送消息失败：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (Regex.IsMatch(input, <span class="string">&quot;^(\\d&#123;1,7&#125;) (.+)$&quot;</span>, RegexOptions.IgnoreCase))</span><br><span class="line">                    &#123;</span><br><span class="line">                        Match match = Regex.Match(input, <span class="string">&quot;^(\\d&#123;1,7&#125;) (.+)$&quot;</span>, RegexOptions.IgnoreCase);</span><br><span class="line">                        <span class="built_in">int</span> clientIndex = <span class="built_in">int</span>.Parse(match.Groups[<span class="number">1</span>].Value);</span><br><span class="line">                        <span class="built_in">string</span> message = match.Groups[<span class="number">2</span>].Value;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">lock</span> (sync)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clients.Count == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                ConsoleLogger.Error(<span class="string">$&quot;当前还未与客户端建立连接。&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">if</span> (clients.Count &gt; clientIndex)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">try</span></span><br><span class="line">                                    &#123;</span><br><span class="line">                                        ConsoleLogger.Send(<span class="string">$&quot;向客户端[<span class="subst">&#123;clients[clientIndex].Client.RemoteEndPoint&#125;</span>]发送消息：<span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                                        clients[clientIndex].Client.Send(Console.InputEncoding.GetBytes(message));</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    catch (Exception exc)</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        ConsoleLogger.Error(<span class="string">$&quot;向客户端[<span class="subst">&#123;clients[clientIndex].Client.RemoteEndPoint&#125;</span>]发送消息失败：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                    ConsoleLogger.Error(<span class="string">$&quot;该索引对应的客户端不存在，可能已经被断开连接。&quot;</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        ConsoleLogger.Error(<span class="string">$&quot;内容输入错误，请按照要求重新输入你要进行的操作。&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception exc)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleLogger.Error(<span class="string">$&quot;TCP服务端测试出现了未经处理的异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ConsoleLogger.Info(<span class="string">&quot;测试结束&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ConsoleLogger</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">object</span> sync = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Send</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.Black;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.Yellow;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>  Info: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Receive</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.Black;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.Gray;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>  Info: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Prompt</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.Black;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.Green;</span><br><span class="line">                Console.WriteLine(message);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Error</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.Black;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.Red;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span> Error: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Info</span>(<span class="params"><span class="built_in">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (sync)</span><br><span class="line">            &#123;</span><br><span class="line">                ConsoleColor backgroundColor = Console.BackgroundColor;</span><br><span class="line">                ConsoleColor foregroundColor = Console.ForegroundColor;</span><br><span class="line">                Console.BackgroundColor = ConsoleColor.Black;</span><br><span class="line">                Console.ForegroundColor = ConsoleColor.White;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>  Info: <span class="subst">&#123;message&#125;</span>&quot;</span>);</span><br><span class="line">                Console.BackgroundColor = backgroundColor;</span><br><span class="line">                Console.ForegroundColor = foregroundColor;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/tcpserver9_1562747097836.png" alt="tcpserver9"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/server-of-tcp-protocol/" data-id="cklc4t81l00d8zuqm1mz1ghp0" data-title="TCP协议之服务端" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TCP/" rel="tag">TCP</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190528-encoding-in-communication" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/encoding-in-communication/" class="article-date">
  <time class="dt-published" datetime="2019-05-28T00:21:00.000Z" itemprop="datePublished">2019-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/encoding-in-communication/">通讯中的编码问题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="通讯中的编码问题"><a href="#通讯中的编码问题" class="headerlink" title="通讯中的编码问题"></a>通讯中的编码问题</h2><p>这里的LIS接口通讯主要指的是串口(RS232)/网口(TCP或UDP)通讯，而串口或网口通讯中，我们经常会遇到乱码或结果解析错误的问题，那么我们应该怎样做才能避免这些问题呢？</p>
<p>首先我们要知道，想要开发接口特别是双工接口，首先要能读懂接口的通讯文档，而通讯文档中经常会有所使用通讯协议的介绍，流入ASTM、HL7。</p>
<p>而通讯协议一般都制定了编码字符集，比如<code>ASCII</code>、<code>UTF-8</code>、<code>GBK</code>等，虽然字符编码的概念是基础，我们都能理解，但是也不能确保顺利的开发出接口，我们还需要了解HEX、控制字符、校验等。</p>
<h3 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h3><p>首先，字符编码(Character encoding)也称字集码，是把字符集中的字符编码为指定集合中某一对象(例如：比特模式、自然数序列、8位组或者电脉冲)，以便文本在计算机中存储和通过通信网络的传递。</p>
<p>常见的例子包括将拉丁字母表编码成摩斯电码和ASCII。其中，ASCII将字母、数字和其它符号编号，并用7比特的二进制来表示这个整数。通常会额外使用一个扩充的比特，以便于以1个字节的方式存储。</p>
<p>ASCII码使用指定的7位或8位二进制数组合来表示128或256种可能的字符，包括大小写字母、数字0-9、标点符号、非打印字符（换行符、制表符等4个）以及控制字符（退格、响铃等）组成。</p>
<p>但是，由于它是针对英语设计的，当处理带有音调标号（形如汉语的拼音）的亚洲文字时就会出现问题。</p>
<p>所以实际我们在通讯过程中会遇到另外几种支持更多字符的编码，例如<code>UTF-8</code>和<code>GBK</code>(或<code>GB2312</code>，<code>GB2312</code>是<code>GBK</code>的子集)。</p>
<h3 id="控制字符"><a href="#控制字符" class="headerlink" title="控制字符"></a>控制字符</h3><p>ASCII编码中0～31及127(共33个)是控制字符或通信专用字符（其余为可显示字符），如控制符：LF（换行）、CR（回车）、FF（换页）、DEL（删除）、BS（退格)、BEL（响铃）等；通信专用字符：SOH（文头）、EOT（文尾）、ACK（确认）等；ASCII值为8、9、10和13分别转换为退格、制表、换行和回车字符。它们并没有特定的图形显示，但会依不同的应用程序，而对文本显示有不同的影响。</p>
<p>ASCII编码标准表：</p>
<table>
<thead>
<tr>
<th align="center">Bin<br>(二进制)</th>
<th align="center">Oct<br>(八进制)</th>
<th align="center">Dec<br>(十进制)</th>
<th align="center">Hex<br>(十六进制)</th>
<th align="center">缩写/字符</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0000 0000</td>
<td align="center">00</td>
<td align="center">0</td>
<td align="center">0x00</td>
<td align="center">NUL(null)</td>
<td align="center">空字符</td>
</tr>
<tr>
<td align="center">0000 0001</td>
<td align="center">01</td>
<td align="center">1</td>
<td align="center">0x01</td>
<td align="center">SOH(start of headline)</td>
<td align="center">标题开始</td>
</tr>
<tr>
<td align="center">0000 0010</td>
<td align="center">02</td>
<td align="center">2</td>
<td align="center">0x02</td>
<td align="center">STX (start of text)</td>
<td align="center">正文开始</td>
</tr>
<tr>
<td align="center">0000 0011</td>
<td align="center">03</td>
<td align="center">3</td>
<td align="center">0x03</td>
<td align="center">ETX (end of text)</td>
<td align="center">正文结束</td>
</tr>
<tr>
<td align="center">0000 0100</td>
<td align="center">04</td>
<td align="center">4</td>
<td align="center">0x04</td>
<td align="center">EOT (end of transmission)</td>
<td align="center">传输结束</td>
</tr>
<tr>
<td align="center">0000 0101</td>
<td align="center">05</td>
<td align="center">5</td>
<td align="center">0x05</td>
<td align="center">ENQ (enquiry)</td>
<td align="center">请求</td>
</tr>
<tr>
<td align="center">0000 0110</td>
<td align="center">06</td>
<td align="center">6</td>
<td align="center">0x06</td>
<td align="center">ACK (acknowledge)</td>
<td align="center">收到通知</td>
</tr>
<tr>
<td align="center">0000 0111</td>
<td align="center">07</td>
<td align="center">7</td>
<td align="center">0x07</td>
<td align="center">BEL (bell)</td>
<td align="center">响铃</td>
</tr>
<tr>
<td align="center">0000 1000</td>
<td align="center">010</td>
<td align="center">8</td>
<td align="center">0x08</td>
<td align="center">BS (backspace)</td>
<td align="center">退格</td>
</tr>
<tr>
<td align="center">0000 1001</td>
<td align="center">011</td>
<td align="center">9</td>
<td align="center">0x09</td>
<td align="center">HT (horizontal tab)</td>
<td align="center">水平制表符</td>
</tr>
<tr>
<td align="center">0000 1010</td>
<td align="center">012</td>
<td align="center">10</td>
<td align="center">0x0A</td>
<td align="center">LF (NL line feed, new line)</td>
<td align="center">换行键</td>
</tr>
<tr>
<td align="center">0000 1011</td>
<td align="center">013</td>
<td align="center">11</td>
<td align="center">0x0B</td>
<td align="center">VT (vertical tab)</td>
<td align="center">垂直制表符</td>
</tr>
<tr>
<td align="center">0000 1100</td>
<td align="center">014</td>
<td align="center">12</td>
<td align="center">0x0C</td>
<td align="center">FF (NP form feed, new page)</td>
<td align="center">换页键</td>
</tr>
<tr>
<td align="center">0000 1101</td>
<td align="center">015</td>
<td align="center">13</td>
<td align="center">0x0D</td>
<td align="center">CR (carriage return)</td>
<td align="center">回车键</td>
</tr>
<tr>
<td align="center">0000 1110</td>
<td align="center">016</td>
<td align="center">14</td>
<td align="center">0x0E</td>
<td align="center">SO (shift out)</td>
<td align="center">不用切换</td>
</tr>
<tr>
<td align="center">0000 1111</td>
<td align="center">017</td>
<td align="center">15</td>
<td align="center">0x0F</td>
<td align="center">SI (shift in)</td>
<td align="center">启用切换</td>
</tr>
<tr>
<td align="center">0001 0000</td>
<td align="center">020</td>
<td align="center">16</td>
<td align="center">0x10</td>
<td align="center">DLE (data link escape)</td>
<td align="center">数据链路转义</td>
</tr>
<tr>
<td align="center">0001 0001</td>
<td align="center">021</td>
<td align="center">17</td>
<td align="center">0x11</td>
<td align="center">DC1 (device control 1)</td>
<td align="center">设备控制1</td>
</tr>
<tr>
<td align="center">0001 0010</td>
<td align="center">022</td>
<td align="center">18</td>
<td align="center">0x12</td>
<td align="center">DC2 (device control 2)</td>
<td align="center">设备控制2</td>
</tr>
<tr>
<td align="center">0001 0011</td>
<td align="center">023</td>
<td align="center">19</td>
<td align="center">0x13</td>
<td align="center">DC3 (device control 3)</td>
<td align="center">设备控制3</td>
</tr>
<tr>
<td align="center">0001 0100</td>
<td align="center">024</td>
<td align="center">20</td>
<td align="center">0x14</td>
<td align="center">DC4 (device control 4)</td>
<td align="center">设备控制4</td>
</tr>
<tr>
<td align="center">0001 0101</td>
<td align="center">025</td>
<td align="center">21</td>
<td align="center">0x15</td>
<td align="center">NAK (negative acknowledge)</td>
<td align="center">拒绝接收</td>
</tr>
<tr>
<td align="center">0001 0110</td>
<td align="center">026</td>
<td align="center">22</td>
<td align="center">0x16</td>
<td align="center">SYN (synchronous idle)</td>
<td align="center">同步空闲</td>
</tr>
<tr>
<td align="center">0001 0111</td>
<td align="center">027</td>
<td align="center">23</td>
<td align="center">0x17</td>
<td align="center">ETB (end of trans. block)</td>
<td align="center">结束传输块</td>
</tr>
<tr>
<td align="center">0001 1000</td>
<td align="center">030</td>
<td align="center">24</td>
<td align="center">0x18</td>
<td align="center">CAN (cancel)</td>
<td align="center">取消</td>
</tr>
<tr>
<td align="center">0001 1001</td>
<td align="center">031</td>
<td align="center">25</td>
<td align="center">0x19</td>
<td align="center">EM (end of medium)</td>
<td align="center">媒介结束</td>
</tr>
<tr>
<td align="center">0001 1010</td>
<td align="center">032</td>
<td align="center">26</td>
<td align="center">0x1A</td>
<td align="center">SUB (substitute)</td>
<td align="center">代替</td>
</tr>
<tr>
<td align="center">0001 1011</td>
<td align="center">033</td>
<td align="center">27</td>
<td align="center">0x1B</td>
<td align="center">ESC (escape)</td>
<td align="center">换码(溢出)</td>
</tr>
<tr>
<td align="center">0001 1100</td>
<td align="center">034</td>
<td align="center">28</td>
<td align="center">0x1C</td>
<td align="center">FS (file separator)</td>
<td align="center">文件分隔符</td>
</tr>
<tr>
<td align="center">0001 1101</td>
<td align="center">035</td>
<td align="center">29</td>
<td align="center">0x1D</td>
<td align="center">GS (group separator)</td>
<td align="center">分组符</td>
</tr>
<tr>
<td align="center">0001 1110</td>
<td align="center">036</td>
<td align="center">30</td>
<td align="center">0x1E</td>
<td align="center">RS (record separator)</td>
<td align="center">记录分隔符</td>
</tr>
<tr>
<td align="center">0001 1111</td>
<td align="center">037</td>
<td align="center">31</td>
<td align="center">0x1F</td>
<td align="center">US (unit separator)</td>
<td align="center">单元分隔符</td>
</tr>
<tr>
<td align="center">0010 0000</td>
<td align="center">040</td>
<td align="center">32</td>
<td align="center">0x20</td>
<td align="center">(space)</td>
<td align="center">空格</td>
</tr>
<tr>
<td align="center">0010 0001</td>
<td align="center">041</td>
<td align="center">33</td>
<td align="center">0x21</td>
<td align="center">!</td>
<td align="center">叹号</td>
</tr>
<tr>
<td align="center">0010 0010</td>
<td align="center">042</td>
<td align="center">34</td>
<td align="center">0x22</td>
<td align="center">“</td>
<td align="center">双引号</td>
</tr>
<tr>
<td align="center">0010 0011</td>
<td align="center">043</td>
<td align="center">35</td>
<td align="center">0x23</td>
<td align="center">#</td>
<td align="center">井号</td>
</tr>
<tr>
<td align="center">0010 0100</td>
<td align="center">044</td>
<td align="center">36</td>
<td align="center">0x24</td>
<td align="center">$</td>
<td align="center">美元符</td>
</tr>
<tr>
<td align="center">0010 0101</td>
<td align="center">045</td>
<td align="center">37</td>
<td align="center">0x25</td>
<td align="center">%</td>
<td align="center">百分号</td>
</tr>
<tr>
<td align="center">0010 0110</td>
<td align="center">046</td>
<td align="center">38</td>
<td align="center">0x26</td>
<td align="center">&amp;</td>
<td align="center">和号</td>
</tr>
<tr>
<td align="center">0010 0111</td>
<td align="center">047</td>
<td align="center">39</td>
<td align="center">0x27</td>
<td align="center">‘</td>
<td align="center">闭单引号</td>
</tr>
<tr>
<td align="center">0010 1000</td>
<td align="center">050</td>
<td align="center">40</td>
<td align="center">0x28</td>
<td align="center">(</td>
<td align="center">开括号</td>
</tr>
<tr>
<td align="center">0010 1001</td>
<td align="center">051</td>
<td align="center">41</td>
<td align="center">0x29</td>
<td align="center">)</td>
<td align="center">闭括号</td>
</tr>
<tr>
<td align="center">0010 1010</td>
<td align="center">052</td>
<td align="center">42</td>
<td align="center">0x2A</td>
<td align="center">*</td>
<td align="center">星号</td>
</tr>
<tr>
<td align="center">0010 1011</td>
<td align="center">053</td>
<td align="center">43</td>
<td align="center">0x2B</td>
<td align="center">+</td>
<td align="center">加号</td>
</tr>
<tr>
<td align="center">0010 1100</td>
<td align="center">054</td>
<td align="center">44</td>
<td align="center">0x2C</td>
<td align="center">,</td>
<td align="center">逗号</td>
</tr>
<tr>
<td align="center">0010 1101</td>
<td align="center">055</td>
<td align="center">45</td>
<td align="center">0x2D</td>
<td align="center">-</td>
<td align="center">减号/破折号</td>
</tr>
<tr>
<td align="center">0010 1110</td>
<td align="center">056</td>
<td align="center">46</td>
<td align="center">0x2E</td>
<td align="center">.</td>
<td align="center">句号</td>
</tr>
<tr>
<td align="center">0010 1111</td>
<td align="center">057</td>
<td align="center">47</td>
<td align="center">0x2F</td>
<td align="center">/</td>
<td align="center">斜杠</td>
</tr>
<tr>
<td align="center">0011 0000</td>
<td align="center">060</td>
<td align="center">48</td>
<td align="center">0x30</td>
<td align="center">0</td>
<td align="center">字符0</td>
</tr>
<tr>
<td align="center">0011 0001</td>
<td align="center">061</td>
<td align="center">49</td>
<td align="center">0x31</td>
<td align="center">1</td>
<td align="center">字符1</td>
</tr>
<tr>
<td align="center">0011 0010</td>
<td align="center">062</td>
<td align="center">50</td>
<td align="center">0x32</td>
<td align="center">2</td>
<td align="center">字符2</td>
</tr>
<tr>
<td align="center">0011 0011</td>
<td align="center">063</td>
<td align="center">51</td>
<td align="center">0x33</td>
<td align="center">3</td>
<td align="center">字符3</td>
</tr>
<tr>
<td align="center">0011 0100</td>
<td align="center">064</td>
<td align="center">52</td>
<td align="center">0x34</td>
<td align="center">4</td>
<td align="center">字符4</td>
</tr>
<tr>
<td align="center">0011 0101</td>
<td align="center">065</td>
<td align="center">53</td>
<td align="center">0x35</td>
<td align="center">5</td>
<td align="center">字符5</td>
</tr>
<tr>
<td align="center">0011 0110</td>
<td align="center">066</td>
<td align="center">54</td>
<td align="center">0x36</td>
<td align="center">6</td>
<td align="center">字符6</td>
</tr>
<tr>
<td align="center">0011 0111</td>
<td align="center">067</td>
<td align="center">55</td>
<td align="center">0x37</td>
<td align="center">7</td>
<td align="center">字符7</td>
</tr>
<tr>
<td align="center">0011 1000</td>
<td align="center">070</td>
<td align="center">56</td>
<td align="center">0x38</td>
<td align="center">8</td>
<td align="center">字符8</td>
</tr>
<tr>
<td align="center">0011 1001</td>
<td align="center">071</td>
<td align="center">57</td>
<td align="center">0x39</td>
<td align="center">9</td>
<td align="center">字符9</td>
</tr>
<tr>
<td align="center">0011 1010</td>
<td align="center">072</td>
<td align="center">58</td>
<td align="center">0x3A</td>
<td align="center">:</td>
<td align="center">冒号</td>
</tr>
<tr>
<td align="center">0011 1011</td>
<td align="center">073</td>
<td align="center">59</td>
<td align="center">0x3B</td>
<td align="center">;</td>
<td align="center">分号</td>
</tr>
<tr>
<td align="center">0011 1100</td>
<td align="center">074</td>
<td align="center">60</td>
<td align="center">0x3C</td>
<td align="center">&lt;</td>
<td align="center">小于</td>
</tr>
<tr>
<td align="center">0011 1101</td>
<td align="center">075</td>
<td align="center">61</td>
<td align="center">0x3D</td>
<td align="center">=</td>
<td align="center">等号</td>
</tr>
<tr>
<td align="center">0011 1110</td>
<td align="center">076</td>
<td align="center">62</td>
<td align="center">0x3E</td>
<td align="center">&gt;</td>
<td align="center">大于</td>
</tr>
<tr>
<td align="center">0011 1111</td>
<td align="center">077</td>
<td align="center">63</td>
<td align="center">0x3F</td>
<td align="center">?</td>
<td align="center">问号</td>
</tr>
<tr>
<td align="center">0100 0000</td>
<td align="center">0100</td>
<td align="center">64</td>
<td align="center">0x40</td>
<td align="center">@</td>
<td align="center">电子邮件符号</td>
</tr>
<tr>
<td align="center">0100 0001</td>
<td align="center">0101</td>
<td align="center">65</td>
<td align="center">0x41</td>
<td align="center">A</td>
<td align="center">大写字母A</td>
</tr>
<tr>
<td align="center">0100 0010</td>
<td align="center">0102</td>
<td align="center">66</td>
<td align="center">0x42</td>
<td align="center">B</td>
<td align="center">大写字母B</td>
</tr>
<tr>
<td align="center">0100 0011</td>
<td align="center">0103</td>
<td align="center">67</td>
<td align="center">0x43</td>
<td align="center">C</td>
<td align="center">大写字母C</td>
</tr>
<tr>
<td align="center">0100 0100</td>
<td align="center">0104</td>
<td align="center">68</td>
<td align="center">0x44</td>
<td align="center">D</td>
<td align="center">大写字母D</td>
</tr>
<tr>
<td align="center">0100 0101</td>
<td align="center">0105</td>
<td align="center">69</td>
<td align="center">0x45</td>
<td align="center">E</td>
<td align="center">大写字母E</td>
</tr>
<tr>
<td align="center">0100 0110</td>
<td align="center">0106</td>
<td align="center">70</td>
<td align="center">0x46</td>
<td align="center">F</td>
<td align="center">大写字母F</td>
</tr>
<tr>
<td align="center">0100 0111</td>
<td align="center">0107</td>
<td align="center">71</td>
<td align="center">0x47</td>
<td align="center">G</td>
<td align="center">大写字母G</td>
</tr>
<tr>
<td align="center">0100 1000</td>
<td align="center">0110</td>
<td align="center">72</td>
<td align="center">0x48</td>
<td align="center">H</td>
<td align="center">大写字母H</td>
</tr>
<tr>
<td align="center">0100 1001</td>
<td align="center">0111</td>
<td align="center">73</td>
<td align="center">0x49</td>
<td align="center">I</td>
<td align="center">大写字母I</td>
</tr>
<tr>
<td align="center">0100 1010</td>
<td align="center">0112</td>
<td align="center">74</td>
<td align="center">0x4A</td>
<td align="center">J</td>
<td align="center">大写字母J</td>
</tr>
<tr>
<td align="center">0100 1011</td>
<td align="center">0113</td>
<td align="center">75</td>
<td align="center">0x4B</td>
<td align="center">K</td>
<td align="center">大写字母K</td>
</tr>
<tr>
<td align="center">0100 1100</td>
<td align="center">0114</td>
<td align="center">76</td>
<td align="center">0x4C</td>
<td align="center">L</td>
<td align="center">大写字母L</td>
</tr>
<tr>
<td align="center">0100 1101</td>
<td align="center">0115</td>
<td align="center">77</td>
<td align="center">0x4D</td>
<td align="center">M</td>
<td align="center">大写字母M</td>
</tr>
<tr>
<td align="center">0100 1110</td>
<td align="center">0116</td>
<td align="center">78</td>
<td align="center">0x4E</td>
<td align="center">N</td>
<td align="center">大写字母N</td>
</tr>
<tr>
<td align="center">0100 1111</td>
<td align="center">0117</td>
<td align="center">79</td>
<td align="center">0x4F</td>
<td align="center">O</td>
<td align="center">大写字母O</td>
</tr>
<tr>
<td align="center">0101 0000</td>
<td align="center">0120</td>
<td align="center">80</td>
<td align="center">0x50</td>
<td align="center">P</td>
<td align="center">大写字母P</td>
</tr>
<tr>
<td align="center">0101 0001</td>
<td align="center">0121</td>
<td align="center">81</td>
<td align="center">0x51</td>
<td align="center">Q</td>
<td align="center">大写字母Q</td>
</tr>
<tr>
<td align="center">0101 0010</td>
<td align="center">0122</td>
<td align="center">82</td>
<td align="center">0x52</td>
<td align="center">R</td>
<td align="center">大写字母R</td>
</tr>
<tr>
<td align="center">0101 0011</td>
<td align="center">0123</td>
<td align="center">83</td>
<td align="center">0x53</td>
<td align="center">S</td>
<td align="center">大写字母S</td>
</tr>
<tr>
<td align="center">0101 0100</td>
<td align="center">0124</td>
<td align="center">84</td>
<td align="center">0x54</td>
<td align="center">T</td>
<td align="center">大写字母T</td>
</tr>
<tr>
<td align="center">0101 0101</td>
<td align="center">0125</td>
<td align="center">85</td>
<td align="center">0x55</td>
<td align="center">U</td>
<td align="center">大写字母U</td>
</tr>
<tr>
<td align="center">0101 0110</td>
<td align="center">0126</td>
<td align="center">86</td>
<td align="center">0x56</td>
<td align="center">V</td>
<td align="center">大写字母V</td>
</tr>
<tr>
<td align="center">0101 0111</td>
<td align="center">0127</td>
<td align="center">87</td>
<td align="center">0x57</td>
<td align="center">W</td>
<td align="center">大写字母W</td>
</tr>
<tr>
<td align="center">0101 1000</td>
<td align="center">0130</td>
<td align="center">88</td>
<td align="center">0x58</td>
<td align="center">X</td>
<td align="center">大写字母X</td>
</tr>
<tr>
<td align="center">0101 1001</td>
<td align="center">0131</td>
<td align="center">89</td>
<td align="center">0x59</td>
<td align="center">Y</td>
<td align="center">大写字母Y</td>
</tr>
<tr>
<td align="center">0101 1010</td>
<td align="center">0132</td>
<td align="center">90</td>
<td align="center">0x5A</td>
<td align="center">Z</td>
<td align="center">大写字母Z</td>
</tr>
<tr>
<td align="center">0101 1011</td>
<td align="center">0133</td>
<td align="center">91</td>
<td align="center">0x5B</td>
<td align="center">[</td>
<td align="center">开方括号</td>
</tr>
<tr>
<td align="center">0101 1100</td>
<td align="center">0134</td>
<td align="center">92</td>
<td align="center">0x5C</td>
<td align="center">\</td>
<td align="center">反斜杠</td>
</tr>
<tr>
<td align="center">0101 1101</td>
<td align="center">0135</td>
<td align="center">93</td>
<td align="center">0x5D</td>
<td align="center">]</td>
<td align="center">闭方括号</td>
</tr>
<tr>
<td align="center">0101 1110</td>
<td align="center">0136</td>
<td align="center">94</td>
<td align="center">0x5E</td>
<td align="center">^</td>
<td align="center">脱字符</td>
</tr>
<tr>
<td align="center">0101 1111</td>
<td align="center">0137</td>
<td align="center">95</td>
<td align="center">0x5F</td>
<td align="center">_</td>
<td align="center">下划线</td>
</tr>
<tr>
<td align="center">0110 0000</td>
<td align="center">0140</td>
<td align="center">96</td>
<td align="center">0x60</td>
<td align="center">`</td>
<td align="center">开单引号</td>
</tr>
<tr>
<td align="center">0110 0001</td>
<td align="center">0141</td>
<td align="center">97</td>
<td align="center">0x61</td>
<td align="center">a</td>
<td align="center">小写字母a</td>
</tr>
<tr>
<td align="center">0110 0010</td>
<td align="center">0142</td>
<td align="center">98</td>
<td align="center">0x62</td>
<td align="center">b</td>
<td align="center">小写字母b</td>
</tr>
<tr>
<td align="center">0110 0011</td>
<td align="center">0143</td>
<td align="center">99</td>
<td align="center">0x63</td>
<td align="center">c</td>
<td align="center">小写字母c</td>
</tr>
<tr>
<td align="center">0110 0100</td>
<td align="center">0144</td>
<td align="center">100</td>
<td align="center">0x64</td>
<td align="center">d</td>
<td align="center">小写字母d</td>
</tr>
<tr>
<td align="center">0110 0101</td>
<td align="center">0145</td>
<td align="center">101</td>
<td align="center">0x65</td>
<td align="center">e</td>
<td align="center">小写字母e</td>
</tr>
<tr>
<td align="center">0110 0110</td>
<td align="center">0146</td>
<td align="center">102</td>
<td align="center">0x66</td>
<td align="center">f</td>
<td align="center">小写字母f</td>
</tr>
<tr>
<td align="center">0110 0111</td>
<td align="center">0147</td>
<td align="center">103</td>
<td align="center">0x67</td>
<td align="center">g</td>
<td align="center">小写字母g</td>
</tr>
<tr>
<td align="center">0110 1000</td>
<td align="center">0150</td>
<td align="center">104</td>
<td align="center">0x68</td>
<td align="center">h</td>
<td align="center">小写字母h</td>
</tr>
<tr>
<td align="center">0110 1001</td>
<td align="center">0151</td>
<td align="center">105</td>
<td align="center">0x69</td>
<td align="center">i</td>
<td align="center">小写字母i</td>
</tr>
<tr>
<td align="center">0110 1010</td>
<td align="center">0152</td>
<td align="center">106</td>
<td align="center">0x6A</td>
<td align="center">j</td>
<td align="center">小写字母j</td>
</tr>
<tr>
<td align="center">0110 1011</td>
<td align="center">0153</td>
<td align="center">107</td>
<td align="center">0x6B</td>
<td align="center">k</td>
<td align="center">小写字母k</td>
</tr>
<tr>
<td align="center">0110 1100</td>
<td align="center">0154</td>
<td align="center">108</td>
<td align="center">0x6C</td>
<td align="center">l</td>
<td align="center">小写字母l</td>
</tr>
<tr>
<td align="center">0110 1101</td>
<td align="center">0155</td>
<td align="center">109</td>
<td align="center">0x6D</td>
<td align="center">m</td>
<td align="center">小写字母m</td>
</tr>
<tr>
<td align="center">0110 1110</td>
<td align="center">0156</td>
<td align="center">110</td>
<td align="center">0x6E</td>
<td align="center">n</td>
<td align="center">小写字母n</td>
</tr>
<tr>
<td align="center">0110 1111</td>
<td align="center">0157</td>
<td align="center">111</td>
<td align="center">0x6F</td>
<td align="center">o</td>
<td align="center">小写字母o</td>
</tr>
<tr>
<td align="center">0111 0000</td>
<td align="center">0160</td>
<td align="center">112</td>
<td align="center">0x70</td>
<td align="center">p</td>
<td align="center">小写字母p</td>
</tr>
<tr>
<td align="center">0111 0001</td>
<td align="center">0161</td>
<td align="center">113</td>
<td align="center">0x71</td>
<td align="center">q</td>
<td align="center">小写字母q</td>
</tr>
<tr>
<td align="center">0111 0010</td>
<td align="center">0162</td>
<td align="center">114</td>
<td align="center">0x72</td>
<td align="center">r</td>
<td align="center">小写字母r</td>
</tr>
<tr>
<td align="center">0111 0011</td>
<td align="center">0163</td>
<td align="center">115</td>
<td align="center">0x73</td>
<td align="center">s</td>
<td align="center">小写字母s</td>
</tr>
<tr>
<td align="center">0111 0100</td>
<td align="center">0164</td>
<td align="center">116</td>
<td align="center">0x74</td>
<td align="center">t</td>
<td align="center">小写字母t</td>
</tr>
<tr>
<td align="center">0111 0101</td>
<td align="center">0165</td>
<td align="center">117</td>
<td align="center">0x75</td>
<td align="center">u</td>
<td align="center">小写字母u</td>
</tr>
<tr>
<td align="center">0111 0110</td>
<td align="center">0166</td>
<td align="center">118</td>
<td align="center">0x76</td>
<td align="center">v</td>
<td align="center">小写字母v</td>
</tr>
<tr>
<td align="center">0111 0111</td>
<td align="center">0167</td>
<td align="center">119</td>
<td align="center">0x77</td>
<td align="center">w</td>
<td align="center">小写字母w</td>
</tr>
<tr>
<td align="center">0111 1000</td>
<td align="center">0170</td>
<td align="center">120</td>
<td align="center">0x78</td>
<td align="center">x</td>
<td align="center">小写字母x</td>
</tr>
<tr>
<td align="center">0111 1001</td>
<td align="center">0171</td>
<td align="center">121</td>
<td align="center">0x79</td>
<td align="center">y</td>
<td align="center">小写字母y</td>
</tr>
<tr>
<td align="center">0111 1010</td>
<td align="center">0172</td>
<td align="center">122</td>
<td align="center">0x7A</td>
<td align="center">z</td>
<td align="center">小写字母z</td>
</tr>
<tr>
<td align="center">0111 1011</td>
<td align="center">0173</td>
<td align="center">123</td>
<td align="center">0x7B</td>
<td align="center">{</td>
<td align="center">开花括号</td>
</tr>
<tr>
<td align="center">0111 1100</td>
<td align="center">0174</td>
<td align="center">124</td>
<td align="center">0x7C</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0111 1101</td>
<td align="center">0175</td>
<td align="center">125</td>
<td align="center">0x7D</td>
<td align="center">}</td>
<td align="center">闭花括号</td>
</tr>
<tr>
<td align="center">0111 1110</td>
<td align="center">0176</td>
<td align="center">126</td>
<td align="center">0x7E</td>
<td align="center">~</td>
<td align="center">波浪号</td>
</tr>
<tr>
<td align="center">0111 1111</td>
<td align="center">0177</td>
<td align="center">127</td>
<td align="center">0x7F</td>
<td align="center">DEL (delete)</td>
<td align="center">删除</td>
</tr>
</tbody></table>
<p>当然我们可以使用简单的几行代码将这些字符打印出来，因为<code>NUL</code>字符在Windows系统剪贴板中无法复制，而且会截断后面的内容，这里直接输出到文件中。</p>
<p>这里我们就不创建项目了，如果是执行一些简单的代码查看运行效果，例如生成一个GUID，这里建议使用<code>C#交互窗口</code>，可以从 <code>VS工具栏</code> –&gt; <code>视图</code> –&gt; <code>其他窗口</code> –&gt; <code>C#交互窗口</code> 打开。</p>
<p>运行以下代码：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/hex1_1562748853899.png" alt="hex1"></p>
<p>运行成功后会在桌面输出一个文件<code>hex.txt</code>。</p>
<p>注意，如果存在控制字符的文件，建议不要使用系统自带的记事本文件查看，推荐使用<code>Notepad++</code>查看，具体差异可以通过下图看出：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/hex2_1562748853916.png" alt="hex2"></p>
<p>首先是换行符、回车符，<code>Notepad++</code>中默认就是<code>Unix(LF)</code>格式，而记事本要到Win10才能支持，其次控制字符，在<code>Notepad++</code>中，除了<code>DEL</code>，其他都可以看出其控制字符的内容，而记事本就什么也看不到了。另外打开了<code>Notepad++</code>的“Show all characters”，我们甚至可以知道一段空白究竟是由空格符还是制表符构成的，换行效果是由于回车符还是换行符导致的。</p>
<p>当然，如果我们在程序中需要使用这些字符除了上面展示的<code>char.ConvertFromUtf32()</code>方法外，还可以使用<code>C#</code>中的转义符号，如下给出的是常用的控制字符：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ControlCharacter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 空字符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> NUL = <span class="string">&quot;\u0000&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 标题开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> SOH = <span class="string">&quot;\u0001&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 正文开始</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> STX = <span class="string">&quot;\u0002&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 正文结束</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ETX = <span class="string">&quot;\u0003&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 传输结束</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> EOT = <span class="string">&quot;\u0004&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 请求</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ENQ = <span class="string">&quot;\u0005&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 收到通知</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ACK = <span class="string">&quot;\u0006&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 响铃</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> BEL = <span class="string">&quot;\u0007&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 退格</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> BS = <span class="string">&quot;\u0008&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 水平制表符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> HT = <span class="string">&quot;\u0009&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 换行键</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> LF = <span class="string">&quot;\u000a&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 垂直制表符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> VT = <span class="string">&quot;\u000b&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 换页键</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> FF = <span class="string">&quot;\u000c&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 回车键</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> CR = <span class="string">&quot;\u000d&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 不用切换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> SO = <span class="string">&quot;\u000e&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 启用切换</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> SI = <span class="string">&quot;\u000f&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 数据链路转义</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> DLE = <span class="string">&quot;\u0010&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设备控制1</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> DC1 = <span class="string">&quot;\u0011&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设备控制2</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> DC2 = <span class="string">&quot;\u0012&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设备控制3</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> DC3 = <span class="string">&quot;\u0013&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 设备控制4</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> DC4 = <span class="string">&quot;\u0014&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 拒绝接收</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> NAK = <span class="string">&quot;\u0015&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 同步空闲</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> SYN = <span class="string">&quot;\u0016&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 结束传输块</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ETB = <span class="string">&quot;\u0017&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取消</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> CAN = <span class="string">&quot;\u0018&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 媒介结束</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> EM = <span class="string">&quot;\u0019&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 代替</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> SUB = <span class="string">&quot;\u001a&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 换码(溢出)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> ESC = <span class="string">&quot;\u001b&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 文件分隔符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> FS = <span class="string">&quot;\u001c&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分组符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> GS = <span class="string">&quot;\u001d&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 记录分隔符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> RS = <span class="string">&quot;\u001e&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 单元分隔符</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> US = <span class="string">&quot;\u001f&quot;</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 删除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> DEL = <span class="string">&quot;\u007f&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="十六进制"><a href="#十六进制" class="headerlink" title="十六进制"></a>十六进制</h3><p>十六进制（简写为hex或下标16）在数学中是一种逢16进1的进位制。一般用数字0到9和字母A到F（或a<del>f）表示，其中:A</del>F表示10~15，这些称作十六进制数字。</p>
<p>而数据接收串口与网口通讯时，如果我们无法确认接收的编码格式，可以尝试使用十六进制接收，然后根据十六进制数据来判断接收数据的编码格式。</p>
<p>而在发送时，如果我们传输的是控制字符，我们无法使用输入法将控制字符输入到发送区，这时我们可以通过十六进制发送，来发送控制字符，例如需要发送<code>ACK</code>，则只需要输入<code>06</code>即可。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/hex3_1562748853920.png" alt="hex3"></p>
<p>在通讯数据的接收中，我们常常需要将十六进制数据进行转换，其中包括原始文本、十六进制、转义消息三者的相互转换，十六进制与原始文本我们可以理解，转义文本的意思是将不可见的控制字符转换为另外一种特殊的格式进行显示。</p>
<p>例如：收到通知<code>&lt;ACK&gt;</code>的十六进制是<code>06</code>，转义文本是<code>#06&#39;</code>。回车符<code>&lt;CR&gt;</code>的十六进制是<code>0D</code>，转义文本为<code>#0D&#39;</code>。</p>
<p>这里开发了一个简单的转换工具供参考：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/hex4_1562748853924.png" alt="hex4"></p>
<p>源码：<a target="_blank" rel="noopener" href="https://github.com/hd2y/HexConverter">https://github.com/hd2y/HexConverter</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/encoding-in-communication/" data-id="cklc4t81j00d4zuqmf7ij3fp3" data-title="通讯中的编码问题" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ASCII/" rel="tag">ASCII</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190521-the-debugging-and-development-of-serial-communication" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/the-debugging-and-development-of-serial-communication/" class="article-date">
  <time class="dt-published" datetime="2019-05-21T09:44:00.000Z" itemprop="datePublished">2019-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/the-debugging-and-development-of-serial-communication/">串口通讯调试与开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>工作中，LIS系统经常需要开发接口与仪器或流水线对接，串口通讯应该是最常见的几种通讯方式之一了。</p>
<p>至于串口是什么、串口通讯又是什么，这些基本概念就不多做介绍了。</p>
<p>这里就针对于我在串口开发中碰到过的一些问题，做一个简单的分享。</p>
<h2 id="串口模拟"><a href="#串口模拟" class="headerlink" title="串口模拟"></a>串口模拟</h2><p>无论是开发还是测试，肯定都离不开串口的模拟测试，我们不大可能直接在电脑上安装两个串口，所以模拟串口就是最优解了，从网上可以很轻松的搜索到模拟串口的软件。</p>
<p>这里我建议使用<code>Virtual Serial Port Driver</code>，大家可以搜索<code>VSPD</code>下载：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport0_1562753721959.png" alt="serialport0"></p>
<p>安装什么的就不过多解释了，安装完成后我们可以打开并添加模拟串口或者删除模拟的串口，界面如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport1_1562753721959.png" alt="serialport1"></p>
<p>如果对应的串口被使用，也可以从这里看出其串口的状态：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport2_1562753721959.png" alt="serialport2"></p>
<p>当然我们可以在我们的电脑中查看现有的串口，设备管理器中可以查看：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport3_1562753721967.png" alt="serialport3"></p>
<h2 id="串口调试工具"><a href="#串口调试工具" class="headerlink" title="串口调试工具"></a>串口调试工具</h2><p>串口调试工具就是用于串口数据接收/发送的工具软件，比较简单易用的是“串口调试助手V2.2”。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport4_1562753721978.png" alt="serialport4"></p>
<p>但是使用中有几点需要注意：</p>
<ol>
<li>偶尔会发生崩溃，这是串口调试工具的问题；</li>
<li>只能使用COM1-COM4这几个串口，有局限性；</li>
<li>与某些需要检测串口监听状态的仪器连接，虽然已经打开串口但是可能仪器仍然提示连接失败；</li>
</ol>
<p>如果碰到以上问题，那就只能只能自己找解决方案，另外如果具备一定开发经验后，建议根据自身需求来定制自己的串口调试工具，可以避免以上问题。</p>
<h2 id="串口监视精灵"><a href="#串口监视精灵" class="headerlink" title="串口监视精灵"></a>串口监视精灵</h2><p>除了串口调试助手以外，另外比较推荐的工具就是串口监视精灵了，顾名思义其就是类似于网口通讯中的抓包工具。</p>
<p>当初从网上找到这个工具的原因是之前LIS系统替换第三方LIS系统，有一个仪器的双工接口开发一直存在问题，所以想看一下第三方LIS怎么实现的双工通讯消息的交互。</p>
<p>当然如果开发的串口通讯工具中没有输出日志，也可以使用该工具进行监听。</p>
<p>一般我们网上能够找到的分为无DLL版和安装版，这里建议使用安装版。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport5_1562753721992.png" alt="serialport5"></p>
<p>上图为无Dll版，需要选择监听串口所在的进程，中文会乱码，能监听到串口的关闭但是打开的事件则没有输出。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport6_1562753722038.png" alt="serialport6"></p>
<p>上图是安装版，使用安装版需要注意如果系统是x64，第一次使用需要点击软件界面上的“启用64位系统驱动签名”，另外重启。如果监听不到数据，尝试先关闭通讯软件，打开监听后再打开通讯软件。</p>
<p>安装版能够监听到的数据就更完整一些，且每次数据的收发都统一显示为一条记录，这就比无Dll版本的更加友好，但是同样存在的问题是因为是ASC编码所以中文仍然是乱码，需要自己使用HEX编码进行转换。</p>
<p>另外安装版也附带有一个串口调试工具可以使用：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport7_1562753722078.png" alt="serialport7"></p>
<h2 id="串口通讯开发"><a href="#串口通讯开发" class="headerlink" title="串口通讯开发"></a>串口通讯开发</h2><h3 id="获取当前电脑的串口"><a href="#获取当前电脑的串口" class="headerlink" title="获取当前电脑的串口"></a>获取当前电脑的串口</h3><p>引入<code>System.IO.Ports</code>命名空间，然后可以使用<code>SerialPort.GetPortNames()</code>获取当前电脑的所有串行端口名称。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO.Ports;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SerialPortTestConsole</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">string</span>[] ports = SerialPort.GetPortNames();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> port <span class="keyword">in</span> ports)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(port);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="串口数据收发"><a href="#串口数据收发" class="headerlink" title="串口数据收发"></a>串口数据收发</h3><p>引入<code>System.IO.Ports</code>命名空间，然后实例化<code>SerialPort</code>对象，使用<code>Open</code>方法打开串口，<code>DataReceived</code>事件进行数据接收，<code>Write</code>方法可以进行数据发送。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO.Ports;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SerialPortTestConsole</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//注意：以下为串口初始化常用的属性，赋值为默认值，如果没有赋值属性默认也是这些值</span></span><br><span class="line">            SerialPort port = <span class="keyword">new</span> SerialPort()</span><br><span class="line">            &#123;</span><br><span class="line">                PortName = <span class="string">&quot;COM1&quot;</span>,<span class="comment">//端口号</span></span><br><span class="line">                BaudRate = <span class="number">9600</span>,<span class="comment">//波特率</span></span><br><span class="line">                DataBits = <span class="number">8</span>,<span class="comment">//数据位</span></span><br><span class="line">                Parity = Parity.None,<span class="comment">//校验位</span></span><br><span class="line">                StopBits = StopBits.One,<span class="comment">//停止位</span></span><br><span class="line">                Encoding = Encoding.ASCII,<span class="comment">//文本转换编码</span></span><br><span class="line">                WriteBufferSize = <span class="number">2048</span>,<span class="comment">//输出缓存</span></span><br><span class="line">                ReadBufferSize = <span class="number">4096</span>,<span class="comment">//输入缓存</span></span><br><span class="line">                WriteTimeout = <span class="number">-1</span>,<span class="comment">//写超时</span></span><br><span class="line">                ReadTimeout = <span class="number">-1</span>,<span class="comment">//读超时</span></span><br><span class="line">                RtsEnable = <span class="literal">false</span>,<span class="comment">//RTS信号：建议启用</span></span><br><span class="line">                DtrEnable = <span class="literal">false</span>,<span class="comment">//DTR信号：建议启用</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//数据接收事件 输出到控制台</span></span><br><span class="line">            port.DataReceived += <span class="keyword">new</span> SerialDataReceivedEventHandler((sender, e) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (port.BytesToRead &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> length = port.BytesToRead;</span><br><span class="line">                    <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[length];</span><br><span class="line">                    port.Read(buffer, <span class="number">0</span>, length);</span><br><span class="line">                    Console.WriteLine(port.Encoding.GetString(buffer));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//打开串口</span></span><br><span class="line">            <span class="keyword">if</span> (!port.IsOpen)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    port.Open();</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;串口打开成功：<span class="subst">&#123;port.PortName&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception exception)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;打开串口失败：<span class="subst">&#123;exception.Message&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (port.IsOpen)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//输入串口发送内容</span></span><br><span class="line">                <span class="built_in">string</span> input = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">do</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;请输入要发送的内容：&quot;</span>);</span><br><span class="line">                    input = Console.ReadLine();</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">byte</span>[] buffer = port.Encoding.GetBytes(input);</span><br><span class="line">                        port.Write(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.IsNullOrEmpty(input));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//关闭串口释放资源</span></span><br><span class="line">                port.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            port.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一个简单的调试工具"><a href="#一个简单的调试工具" class="headerlink" title="一个简单的调试工具"></a>一个简单的调试工具</h3><p>通过以上例子基本上对串口数据手法有个简单的了解，这里我们设计一个工具，来实现串口调试工具的基本功能。</p>
<p><code>SerialPort</code>的属性/方法/事件基本没有什么好说的了，这里主要需要了解HEX数据的转换：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 字符串拓展方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">StringExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将指定字符串转换为十六进制Hex字符串形式。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>要转换的原始字符串。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span>编码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>转换后的内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToHex</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> input, Encoding e = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        e = e ?? Encoding.UTF8;</span><br><span class="line">        <span class="built_in">byte</span>[] byteArray = e.GetBytes(input);</span><br><span class="line">        <span class="keyword">return</span> BitConverter.ToString(byteArray).Replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将十六进制Hex字符串转换为原始字符串。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>十六进制字符串内容<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span>编码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>原始字符串内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ReHex</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> input, Encoding e = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        e = e ?? Encoding.UTF8;</span><br><span class="line">        input = Regex.Replace(input, <span class="string">&quot;[^0-9A-F]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (input.Length &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">byte</span>[] vBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[input.Length / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vBytes.Length; i++)</span><br><span class="line">            vBytes[i] = <span class="built_in">byte</span>.Parse(input.Substring(i * <span class="number">2</span>, <span class="number">2</span>), NumberStyles.HexNumber);</span><br><span class="line">        <span class="keyword">return</span> e.GetString(vBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将十六进制Hex字符串转换为二进制数据。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>十六进制字符串内容<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>原始字符串内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">ReHexToBuffer</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> input</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        input = Regex.Replace(input, <span class="string">&quot;[^0-9A-F]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">byte</span>[] vBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[input.Length / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vBytes.Length; i++)</span><br><span class="line">            vBytes[i] = <span class="built_in">byte</span>.Parse(input.Substring(i * <span class="number">2</span>, <span class="number">2</span>), NumberStyles.HexNumber);</span><br><span class="line">        <span class="keyword">return</span> vBytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 二进制数据拓展方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">BufferExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将指定二进制数据转换为十六进制Hex字符串形式。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>要转换的二进制数据。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>转换后的内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToHex</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">byte</span>[] input</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> BitConverter.ToString(input).Replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就是简单实现后的效果：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport8_1562753722104.png" alt="serialport8"></p>
<p>源代码下载：<a target="_blank" rel="noopener" href="https://github.com/hd2y/SerialPortTest">https://github.com/hd2y/SerialPortTest</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/the-debugging-and-development-of-serial-communication/" data-id="cklc4t7xy001qzuqm5zerhqeh" data-title="串口通讯调试与开发" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%B2%E5%8F%A3/" rel="tag">串口</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190521-how-to-repair-corrupted-sqlite-database-files" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/how-to-repair-corrupted-sqlite-database-files/" class="article-date">
  <time class="dt-published" datetime="2019-05-21T03:39:38.000Z" itemprop="datePublished">2019-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/SQLite/">SQLite</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/how-to-repair-corrupted-sqlite-database-files/">如何修复损坏的SQLite数据库文件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近处理过一个SQLite数据库因为未知原因损坏，无法进行数据操作的而导致软件无法正常使用的问题。</p>
<p>虽然工具软件是基于<code>Code First</code>开发，可以直接删除数据库来重新生成数据文件，但是因为里面存储了很多基本参数，运维人员认为重新设置这些参数比较麻烦，所以希望能够提供一个方案来修复已经损坏的数据库。</p>
<p>和运维沟通后将数据库文件导回，尝试跟踪问题。从网上查询到解决方案，这里简单做一个记录。</p>
<h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><p>使用SQLite数据库管理工具<code>SQLite Studio</code>进行数据查询操作，访问正常，尝试直接删除某一个表的数据出现如下错误提示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[10:42:22] Error while executing SQL query on database &#x27;data&#x27;: database disk image is malformed</span><br></pre></td></tr></table></figure>
<p>从网上查找如何排查错误，发现一个语句可以对SQLite数据库进行检测：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA integrity_check;</span><br></pre></td></tr></table></figure>
<p>以上语句是执行整个库的完全性检查，会查看错序的记录、丢失的页，毁坏的索引等。 </p>
<p>执行后我获得的信息是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">&quot;*** in database main ***</span><br><span class="line">Main freelist: freelist leaf count too big on page 138339</span><br><span class="line">Main freelist: invalid page number 218103808</span><br><span class="line">On tree page 42 cell 176: 2nd reference to page 138339</span><br><span class="line">Page 18 is never used</span><br><span class="line">Page 20 is never used</span><br><span class="line">Page 23 is never used</span><br><span class="line">Page 25 is never used</span><br><span class="line">Page 26 is never used</span><br><span class="line">Page 27 is never used</span><br><span class="line">Page 28 is never used</span><br><span class="line">Page 29 is never used</span><br><span class="line">Page 30 is never used</span><br><span class="line">Page 31 is never used</span><br><span class="line">Page 32 is never used</span><br><span class="line">Page 33 is never used</span><br><span class="line">Page 34 is never used</span><br><span class="line">Page 35 is never used</span><br><span class="line">Page 36 is never used</span><br><span class="line">Page 37 is never used</span><br><span class="line">Page 38 is never used</span><br><span class="line">Page 39 is never used</span><br><span class="line">Page 40 is never used</span><br><span class="line">Page 41 is never used</span><br><span class="line">Page 43 is never used</span><br><span class="line">Page 44 is never used</span><br><span class="line">Page 45 is never used</span><br><span class="line">Page 46 is never used</span><br><span class="line">Page 47 is never used</span><br><span class="line">Page 48 is never used</span><br><span class="line">Page 49 is never used</span><br><span class="line">Page 50 is never used</span><br><span class="line">Page 51 is never used</span><br><span class="line">Page 52 is never used</span><br><span class="line">Page 53 is never used</span><br><span class="line">Page 54 is never used</span><br><span class="line">Page 55 is never used</span><br><span class="line">Page 56 is never used</span><br><span class="line">Page 57 is never used</span><br><span class="line">Page 58 is never used</span><br><span class="line">Page 59 is never used</span><br><span class="line">Page 60 is never used</span><br><span class="line">Page 61 is never used</span><br><span class="line">Page 62 is never used</span><br><span class="line">Page 63 is never used</span><br><span class="line">Page 64 is never used</span><br><span class="line">Page 65 is never used</span><br><span class="line">Page 66 is never used</span><br><span class="line">Page 67 is never used</span><br><span class="line">Page 68 is never used</span><br><span class="line">Page 69 is never used</span><br><span class="line">Page 70 is never used</span><br><span class="line">Page 71 is never used</span><br><span class="line">Page 73 is never used</span><br><span class="line">Page 74 is never used</span><br><span class="line">Page 75 is never used</span><br><span class="line">Page 76 is never used</span><br><span class="line">Page 77 is never used</span><br><span class="line">Page 78 is never used</span><br><span class="line">Page 79 is never used</span><br><span class="line">Page 80 is never used</span><br><span class="line">Page 81 is never used</span><br><span class="line">Page 82 is never used</span><br><span class="line">Page 83 is never used</span><br><span class="line">Page 84 is never used</span><br><span class="line">Page 85 is never used</span><br><span class="line">Page 86 is never used</span><br><span class="line">Page 88 is never used</span><br><span class="line">Page 89 is never used</span><br><span class="line">Page 90 is never used</span><br><span class="line">Page 91 is never used</span><br><span class="line">Page 92 is never used</span><br><span class="line">Page 93 is never used</span><br><span class="line">Page 94 is never used</span><br><span class="line">Page 95 is never used</span><br><span class="line">Page 96 is never used</span><br><span class="line">Page 97 is never used</span><br><span class="line">Page 98 is never used</span><br><span class="line">Page 99 is never used</span><br><span class="line">Page 100 is never used</span><br><span class="line">Page 101 is never used</span><br><span class="line">Page 102 is never used</span><br><span class="line">Page 103 is never used</span><br><span class="line">Page 104 is never used</span><br><span class="line">Page 105 is never used</span><br><span class="line">Page 106 is never used</span><br><span class="line">Page 107 is never used</span><br><span class="line">Page 108 is never used</span><br><span class="line">Page 110 is never used</span><br><span class="line">Page 111 is never used</span><br><span class="line">Page 112 is never used</span><br><span class="line">Page 113 is never used</span><br><span class="line">Page 114 is never used</span><br><span class="line">Page 115 is never used</span><br><span class="line">Page 116 is never used</span><br><span class="line">Page 117 is never used</span><br><span class="line">Page 118 is never used</span><br><span class="line">Page 119 is never used</span><br><span class="line">Page 120 is never used</span><br><span class="line">Page 121 is never used</span><br><span class="line">Page 122 is never used&quot;</span><br></pre></td></tr></table></figure>
<p>后面的问题就简单了，从网上搜索这个错误可以获得解决方案，基本原理就是将数据库内容导出脚本，然后通过这个脚本重新构建数据库。</p>
<p>可以参考：<a target="_blank" rel="noopener" href="https://techblog.dorogin.com/sqliteexception-database-disk-image-is-malformed-77e59d547c50">https://techblog.dorogin.com/sqliteexception-database-disk-image-is-malformed-77e59d547c50</a></p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>首先我们需要下载SQLite数据库的命令行管理工具：sqlite3.exe，命令行工具如何使用可以参考：<a target="_blank" rel="noopener" href="https://www.sqlite.org/cli.html">https://www.sqlite.org/cli.html</a></p>
<p>我们可以SQLite官网下载命令行工具，比如我下载的是<code>sqlite-tools-win32-x86-3280000.zip</code>，可以在这里找到：<a target="_blank" rel="noopener" href="https://www.sqlite.org/download.html">https://www.sqlite.org/download.html</a></p>
<p>解压文件，并将数据文件拷贝到同级目录。</p>
<p>执行导出：</p>
<ol>
<li>双击<code>sqlite3.exe</code>运行SQLite数据库命令行工具。</li>
<li>执行<code>.open data.db</code>打开我们需要导出数据脚本的数据文件。</li>
<li>执行<code>.mode insert</code>将导出脚本模式修改为用于执行INSERT。</li>
<li>执行<code>.output dump_all.sql</code>指定导出文件的未知与文件名。</li>
<li>执行<code>.dump</code>执行导出。（需要注意的是如果数据库文件较大，可能需要耐心等待一段时间。）</li>
</ol>
<p>如果内容较多，可能执行导出耗时会比较长，需要耐心等待。</p>
<p>执行完成后可以在文件夹下找到导出的脚本文件。</p>
<p>使用SQL文件生成数据库文件：</p>
<ol>
<li>关闭原有的命令行工具，重新打开。</li>
<li>执行<code>.open data.fixed.db</code>，<code>data.fixed.db</code>就是我们恢复后数据库的数据库名。</li>
<li>执行<code>.read dump_all.sql</code>将数据脚本加载到创建的数据库中，等待执行完成即完成数据库的修复。</li>
</ol>
<p>执行成功会生成了一个数据库文件。</p>
<p>我们可以使用文章开篇所使用数据库管理工具尝试检索数据库的状态，如果反馈数据正常，则恢复工作完成。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA integrity_check;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/how-to-repair-corrupted-sqlite-database-files/" data-id="cklc4t7xw001ozuqm2ao889tf" data-title="如何修复损坏的SQLite数据库文件" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-190516-lodop-the-best-print-control-for-printing-experience-under-web" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/lodop-the-best-print-control-for-printing-experience-under-web/" class="article-date">
  <time class="dt-published" datetime="2019-05-16T07:32:56.000Z" itemprop="datePublished">2019-05-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/lodop-the-best-print-control-for-printing-experience-under-web/">Web下打印体验最好的打印控件LODOP</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="什么是LODOP"><a href="#什么是LODOP" class="headerlink" title="什么是LODOP"></a>什么是LODOP</h2><p>LODOP是BS架构打印的解决方案，支持绝大多数浏览器，如果网站上有打印的需求，推荐使用该工具进行打印。</p>
<p>选择LODOP的原因不仅仅在于其对于web打印有着比原生打印更好的打印体验，主要是其还提供了丰富的API，让开发者可以访问打印任务的状态以及打印机的状态，设置打印机与打印输出的属性等等，让开发者可以通过这些实现更多的用户需求。</p>
<p>另外看了官网云打印，之前一直以为必须安装控件才能打印，所以应该是对于设备和系统有要求，但是目前来看也是不限制的，甚至可以使用移动端发送打印请求，但是我没有这方面的使用需求，这里仅仅讨论Windows平台下的打印使用经验。</p>
<p>官方网站：<a target="_blank" rel="noopener" href="http://www.lodop.net/">http://www.lodop.net/</a></p>
<h3 id="LODOP安装使用"><a href="#LODOP安装使用" class="headerlink" title="LODOP安装使用"></a>LODOP安装使用</h3><p>在官网里<a target="_blank" rel="noopener" href="http://www.lodop.net/download.html">下载中心</a>中我们可以下载到打印控件(产品下载)与JS调用打印控件的API(技术手册)，并且产品下载的内容包含测试的样例。</p>
<p>因为官方给的例子中已经有详细的安装以及使用说明，所以这里不做赘述，可以进入下载中心下载解压后直接查看样例，样例1就是安装以及基本的使用说明，其他的样例是一些常见的使用场景。</p>
<p>强烈建议加入售后群，LODOP的售后人员回答问题都很专业且及时，有很好的售后体验。如果使用时发现了以上测试用例之外的使用场景，或者发现一些使用问题，基本都能在技术人员那里得到优质的反馈。</p>
<h2 id="打印场景说明"><a href="#打印场景说明" class="headerlink" title="打印场景说明"></a>打印场景说明</h2><p>使用LODOP打印应该也有两年多了，主要用于条码打印/检验报告单/报表，这里简单聊以下我的使用场景。</p>
<h3 id="条码打印"><a href="#条码打印" class="headerlink" title="条码打印"></a>条码打印</h3><p>因为系统架构是BS的，早期使用ScriptX进行打印主要有这么几个痛点：</p>
<ul>
<li>打印Html内容格式很难固定，需要设置条码打印机来控制纸张大小，而且这个过程非常繁琐，经常出现问题；</li>
<li>不能跨浏览器，只能支持IE浏览器，而且一般需要开启兼容模式并添加受信任站点；</li>
<li>如果需要设置打印场景的默认打印机，需要读取注册表来读取当前系统的打印机，这也是浏览器不兼容的一个主要问题；</li>
<li>不弹出提示直接执行打印任务可能需要安装一些打印控件，但是这些打印控件安装繁琐，且部分系统支持有限；</li>
<li>分页是个问题，内容一旦溢出，即使设置了打印纸张也没用；</li>
<li>条码输出需要后端来支持，生成图片；</li>
</ul>
<p>当然以上只是一部分，但是实际在没有LODOP前打印体验还更差，工程实施与运维在这里踩出过很多坑，而且很多问题会和打印环境也就是电脑系统/IE版本有关，出现问题也很难排查。</p>
<p>因为有打印条形码的需求，并且不想使用后端来生成条形码图片，所以这里我不推荐全部使用HTML设置打印内容。文本建议使用<code>ADD_PRINT_TEXT</code>或<code>ADD_PRINT_TEXTA</code>，区别是后者可以可以针对性的设置打印样式。条码输出建议使用<code>ADD_PRINT_BARCODE</code>。</p>
<p>因为LODOP没有提供直接适用于浏览器的样式设置工具，所以建议自己配置一个模块维护样式。（样例中有使用设置工具生成模板的例子，但是不够相对来说不够直观）。</p>
<p>我这边的设计是BarcodeDesign(条码样式设计表)、BarcodeDesignDetail(条码样式设计明细表)、BarcodeDesignDetailStyle(条码样式设计明细样式表)。</p>
<p>BarcodeDesign是主表，控制打印的基本样式，维护基本的信息主要是样式名称、打印纸张大小、打印方向、样式说明等。</p>
<p>BarcodeDesignDetail是BarcodeDesign的从表，用于维护打印的具体内容，例如数据源、类型(条形码、文本、图片、图形、HTML内容、分页符等LODOP支持输出的格式)、顺序(结合类型中的分页符实现分页效果)等、内容的位置信息和宽高。</p>
<p>BarcodeDesignDetailStyle是BarcodeDesignDetail的从表，用于维护打印内容的样式信息，也就是SET_PRINT_STYLEA可以针对不同的内容类型设置的样式。</p>
<h3 id="检验报告"><a href="#检验报告" class="headerlink" title="检验报告"></a>检验报告</h3><p>检验报告单的打印，相对条码打印要复杂很多，因为基本样式是不固定的。公司在前期没有考虑用报表控件，开始是xsl输出，因为学习成本较高不利于维护，后面改用Html打印，除常见格式外，余下的每种报告单样式对应一个页面。</p>
<p>开始没有考虑FastReport是因为BS架构下兼容有问题，加上报告单的样式比较复杂，数据源比较复杂，分页/数据表设计/排版 在这些报表控件中很难设计出理想的效果，另外就是报表控件设计工具的使用对于我来说也有一定的学习成本，所以基于此干脆继续使用Html打印，而这恰好也是LODOP最擅长的。</p>
<p>设计主要就两个表：LabReportDesign(实验室检验报告单设计表)与LabReportDesignDetail(实验室检验报告单设计明细表)。</p>
<p>LabReportDesign是主表，主要用来配置报告单的基本信息，包括报告单名称、打印纸张信息、输出内容的宽度与边距、使用的字体大小与样式、是否使用特殊样式(默认走普通样式)、每页显示的数据行数等等。</p>
<p>LabReportDesignDetail是LabReportDesign的从表，主要用于配置一些基础的数据源信息，包括行头展示的病人与检验信息/页脚展示的病人与检验信息/报告单主题内容显示哪些结果信息/注脚显示的信息等。</p>
<p>这里如果是普通报告单，从以上两张表的设置，可以从后台拼接一份Html用于打印。</p>
<p>如果是特殊样式的报告单，这里也没有考虑使用页面，一方面不方便打印，另外就是考虑到检验医师签名后要将数据静态化到数据表中，供其他系统查阅，这里使用的Razor引擎解析指定目录下的<code>cshtml</code>文件，这里是可以返回一份Html内容的。</p>
<p>另外将Html内容静态化的另外一个好处就是，我们还可以使用一些工具例如<code>wkhtmltopdf</code>将文件生成PDF文件。</p>
<h3 id="报表"><a href="#报表" class="headerlink" title="报表"></a>报表</h3><p>普通报表打印输出问题不大，问题是一些报表的某些数据列，内容长度变化较大不方便分页，之前设计的打印都是每一页固定行数，就会出现某些内容打印超出纸张，某些内容只占了纸张的一半。</p>
<p>这里建议参考一下样例中数据表格分页打印的样例，但是需要注意的是表格数据内容较多时，打印控件进行数据装载的时间会比较长。</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><p>优点：</p>
<ul>
<li>BS架构实现CS架构下的打印体验，这一点是目前市面上打印控件做的最好的；</li>
<li>浏览器兼容性较好，支持现代浏览器；</li>
<li>样例完善，基本覆盖所有的打印场景；</li>
<li>售后技术人员反馈回复及时，回复内容也比较专业；</li>
<li>价格方面比较友好；</li>
</ul>
<p>缺点：</p>
<ul>
<li>打印依赖IE浏览器解析，LODOP客户端或CLODOP服务端IE浏览器版本较低可能会出现一些问题；</li>
<li>目前设计功能开发还不够，需要进一步完善；</li>
<li>仅仅适用于打印样式比较简单的场景；</li>
<li>如果需要将内容输出为PDF等格式文档文件可能需要依赖虚拟打印机等；</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li>打印的Html内容如果需要加载媒体资源例如图片，建议通过<code>SET_PRINT_STYLEA</code>设置<code>HtmWaitMilSecs</code>即超文本下载延迟，避免图片没有下载完成即执行打印；</li>
<li>尽量避免打印内容的媒体资源，例如图片<code>404</code>，否则可能出现任务响应缓慢；</li>
<li>打印Html内容一定要检查内容开闭标签是否有缺失，否则可能出现很奇怪的问题；</li>
<li>打印Html内容如果是外联样式，并且要使用该样式，注意打印的时候要加入到打印内容中；</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/lodop-the-best-print-control-for-printing-experience-under-web/" data-id="cklc4t7xv001mzuqmd5m7e53t" data-title="Web下打印体验最好的打印控件LODOP" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LODOP/" rel="tag">LODOP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%89%93%E5%8D%B0/" rel="tag">打印</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190506-using-jint-to-run-js-in-csharp-and-implement-simple-calculator" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/using-jint-to-run-js-in-csharp-and-implement-simple-calculator/" class="article-date">
  <time class="dt-published" datetime="2019-05-06T09:45:00.000Z" itemprop="datePublished">2019-05-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/using-jint-to-run-js-in-csharp-and-implement-simple-calculator/">利用Jint在C#中运行JS脚本并实现简单计算器</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="关于Jint"><a href="#关于Jint" class="headerlink" title="关于Jint"></a>关于Jint</h2><p>Jint是一个开源的JS脚本引擎，可以让我们在dotnet平台运行js代码，这使我们可以通过这一特性处理很多工作。</p>
<p>关于Jint的更多信息和用例可以参考：<a target="_blank" rel="noopener" href="https://github.com/sebastienros/jint">https://github.com/sebastienros/jint</a></p>
<h2 id="Jint的用途"><a href="#Jint的用途" class="headerlink" title="Jint的用途"></a>Jint的用途</h2><h3 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h3><p>在日常工作中存在一个需求：用户自己定义表达式，系统根据表达式替换表达式中项目的数值，计算生成另外一个项目的结果。</p>
<p>例如：<code>[GLO] = [TP] - [ALB]</code>，已知<code>[TP]</code>与<code>[ALB]</code>的结果，需要我们求出<code>[GLO]</code>的结果。</p>
<p>这个表达式初看其实很简单，但是实际业务中，可能存在多层级的嵌套甚至次幂/开根号/自然对数等的运算，这样如果通过程序来解析表达式进行运算工作量比较大。</p>
<p>过去程序设计是在Web端触发特定事件后通过正则替换表达式中参与运算项目为实际数值，使用<code>eval</code>函数执行表达式，获取结果并保存到数据库。但是随着系统不断升级，仅仅依靠前端来更新结果，在某些情况下不够人性化而且不能满足需求。</p>
<p>检索关于算术运算，网上普遍推荐的方案是：</p>
<ol>
<li>使用数据库拼接SQL语句；</li>
<li>通过C#反射实现类似js的<code>eval</code>函数效果；</li>
</ol>
<p>但是这些方案的缺点都很明显：数据库方案需要保持数据库连接，消耗数据库性能，并且不能使用特殊的函数运算比如对数等求解；C#的反射数值中如果存在整数运算，则会取整，需要手动替换数值增加浮点型数字的标记比较麻烦。</p>
<p>几次碰壁以后，就在想，是不是可以在C#中运行js代码？在网上检索相关资料果然有戏。不过首先尝试的是Microsoft.JScript库，不过这个已经被微软标记为<code>Obsolete</code>，并且对于一些语法支持的不完善，所以这里不推荐。</p>
<p>首先我们来实现一个简单的计算器：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取算术式结果</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>原始算术式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Calculator</span>(<span class="params"><span class="built_in">string</span> input = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//算式为空提示输入算式</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;请输入一个算术式(退出输入Q)：&quot;</span>);</span><br><span class="line">            input = Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非退出该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//使用Jint执行算式</span></span><br><span class="line">                Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">                <span class="built_in">object</span> result = engine.Execute(input).GetCompletionValue().ToObject();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;算术式：<span class="subst">&#123;input&#125;</span> 输出：<span class="subst">&#123;result&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception exc)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;算术式：<span class="subst">&#123;input&#125;</span> 运算出现异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//赋值空让用户循环输入</span></span><br><span class="line">            input = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试一下效果，已经满足了我们的需求：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/jint1_1562755045285.png" alt="jint1"></p>
<blockquote>
<p>需要注意的是，JavaScript中对于浮点数的支持精度较低，建议运算后设定小数位数进行转换。</p>
</blockquote>
<p>通过以上，我们进一步实现上面我们业务中需要的功能，下面是一个简单的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取表达式结果</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>原始表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetResultFromExpression</span>(<span class="params"><span class="built_in">string</span> input = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> oldInput;</span><br><span class="line">    Regex regex = <span class="keyword">new</span> Regex(<span class="string">@&quot;\[([A-Za-z0-9]+)\]&quot;</span>);<span class="comment">//表达式中项目由字母和数字组成</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//表达式为空提示输入表达式</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;请输入表达式(退出输入Q)：&quot;</span>);</span><br><span class="line">            input = Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于输出原始表达式</span></span><br><span class="line">        oldInput = input;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于判断表达式项目是否已经替换</span></span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; items = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非退出该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//匹配表达式中项目并替换</span></span><br><span class="line">            MatchCollection matches = regex.Matches(input);</span><br><span class="line">            <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> matches)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//已经替换的跳过</span></span><br><span class="line">                <span class="keyword">if</span> (items.Contains(match.Value))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                items.Add(match.Value);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;请为项目：<span class="subst">&#123;match.Value&#125;</span> 赋值：&quot;</span>);</span><br><span class="line">                <span class="built_in">string</span> item = Console.ReadLine();</span><br><span class="line">                input = input.Replace(match.Value, item);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//使用Jint执行表达式</span></span><br><span class="line">                Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">                <span class="built_in">object</span> result = engine.Execute(input).GetCompletionValue().ToObject();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;表达式：<span class="subst">&#123;oldInput&#125;</span> 算术式：<span class="subst">&#123;input&#125;</span> 输出：<span class="subst">&#123;result&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception exc)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;表达式：<span class="subst">&#123;oldInput&#125;</span> 算术式：<span class="subst">&#123;input&#125;</span> 运算出现异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//赋值空让用户循环输入</span></span><br><span class="line">            input = <span class="literal">null</span>;</span><br><span class="line">            oldInput = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/jint2_1562755045287.png" alt="jint2"></p>
<h3 id="自定义脚本"><a href="#自定义脚本" class="headerlink" title="自定义脚本"></a>自定义脚本</h3><p>系统中某些位置，可能需要比较大的自由度去处理业务数据，例如文档的输出，我们能从数据库中读取到结果是数值型，但是实施人员希望我们能处理成文本型，并且设定的条件较多，自由度很大。</p>
<p>当然最直接的方案就是我们将这些集成到业务代码中，友好一点的设置一个参数表，由工程人员维护。但是当这里的业务逻辑复杂或者存在很多的不定因素，这里的维护更新就变得困难。</p>
<p>而这个时候，我们可以通过写一些js脚本，来处理复杂逻辑的问题，例如文档中我们配置了一下内容：</p>
<p><code>[ItemName]的结果为[ResultValue]，临床意义为：[Descript]。</code></p>
<p>当<code>[ItemName]</code>显示的内容是“HIV”时，<code>[ResultValue]</code>的值小于1判定<code>[Descript]</code>为“阴性”，否则为待复查。若<code>[ItemName]</code>不是“HIV”时，<code>[ResultValue]</code>的值小于1判定<code>[Descript]</code>为“阴性”，否则为阳性。如果<code>[ResultValue]</code>中存在非数字部分，则只取数字部分内容。</p>
<p>这里如果用业务代码或者参数来写，可能复杂一些，因为像这样的业务逻辑还有很多，而且可能随时需要调整，但是我们可以将以上的内容稍稍进行调整，我们定义<code>$#*[JS代码]*#</code>来包括一段代码，将以上的内容进行调整：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ItemName]的结果为[ResultValue]，临床意义为：$#*</span><br><span class="line">var n &#x3D; &#39;[ItemName]&#39;;</span><br><span class="line">var r &#x3D; &#39;[ResultValue]&#39;.replace(&#x2F;[^0-9\+\-\.]&#x2F;, &#39;&#39;);</span><br><span class="line">var d &#x3D; &#39;&#39;;</span><br><span class="line">if (r !&#x3D;&#x3D; &#39;&#39; &amp;&amp; !isNaN(r)) &#123;</span><br><span class="line">    if (n &#x3D;&#x3D;&#x3D; &#39;HIV&#39; &amp;&amp; r &gt;&#x3D; 1) &#123;</span><br><span class="line">        d &#x3D; &#39;待复查&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (r &gt;&#x3D; 1) &#123;</span><br><span class="line">        d &#x3D; &#39;阳性&#39;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        d &#x3D; &#39;阴性&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">d;*#。</span><br></pre></td></tr></table></figure>
<p>那么我们写一个测试用例实现以下对以上内容的解析：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行自定义脚本获取内容</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>脚本<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteCustomScript</span>(<span class="params"><span class="built_in">string</span> input = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> oldInput;</span><br><span class="line">    Regex regex1 = <span class="keyword">new</span> Regex(<span class="string">@&quot;\[([A-Za-z0-9]+)\]&quot;</span>);<span class="comment">//脚本中项目由字母和数字组成</span></span><br><span class="line">    Regex regex2 = <span class="keyword">new</span> Regex(<span class="string">@&quot;\$#\*(.+)\*#&quot;</span>, RegexOptions.Singleline);<span class="comment">//匹配自定义脚本</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//脚本为空提示输入</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;请输入脚本(退出输入Q)：&quot;</span>);</span><br><span class="line">            input = Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于输出原始脚本</span></span><br><span class="line">        oldInput = input;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于判断脚本项目是否已经替换</span></span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; items = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于判断脚本内容是否已经替换</span></span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; scripts = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非退出该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//匹配脚本中项目并替换</span></span><br><span class="line">            &#123;</span><br><span class="line">                MatchCollection matches = regex1.Matches(input);</span><br><span class="line">                <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> matches)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//已经替换的跳过</span></span><br><span class="line">                    <span class="keyword">if</span> (items.Contains(match.Value))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    items.Add(match.Value);</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;请为项目：<span class="subst">&#123;match.Value&#125;</span> 赋值：&quot;</span>);</span><br><span class="line">                    <span class="built_in">string</span> item = Console.ReadLine();</span><br><span class="line">                    input = input.Replace(match.Value, item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//匹配内容中自定义脚本并执行替换</span></span><br><span class="line">            &#123;</span><br><span class="line">                MatchCollection matches = regex2.Matches(input);</span><br><span class="line">                <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> matches)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//已经替换的跳过</span></span><br><span class="line">                    <span class="keyword">if</span> (scripts.Contains(match.Value))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    scripts.Add(match.Value);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//使用Jint执行内容中自定义脚本</span></span><br><span class="line">                        Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">                        <span class="built_in">object</span> result = engine.Execute(match.Groups[<span class="number">1</span>].Value).GetCompletionValue().ToObject();</span><br><span class="line">                        input = input.Replace(match.Value, result.ToString());</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (Exception exc)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Console.WriteLine(<span class="string">$&quot;脚本：<span class="subst">&#123;match.Groups[<span class="number">1</span>].Value&#125;</span>\r\n执行出现异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;**********************\r\n原始脚本：<span class="subst">&#123;oldInput&#125;</span>\r\n输出内容：<span class="subst">&#123;input&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//还原公式让用户重新赋值</span></span><br><span class="line">            input = oldInput;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">JintTest.ExecuteCustomScript(<span class="string">@&quot;[ItemName]的结果为[ResultValue]，临床意义为：$#*</span></span><br><span class="line"><span class="string">var n = &#x27;[ItemName]&#x27;;</span></span><br><span class="line"><span class="string">var r = &#x27;[ResultValue]&#x27;.replace(/[^0-9\+\-\.]/, &#x27;&#x27;);</span></span><br><span class="line"><span class="string">var d = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">if (r !== &#x27;&#x27; &amp;&amp; !isNaN(r)) &#123;</span></span><br><span class="line"><span class="string">    if (n === &#x27;HIV&#x27; &amp;&amp; r &gt;= 1) &#123;</span></span><br><span class="line"><span class="string">        d = &#x27;待复查&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else if (r &gt;= 1) &#123;</span></span><br><span class="line"><span class="string">        d = &#x27;阳性&#x27;;</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">        d = &#x27;阴性&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">d;*#。&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/jint3_1562755045286.png" alt="jint3"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/using-jint-to-run-js-in-csharp-and-implement-simple-calculator/" data-id="cklc4t7xt001jzuqmd3iv0w1f" data-title="利用Jint在C#中运行JS脚本并实现简单计算器" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jint/" rel="tag">Jint</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190410-implementing-a-simple-crawler-project-in-csharp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/implementing-a-simple-crawler-project-in-csharp/" class="article-date">
  <time class="dt-published" datetime="2019-04-10T12:55:33.000Z" itemprop="datePublished">2019-04-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/implementing-a-simple-crawler-project-in-csharp/">C#中实现简单爬虫项目</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="什么是爬虫"><a href="#什么是爬虫" class="headerlink" title="什么是爬虫"></a>什么是爬虫</h2><p>爬虫即网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。另外一些不常使用的名字还有蚂蚁、自动索引、模拟程序或者蠕虫。</p>
<p>我们日常使用的搜索引擎、比价网站等都是通过爬虫技术获取数据，而后经数据提取、分析、优化后供用户使用。当然日常生活中，我们也可以使用爬虫技术，获取我们感兴趣的网站进行数据解析分析，做出来一些有意思的功能或小工具，比如新闻提醒、事项通知、资料整理等。</p>
<p>这方面我们需要了解的技术主要是：Http请求、XPath、正则等。以下是一个简单的例子，用于获取京东商城的数据，例子仅供学习。</p>
<h2 id="抓取京东所有商品类别"><a href="#抓取京东所有商品类别" class="headerlink" title="抓取京东所有商品类别"></a>抓取京东所有商品类别</h2><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ul>
<li>分析京东商品类别页面<blockquote>
<p>Chrome浏览器打开页面：<a target="_blank" rel="noopener" href="https://www.jd.com/allsort.aspx">https://www.jd.com/allsort.aspx</a></p>
</blockquote>
</li>
<li>查看页面源代码<blockquote>
<p>用XPath分析商品类别信息，包括分类ID、分类名、链接，XPath语法可参考：<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/xpath_syntax.asp">http://www.w3school.com.cn/xpath/xpath_syntax.asp</a></p>
</blockquote>
</li>
<li>获取数据<blockquote>
<p>使用 <code>System.Net.WebRequest</code>/<code>System.Net.WebClient</code>/<code>HtmlAgilityPack.HtmlWeb</code> 获取数据 (<code>HtmlAgilityPack</code> 可以通过 <code>nuget</code> 添加引用)</p>
</blockquote>
</li>
<li>解析数据<blockquote>
<p>使用 <code>HtmlAgilityPack.HtmlDocument</code> 解析包含商品类别信息的链接</p>
</blockquote>
</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><p>使用 <code>System.Net.WebRequest/System.Net.HttpWebRequest</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HtmlAgilityPack.HtmlDocument document = <span class="literal">null</span>;</span><br><span class="line">WebRequest request = WebRequest.Create(<span class="string">&quot;https://www.jd.com/allsort.aspx&quot;</span>);</span><br><span class="line"><span class="keyword">using</span> (WebResponse response = request.GetResponse())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (Stream stream = response.GetResponseStream())</span><br><span class="line">    &#123;</span><br><span class="line">        document = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">        document.Load(stream, Encoding.UTF8);</span><br><span class="line">        <span class="comment">//MemoryStream memoryStream = (MemoryStream)stream;</span></span><br><span class="line">        <span class="comment">//document.LoadHtml(Encoding.UTF8.GetString(memoryStream.ToArray()));</span></span><br><span class="line">        <span class="comment">//memoryStream.Dispose();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>System.Net.Client</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HtmlAgilityPack.HtmlDocument document = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">using</span> (WebClient client = <span class="keyword">new</span> WebClient())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (Stream stream = client.OpenRead(<span class="string">&quot;https://www.jd.com/allsort.aspx&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        document = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">        document.Load(stream, Encoding.UTF8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>HtmlAgilityPack.HtmlWeb</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HtmlWeb web = <span class="keyword">new</span> HtmlWeb</span><br><span class="line">&#123;</span><br><span class="line">    OverrideEncoding = Encoding.UTF8</span><br><span class="line">&#125;;</span><br><span class="line">HtmlAgilityPack.HtmlDocument document = web.Load(<span class="string">&quot;https://www.jd.com/allsort.aspx&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="解析数据"><a href="#解析数据" class="headerlink" title="解析数据"></a>解析数据</h4><p>实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> JDId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> URL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Category&gt; listCategory = <span class="keyword">new</span> List&lt;Category&gt;();</span><br><span class="line"><span class="keyword">if</span> (document != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> iId = <span class="number">1</span>;<span class="comment">//编号</span></span><br><span class="line">    Regex regex = <span class="keyword">new</span> Regex(<span class="string">&quot;cat=(\\d+(\\,\\d+)*)&quot;</span>);<span class="comment">//匹配与提取类别ID正则</span></span><br><span class="line">    <span class="comment">//取出所有链接</span></span><br><span class="line">    HtmlNodeCollection collection = document.DocumentNode.SelectNodes(<span class="string">&quot;//a[@href]&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> collection)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//正则匹配出是商品类别的链接</span></span><br><span class="line">        Match match = regex.Match(item.Attributes[<span class="string">&quot;href&quot;</span>].Value.ToLower());</span><br><span class="line">        <span class="keyword">if</span> (match.Success)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//提取商品类别ID 商品类别链接 商品类别名称</span></span><br><span class="line">            listCategory.Add(<span class="keyword">new</span> Category() &#123; Id = iId++, JDId = match.Groups[<span class="number">1</span>].Value, Name = item.InnerText, URL = item.Attributes[<span class="string">&quot;href&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? item.Attributes[<span class="string">&quot;href&quot;</span>].Value : <span class="string">&quot;https:&quot;</span> + item.Attributes[<span class="string">&quot;href&quot;</span>].Value &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="抓取京东商品信息"><a href="#抓取京东商品信息" class="headerlink" title="抓取京东商品信息"></a>抓取京东商品信息</h2><h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><ul>
<li>选择一个商品类别页面分析<blockquote>
<p>Chrome浏览器打开页面：<a target="_blank" rel="noopener" href="https://list.jd.com/list.html?cat=1713,4855,4859">https://list.jd.com/list.html?cat=1713,4855,4859</a></p>
</blockquote>
</li>
<li>使用Chrome分析元素<blockquote>
<p>使用“F12 -&gt; Elements -&gt; 审查元素(Ctrl+Shift+C) -&gt; 右键 -&gt; Copy -&gt; Copy XPath”分析商品总页数、商品DIV解析的XPath语法</p>
</blockquote>
</li>
<li>换页分析不同页码连接特点<blockquote>
<p><code>GET</code> 参数 <code>page</code> 指定页面：<a target="_blank" rel="noopener" href="https://list.jd.com/list.html?cat=1713,4855,4859&amp;page=2">https://list.jd.com/list.html?cat=1713,4855,4859&amp;page=2</a></p>
</blockquote>
</li>
<li>获取数据<blockquote>
<p>同抓取商品类别</p>
</blockquote>
</li>
<li>解析数据<blockquote>
<p>使用 <code>HtmlAgilityPack.HtmlDocument</code> 解析商品信息</p>
</blockquote>
</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><h4 id="获取数据-1"><a href="#获取数据-1" class="headerlink" title="获取数据"></a>获取数据</h4><p>见类别获取部分实现。</p>
<h4 id="解析数据-1"><a href="#解析数据-1" class="headerlink" title="解析数据"></a>解析数据</h4><p>实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> JDId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ImageURL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> URL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (document != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取页码信息</span></span><br><span class="line">    <span class="built_in">string</span> sCurrentPager = <span class="built_in">string</span>.Empty;<span class="comment">//当前页数</span></span><br><span class="line">    <span class="built_in">string</span> sAllPager = <span class="built_in">string</span>.Empty;<span class="comment">//总页数</span></span><br><span class="line">    <span class="comment">//List&lt;Product&gt; listProduct = new List&lt;Product&gt;();//商品</span></span><br><span class="line">    <span class="comment">//获取页数信息</span></span><br><span class="line">    HtmlNodeCollection currentPagerNode = document.DocumentNode.SelectNodes(<span class="string">&quot;//*[@id=\&quot;J_topPage\&quot;]/span/b&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (currentPagerNode.Count != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;加载当前页码失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sCurrentPager = currentPagerNode[<span class="number">0</span>].InnerText;</span><br><span class="line">    &#125;</span><br><span class="line">    HtmlNodeCollection allPagersNode = document.DocumentNode.SelectNodes(<span class="string">&quot;//*[@id=\&quot;J_topPage\&quot;]/span/i&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (allPagersNode.Count != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;加载总页数失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sAllPager = allPagersNode[<span class="number">0</span>].InnerText;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取商品信息</span></span><br><span class="line">    <span class="built_in">int</span> iId = <span class="number">1</span>;<span class="comment">//编号</span></span><br><span class="line">    HtmlNodeCollection productNode = document.DocumentNode.SelectNodes(<span class="string">&quot;//*[@id=\&quot;plist\&quot;]/ul/li&quot;</span>);<span class="comment">//符合条件的商品XPath语法</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> productNode)</span><br><span class="line">    &#123;</span><br><span class="line">        Product product = <span class="keyword">new</span> Product();</span><br><span class="line">        HtmlAgilityPack.HtmlDocument tempDocument = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">        tempDocument.LoadHtml(item.OuterHtml);</span><br><span class="line">        <span class="comment">//商品图片链接</span></span><br><span class="line">        HtmlNodeCollection imageNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//*[@class=\&quot;p-img\&quot;]/a/img&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (imageNode.Count &gt; <span class="number">0</span> &amp;&amp; imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;src&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(imageNode[<span class="number">0</span>].Attributes   [<span class="string">&quot;src&quot;</span>].Value))<span class="comment">// 正常加载图片链接</span></span><br><span class="line">        &#123;</span><br><span class="line">            product.ImageURL = imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;src&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? imageNode[<span class="number">0</span>].Attributes [<span class="string">&quot;src&quot;</span>].Value :    <span class="string">&quot;https:&quot;</span> + imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;src&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (imageNode.Count &gt; <span class="number">0</span> &amp;&amp; imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-lazy-img&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(imageNode [<span class="number">0</span>].Attributes   [<span class="string">&quot;data-lazy-img&quot;</span>].Value))<span class="comment">//懒加载图片链接</span></span><br><span class="line">        &#123;</span><br><span class="line">            product.ImageURL = imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-lazy-img&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? imageNode[<span class="number">0</span>].Attributes   [<span class="string">&quot;data- lazy-img&quot;</span>].Value : <span class="string">&quot;https:&quot;</span> + imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-lazy-img&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品ID</span></span><br><span class="line">        HtmlNodeCollection idNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//li/div&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (idNode.Count &gt; <span class="number">0</span> &amp;&amp; idNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-sku&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(idNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-  sku&quot;</span>].Value))</span><br><span class="line">        &#123;</span><br><span class="line">            product.JDId = idNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-sku&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品名称</span></span><br><span class="line">        HtmlNodeCollection nameNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//*[@class=\&quot;p-name\&quot;]/a/em&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (nameNode.Count &gt; <span class="number">0</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(nameNode[<span class="number">0</span>].InnerText.Trim()))</span><br><span class="line">        &#123;</span><br><span class="line">            product.Name = nameNode[<span class="number">0</span>].InnerText.Trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品链接</span></span><br><span class="line">        HtmlNodeCollection urlNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//*[@class=\&quot;p-name\&quot;]/a&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (urlNode.Count &gt; <span class="number">0</span> &amp;&amp; urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value))</span><br><span class="line">        &#123;</span><br><span class="line">            product.URL = urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value :    <span class="string">&quot;https:&quot;</span>  + urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        product.Id = iId++;</span><br><span class="line">        listProduct.Add(product);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>图片懒加载，如果解析src属性可能解析不到，需要调试查看懒加载图片属性。</li>
<li>价格信息抓取会发现为空，观察会发现其calss属性为“J_price”，怀疑为ajax请求获取，下一部分说明获取方法。</li>
</ul>
<h2 id="抓取京东商品价格信息"><a href="#抓取京东商品价格信息" class="headerlink" title="抓取京东商品价格信息"></a>抓取京东商品价格信息</h2><h3 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h3><ul>
<li>使用Chrome分析网络请求<blockquote>
<p>使用“F12 -&gt; Network -&gt; JS”分析页面刷新时的ajax请求，发现：<a target="_blank" rel="noopener" href="https://p.3.cn/prices/mgets">https://p.3.cn/prices/mgets</a> 的请求，怀疑为查询价格的请求信息</p>
</blockquote>
</li>
<li>分析请求链接<blockquote>
<p>过滤GET参数，发现传递参数skuIds即可获取信息，多个用“%2C”分隔即可，例如：<a target="_blank" rel="noopener" href="https://p.3.cn/prices/mgets?skuIds=J_4609652,J_5830869">https://p.3.cn/prices/mgets?skuIds=J_4609652%2CJ_5830869</a> ，获取的数据位JSON格式</p>
</blockquote>
</li>
<li>获取数据<blockquote>
<p>同抓取商品类别</p>
</blockquote>
</li>
<li>解析数据<blockquote>
<p>使用 <code>Newtonsoft.Json</code> 解析(<code>Newtonsoft.Json</code> 可以通过 <code>nuget</code> 添加引用)</p>
</blockquote>
</li>
</ul>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><h4 id="获取数据-2"><a href="#获取数据-2" class="headerlink" title="获取数据"></a>获取数据</h4><p>见类别获取部分实现。</p>
<h4 id="解析数据-2"><a href="#解析数据-2" class="headerlink" title="解析数据"></a>解析数据</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通过京东商品ID获取价格</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;listJDId&quot;&gt;</span>商品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>商品ID对应价格的字典<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; <span class="title">GetPrice</span>(<span class="params">List&lt;<span class="built_in">string</span>&gt; listJDId</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; dicPrice = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">if</span> (listJDId.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//按照ajax请求连接格式拼接skuID</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; listJDId.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            listJDId[i] = <span class="string">&quot;J_&quot;</span> + listJDId[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//循环每10条查询一次 避免数量过多链接过长</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; (listJDId.Count + <span class="number">9</span>) / <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获取数据</span></span><br><span class="line">            HtmlAgilityPack.HtmlDocument document = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">            WebRequest request = WebRequest.Create(<span class="string">&quot;https://p.3.cn/prices/mgets?skuIds=&quot;</span> + <span class="built_in">string</span>.Join(<span class="string">&quot;%2C&quot;</span>, listJDId.Skip(i * <span class="number">10</span>).Take(<span class="number">10</span>)));</span><br><span class="line">            <span class="keyword">using</span> (Stream stream = request.GetResponse().GetResponseStream())</span><br><span class="line">            &#123;</span><br><span class="line">                document.Load(stream, Encoding.UTF8);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//解析数据</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(document.Text))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">object</span> oPrice = Newtonsoft.Json.JsonConvert.DeserializeObject(document.Text);<span class="comment">//转换成对象</span></span><br><span class="line">                <span class="keyword">if</span> (oPrice <span class="keyword">is</span> JArray)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> oPrice <span class="keyword">as</span> JArray)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (item <span class="keyword">is</span> JObject &amp;&amp; (item <span class="keyword">as</span> JObject).ContainsKey(<span class="string">&quot;id&quot;</span>) &amp;&amp; (item <span class="keyword">as</span> JObject).ContainsKey(<span class="string">&quot;p&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//提取符合条件的数据</span></span><br><span class="line">                            <span class="keyword">if</span> ((item <span class="keyword">as</span> JObject)[<span class="string">&quot;id&quot;</span>] <span class="keyword">is</span> JValue jId &amp;&amp; (item <span class="keyword">as</span> JObject)[<span class="string">&quot;p&quot;</span>] <span class="keyword">is</span> JValue jPrice &amp;&amp; listJDId.Contains(jId.Value.ToString()) &amp;&amp; !dicPrice.ContainsKey(jId.Value.ToString().TrimStart(<span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)))</span><br><span class="line">                            &#123;</span><br><span class="line">                                dicPrice.Add(jId.Value.ToString().TrimStart(<span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;_&#x27;</span>), jPrice.Value.ToString());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dicPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>若想使用jQuery选择器可以结合Fizzlerex使用：<a target="_blank" rel="noopener" href="https://archive.codeplex.com/?p=fizzlerex">https://archive.codeplex.com/?p=fizzlerex</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/implementing-a-simple-crawler-project-in-csharp/" data-id="cklc4t7xs001izuqmfv730hkv" data-title="C#中实现简单爬虫项目" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190407-kindle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/kindle/" class="article-date">
  <time class="dt-published" datetime="2019-04-07T10:17:37.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a>►<a class="article-category-link" href="/categories/%E6%97%A5%E5%BF%97/%E5%BC%80%E7%AE%B1/">开箱</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/kindle/">入手Kindle</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="“好读书”"><a href="#“好读书”" class="headerlink" title="“好读书”"></a>“好读书”</h2><p>从小到大，自认为自己是一个不爱看书的人（网文除外），但是身为一个程序员，誓要向<code>dalao</code>看齐的人一直想培养一个良好的阅读习惯。</p>
<p>在工作的前期曾经购置了很多书，包括<code>C#</code>、<code>JavaScript</code>、<code>Oracle</code>的工具书还有一些名著、散文、豆瓣推荐等很多书，但是因为不方便携带，很多都在搬家的过程中遗失了，或者带回老家垫桌脚了。</p>
<p>从那以后，每次京东和当当有活动，都要纠结着要不要再剁手买几本，最后都忍了，因为这些书并不方便携带，而且选择困难症的我经常会纠结外出的时候带哪本书好。</p>
<h2 id="“Kindle”软件"><a href="#“Kindle”软件" class="headerlink" title="“Kindle”软件"></a>“Kindle”软件</h2><p>Kindle其实已经流行了好多年，但是身边认识的小伙伴几乎没有上手过的，所以也只是听说，知道有个“墨水屏”的技术。</p>
<p>真正用Kindle，是因为之前在Telegram发现了一个群，每天都会分享一些好书。开始用一个PC版基于<code>Python</code>开发的阅读软件，但是体验不好，使用没多久就放弃了。后来想起来Kindle好像可以在PC或移动设备上安装，于是便下载体验了一下，不得不说——真香，在手机、平板、PC上都安装了Kindle的软件。</p>
<p>而在体验了一段时间，很正常的操作是，买了<code>Kindle Unlimited</code>电子书包月服务，而且买了一年，哈哈。</p>
<p>当然买了以后，也并没有老老实实读书，啃了一本《白鹿原》后，渐渐又回到了上班摸鱼下班摸鱼的生活。</p>
<h2 id="学习的“冲动”"><a href="#学习的“冲动”" class="headerlink" title="学习的“冲动”"></a>学习的“冲动”</h2><p>一直想系统的学习一下平时接触的技术，并且了解一些一直感兴趣的领域。</p>
<p>比如系统的看一下<code>JavaScript</code>、<code>C#</code>、<code>MVC</code>、<code>数据结构与算法</code>、<code>23种设计模式</code>等的工具书与教材。想要学习一下<code>Git</code>、<code>Docker</code>、<code>Python</code>、<code>PowerShell</code>等比较热门的技术。</p>
<p>这些书一般厚且贵，当然优选还是找电子书，先是在当当和京东选择了几本，但是后来想到了自己安装的Kindle，又放弃了下单。</p>
<p>纠结了很久，要不要买以及要不要考虑京东/iReader/当当家的电纸书阅读器，最终还在京东将Kindle加入了购物车。</p>
<h2 id="购置"><a href="#购置" class="headerlink" title="购置"></a>购置</h2><p>电子产品当然要在京东上购买才比较舒服，因为速度、售后、价格等服务上还是有一些优势的，而且……plus会员不能白买了。/(ㄒoㄒ)/~~</p>
<p>之前在知乎别人推荐，如果知识体验电纸书，推荐买入门版，但是为了“奖励”一下自己的上进心（钱都花了，不能白花一定要好好读书好好学习），果断——当然买不起3k+的版本，割肉买了32G的版本。</p>
<p>当然最终的价格是1288(买了个皮套)-50(plus会员满1200减50优惠券)，入手价格是1238。（买之前忘记比价看一下这个点买有没有亏，买之后上去查了一下，感觉还好，价格一直很稳定。）</p>
<h2 id="开箱"><a href="#开箱" class="headerlink" title="开箱"></a>开箱</h2><p>京东的服务就是快，上午十点下单，下午三点快递员就给我打了电话。当然比较不愉快的是之前都有送货上楼，这次居然让我去蜂巢自己取快递。😔</p>
<p>当然，Kindle的到来，开箱的喜悦，这些小插曲都是浮云哦。小心翼翼的开箱中……</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle1_1562726351240.jpg" alt="kindle1"></p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle2_1562726351248.jpg" alt="kindle2"></p>
<p>啊？忘记了两个快递包裹，因为顺便补充了一下洗面奶的存货，看到大的盒子想当然的以为是Kindle，结果并不是，于是开另外一个包裹。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle3_1562726351244.jpg" alt="kindle3"></p>
<p>包装很“节约”，盒子的大小感觉也就比Kindle本身大一点点。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle4_1562726351243.jpg" alt="kindle4"></p>
<p>盒子上的图形刚开始还以为是水渍，后来才发现原来是平时Kindle上见到的封面图。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle5_1562726351243.jpg" alt="kindle5"></p>
<p>一家人当然要整整齐齐的，6寸的大小和手掌的大小差不多，可以装进衣兜里。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle6_1562726351242.jpg" alt="kindle6"></p>
<p>刚开始以为那些提示是贴膜，差点把屏幕掀起来……直接开机就好了。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle7_1562726351247.jpg" alt="kindle7"></p>
<p>最终进系统就没什么好说的了，意料之中的延迟，可以接受。另外登录Amazon账号会有点问题，登录现有账号下面按钮显示的却是注册，而且回车以后一直提示失败，最终发现邮箱里躺着Amazon发送的“验证码”，用这个就可以登录。</p>
<h2 id="阅读体验"><a href="#阅读体验" class="headerlink" title="阅读体验"></a>阅读体验</h2><p>刚到手剩余“50%”的电量，在将阅读灯开了20+的情况下，使用了大概八九个小时。感觉在续航上，不太满意，我理想的是充满电工作30h左右。</p>
<p>后面充了电，并将阅读灯关了再使用一下看看没有开阅读灯的续航怎么样，比较不理解的是为什么电纸书阅读器这个体积不提升一下电池，1500mAh还是有一些进步空间的。</p>
<p>因为本身有些近视，所以使用电子设备喜欢靠屏幕很近观看，长时间用Kindle阅读，明显没有用手机或者电脑那种眩目的感觉，体验非常不错。</p>
<p>不多说了，去看书了。😄</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/kindle/" data-id="cklc4t7xo001dzuqm72rtgjym" data-title="入手Kindle" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kindle/" rel="tag">Kindle</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190407-23-design-patterns-and-common-design-patterns" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/23-design-patterns-and-common-design-patterns/" class="article-date">
  <time class="dt-published" datetime="2019-04-07T03:09:36.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/23-design-patterns-and-common-design-patterns/">23种设计模式与常用设计模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h3 id="设计模式-1"><a href="#设计模式-1" class="headerlink" title="设计模式"></a>设计模式</h3><p>设计模式(<code>Design Pattern</code>)是一套被反复使用、多数人知晓的、经过分类的、代码设计经验的总结。</p>
<p>目的是为了代码可重用性、让代码更容易被他人理解、保证代码可靠性。</p>
<h3 id="设计模式三大类型"><a href="#设计模式三大类型" class="headerlink" title="设计模式三大类型"></a>设计模式三大类型</h3><p>设计模式分为三种类型，共23类。</p>
<ul>
<li>创建型模式：创建型模式用来处理对象的创建过程，单例模式、抽象工厂模式、建造者模式、工厂模式、原型模式。</li>
<li>结构型模式：结构型模式用来处理类或者对象的组合，适配器模式、桥接模式、装饰模式、组合模式、外观模式、享元模式、代理模式。</li>
<li>行为型模式：行为型模式用来对类或对象怎样交互和怎样分配职责进行描述，模版方法模式、命令模式、迭代器模式、观察者模式、中介者模式、备忘录模式、解释器模式、状态模式、策略模式、职责链模式、访问者模式。</li>
</ul>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式(<code>Singleton Pattern</code>)保证系统中，应用该模式的类一个类只有一个实例。即一个类只有一个对象实例。</p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><h4 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h4><p>第一时间创建实例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 静态构造函数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *该方法由CLR保证，程序第一次使用这个类型前被调用，且只调用一次</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Singleton2</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">Singleton2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton2)&#125;</span>\t构造成功\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//测试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton2)&#125;</span>\t单例模式测试开始\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">        Singleton2 singleton = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = <span class="keyword">new</span> Singleton2();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton2)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 静态字段</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *该方法由CLR保证，程序第一次使用这个类型前被初始化，且只初始化一次</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Singleton3</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton3</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton3)&#125;</span>\t构造成功\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton3 _singleton = <span class="keyword">new</span> Singleton3();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton3 <span class="title">CreateInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> _singleton;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//测试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton3)&#125;</span>\t单例模式测试开始\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">        Singleton3 singleton = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = CreateInstance();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton3)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="懒汉式"><a href="#懒汉式" class="headerlink" title="懒汉式"></a>懒汉式</h4><p>需要才创建实例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 双if判断加锁</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *内层if判断保证单例模式</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *外层if判断避免加锁阻碍多线程运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *加锁避免多线程对象被多次创建</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Singleton1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t构造成功\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton1 _singleton = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> Singleton_Lock = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton1 <span class="title">CreateInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_singleton == <span class="literal">null</span>)<span class="comment">//不为空才去等待锁</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (Singleton_Lock)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t等待锁之后释放\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">                Thread.Sleep(<span class="number">500</span>);</span><br><span class="line">                <span class="keyword">if</span> (_singleton == <span class="literal">null</span>)<span class="comment">//保证不被重复创建</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _singleton = <span class="keyword">new</span> Singleton1();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t单例模式测试开始\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">        Singleton1 singleton = <span class="literal">null</span>;</span><br><span class="line">        List&lt;Task&gt; listTask = <span class="keyword">new</span> List&lt;Task&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            listTask.Add(Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = CreateInstance();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        Task.WaitAll(listTask.ToArray());</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = CreateInstance();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三种工厂模式"><a href="#三种工厂模式" class="headerlink" title="三种工厂模式"></a>三种工厂模式</h2><p>简单工厂、工厂方法、抽象工厂都属于设计模式中的创建型模式。其主要功能都是帮助我们把对象的实例化部分抽象取了出来，优化了系统的架构，并且增强了系统的扩展性。</p>
<h3 id="简单工厂"><a href="#简单工厂" class="headerlink" title="简单工厂"></a>简单工厂</h3><p>简单工厂(<code>Simple Factory</code>)：简单工厂模式的工厂类一般是使用静态方法，通过接收的参数不同来返回不同的对象实例。不修改代码的话，是无法扩展的。  </p>
<ul>
<li>优点：客户端可以免除直接创建产品对象的责任，而仅仅是“消费”产品。简单工厂模式通过这种做法实现了对责任的分割。</li>
<li>缺点：由于工厂类集中了所有实例的创建逻辑，违反了高内聚责任分配原则，将全部创建逻辑集中到了一个工厂类中；它所能创建的类只能是事先考虑到的，如果需要添加新的类，则就需要改变工厂类了。</li>
</ul>
<p>配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;BallType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Test.exe,Test.Factory.Basketball&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appSettings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实体与枚举</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sportsman</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sportsman</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">bool</span> gender, <span class="built_in">int</span> age, <span class="built_in">string</span> country</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Name = name;</span><br><span class="line">        Gender = gender;</span><br><span class="line">        Age = age;</span><br><span class="line">        Country = country;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Country &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlayGame</span>(<span class="params">IBall ball</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;You&#x27;re watching <span class="subst">&#123;ball.PlayGame()&#125;</span> The name of the sportsman is <span class="subst">&#123;Name&#125;</span>. <span class="subst">&#123;(Gender ? <span class="string">&quot;He&quot;</span> : <span class="string">&quot;She&quot;</span>)&#125;</span> is a <span class="subst">&#123;Age&#125;</span> years old <span class="subst">&#123;(Gender ? <span class="string">&quot;boy&quot;</span> : <span class="string">&quot;girl&quot;</span>)&#125;</span> from <span class="subst">&#123;Country&#125;</span>.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> BallType</span><br><span class="line">&#123;</span><br><span class="line">    Basketball,</span><br><span class="line">    Football,</span><br><span class="line">    Baseball,</span><br><span class="line">    Volleyball</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>简单工厂</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SimpleFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sportsman sportsman = <span class="keyword">new</span> Sportsman(<span class="string">&quot;Kangkang&quot;</span>, <span class="literal">true</span>, <span class="number">17</span>, <span class="string">&quot;China&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            Basketball basketball = <span class="keyword">new</span> Basketball();<span class="comment">//1.左右都是细节</span></span><br><span class="line">            sportsman.PlayGame(basketball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            IBall ball = <span class="keyword">new</span> Football();<span class="comment">//2.左边是抽象 右边是细节</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//遵循依赖倒置 但是违背了单一职责</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-转移细节********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallGame(BallType.Volleyball);<span class="comment">//3.没有细节 细节被转移</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//结合配置项+反射 IOC雏形</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-配置项********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallFromConfiguration();</span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> **集中了矛盾**</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 细节没有消失只是转移</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转移了矛盾并没有消除矛盾</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallGame</span>(<span class="params">BallType type</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IBall ball = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> BallType.Basketball:</span><br><span class="line">                ball = <span class="keyword">new</span> Basketball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Football:</span><br><span class="line">                ball = <span class="keyword">new</span> Football();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Baseball:</span><br><span class="line">                ball = <span class="keyword">new</span> Baseball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Volleyball:</span><br><span class="line">                ball = <span class="keyword">new</span> Volleyball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;unknown ball type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IOC的雏形</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallFromConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] aTemp = ConfigurationManager.AppSettings.Get(<span class="string">&quot;BallType&quot;</span>).Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        Assembly assembly = Assembly.LoadFrom(aTemp[<span class="number">0</span>]);</span><br><span class="line">        Type type = assembly.GetType(aTemp[<span class="number">1</span>]);</span><br><span class="line">        IBall ball = Activator.CreateInstance(type) <span class="keyword">as</span> IBall;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Baseball</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a baseball tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Football</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a football tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Baseball</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a baseball tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Volleyball</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a volleyball tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单工厂实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SimpleFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sportsman sportsman = <span class="keyword">new</span> Sportsman(<span class="string">&quot;Kangkang&quot;</span>, <span class="literal">true</span>, <span class="number">17</span>, <span class="string">&quot;China&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            Basketball basketball = <span class="keyword">new</span> Basketball();<span class="comment">//1.左右都是细节</span></span><br><span class="line">            sportsman.PlayGame(basketball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            IBall ball = <span class="keyword">new</span> Football();<span class="comment">//2.左边是抽象 右边是细节</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//遵循依赖倒置 但是违背了单一职责</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-转移细节********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallGame(BallType.Volleyball);<span class="comment">//3.没有细节 细节被转移</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//结合配置项+反射 IOC雏形</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-配置项********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallFromConfiguration();</span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> **集中了矛盾**</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 细节没有消失只是转移</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转移了矛盾并没有消除矛盾</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallGame</span>(<span class="params">BallType type</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IBall ball = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> BallType.Basketball:</span><br><span class="line">                ball = <span class="keyword">new</span> Basketball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Football:</span><br><span class="line">                ball = <span class="keyword">new</span> Football();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Baseball:</span><br><span class="line">                ball = <span class="keyword">new</span> Baseball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Volleyball:</span><br><span class="line">                ball = <span class="keyword">new</span> Volleyball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;unknown ball type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IOC的雏形</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallFromConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] aTemp = ConfigurationManager.AppSettings.Get(<span class="string">&quot;BallType&quot;</span>).Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        Assembly assembly = Assembly.LoadFrom(aTemp[<span class="number">0</span>]);</span><br><span class="line">        Type type = assembly.GetType(aTemp[<span class="number">1</span>]);</span><br><span class="line">        IBall ball = Activator.CreateInstance(type) <span class="keyword">as</span> IBall;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h3><p>工厂方法(<code>Factory Method</code>)：工厂方法是针对每一种产品提供一个工厂类。通过不同的工厂实例来创建不同的产品实例。在同一等级结构中，支持增加任意产品。</p>
<ul>
<li>优点：允许系统在不修改具体工厂角色的情况下引进新产品。</li>
<li>缺点：由于每加一个产品，就需要加一个产品工厂的类，增加了额外的开发量。</li>
</ul>
<p>提供工厂类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Baseball();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FootballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Football();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Baseball();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VolleyballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Volleyball();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>工厂方法实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FactoryMethod</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sportsman sportsman = <span class="keyword">new</span> Sportsman(<span class="string">&quot;Kangkang&quot;</span>, <span class="literal">true</span>, <span class="number">17</span>, <span class="string">&quot;China&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//每个业务对应一个工厂 将业务细节的依赖转移到中间层（工厂）</span></span><br><span class="line">            <span class="comment">//优点：允许系统在不修改具体工厂角色的情况下引进新产品</span></span><br><span class="line">            <span class="comment">//缺点：由于每加一个产品，就需要加一个产品工厂的类，增加了额外的开发量</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********工厂方法********&quot;</span>);</span><br><span class="line">            IFactory factory = <span class="keyword">new</span> BasketballFactory();</span><br><span class="line">            IBall ball = factory.CreateBall();</span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><p>抽象工厂(<code>Abstract Factory</code>)：抽象工厂是应对产品族概念的。应对产品族概念而生，增加新的产品线很容易，但是无法增加新的产品。比如，每个汽车公司可能要同时生产轿车、货车、客车，那么每一个工厂都要有创建轿车、货车和客车的方法。</p>
<ul>
<li>优点：向客户端提供一个接口，使得客户端在不必指定产品具体类型的情况下，创建多个产品族中的产品对象。</li>
<li>缺点：增加新的产品等级结构很复杂，需要修改抽象工厂和所有的具体工厂类，对“开闭原则”的支持呈现倾斜性。</li>
</ul>
<p>例如游戏加载需要英雄、资源、技能等</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbstractFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> IHero <span class="title">CreateHero</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ISkill <span class="title">CreateSkill</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> IResource <span class="title">CreateResource</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> IWeapon <span class="title">CreateWeapon</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IHero</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowHero</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISkill</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowSkill</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IResource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowResource</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IWeapon</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowWeapon</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h2><p>装饰器模式(Decorator Pattern)：允许向一个现有的对象添加新的功能，同时又不改变其结构。这种类型的设计模式属于结构型模式，它是作为现有的类的一个包装。这种模式创建了一个装饰类，用来包装原有的类，并在保持类方法签名完整性的前提下，提供了额外的功能。动态地给一个对象添加一些额外的职责。</p>
<p>就增加功能来说，装饰器模式相比生成子类更为灵活。一般的，我们为了扩展一个类经常使用继承方式实现，由于继承为类引入静态特征，并且随着扩展功能的增多，子类会很膨胀。</p>
<p><strong>类与类之间的关系：</strong> 纵向有继承和实现，横向有依赖、关联、组合、聚合。<strong>结构型设计模式：组合优于继承</strong>。</p>
<ul>
<li>优点：装饰类和被装饰类可以独立发展，不会相互耦合，装饰模式是继承的一个替代模式，装饰模式可以动态扩展一个实现类的功能。</li>
<li>缺点：多层装饰比较复杂。</li>
</ul>
<p>学生学习免费或付费课程享有不同的权利，除享受免费课程外，付费学生还有课前资料预习、课后作业指导、资料复习。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbstractStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        AbstractStudent student = <span class="keyword">new</span> VIPStudent() &#123; Id = <span class="number">999</span>, Name = <span class="string">&quot;Kangkang&quot;</span> &#125;;</span><br><span class="line">        student.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        StudentPreviewDecorator previewStudent = <span class="keyword">new</span> StudentPreviewDecorator(student);</span><br><span class="line">        previewStudent.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        AbstractStudent abstractStudent = <span class="keyword">new</span> StudentPreviewDecorator(student);</span><br><span class="line">        abstractStudent.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        student = <span class="keyword">new</span> StudentPayDecorator(student);</span><br><span class="line">        student = <span class="keyword">new</span> StudentPreviewDecorator(student);</span><br><span class="line">        student = <span class="keyword">new</span> StudentHomeworkDecorator(student);</span><br><span class="line">        student = <span class="keyword">new</span> StudentReviewDecorator(student);</span><br><span class="line">        student.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PoolStudent</span> : <span class="title">AbstractStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Take free courses.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VIPStudent</span> : <span class="title">AbstractStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Take free and paid courses.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继承也可以实现，但是不够灵活</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseStudentInherit</span> : <span class="title">VIPStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Pay.&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Preview.&quot;</span>);</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>付费、预习、作业、复习等装饰器</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentPayDecorator</span> : <span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentPayDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Pay.&quot;</span>);</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentPreviewDecorator</span> : <span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentPreviewDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Preview.&quot;</span>);</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentHomeworkDecorator</span> : <span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentHomeworkDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Do homework.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentReviewDecorator</span>:<span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentReviewDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Review.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>代理模式(<code>Proxy Pattern</code>)：一个类代表另一个类的功能，为其他对象提供一种代理以控制对这个对象的访问。主要解决在直接访问对象时带来的问题，比如说：要访问的对象在远程的机器上。</p>
<p>在面向对象系统中，有些对象由于某些原因（比如对象创建开销很大，或者某些操作需要安全控制，或者需要进程外的访问），直接访问会给使用者或者系统结构带来很多麻烦，我们可以在访问此对象时加上一个对此对象的访问层。</p>
<p>优点：</p>
<ul>
<li>职责清晰。 </li>
<li>高扩展性。</li>
<li>智能化。</li>
</ul>
<p>缺点：</p>
<ul>
<li>由于在客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢。</li>
<li>实现代理模式需要额外的工作，有些代理模式的实现非常复杂。</li>
</ul>
<p>代理模式：只能传达原有逻辑，不能新增业务逻辑。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">GetSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RealSubject</span> : <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Passenger by train.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">GetSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Passengers buy tickets.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProxySubject</span> : <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ISubject _subject = <span class="keyword">new</span> RealSubject();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Before do something.&quot;</span>);</span><br><span class="line">        <span class="built_in">bool</span> result = _subject.DoSomething();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;After do something.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">GetSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Before get something.&quot;</span>);</span><br><span class="line">        <span class="built_in">bool</span> result = _subject.GetSomething();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;After get something.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ISubject realSubject = <span class="keyword">new</span> RealSubject();</span><br><span class="line">        realSubject.GetSomething();</span><br><span class="line">        realSubject.DoSomething();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        ISubject proxySubject = <span class="keyword">new</span> ProxySubject();</span><br><span class="line">        proxySubject.GetSomething();</span><br><span class="line">        proxySubject.DoSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>观察者模式(<code>Observer Pattern</code>)：当对象间存在一对多关系时，则使用观察者模式。比如，当一个对象被修改时，则会自动通知它的依赖对象。</p>
<p>观察者模式属于行为型模式。定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</p>
<p>主要解决一个对象状态改变给其他对象通知的问题，而且要考虑到易用和低耦合，保证高度的协作。</p>
<p>优点：</p>
<ul>
<li>观察者和被观察者是抽象耦合的。</li>
<li>建立一套触发机制。</li>
</ul>
<p>缺点：</p>
<ul>
<li>如果一个被观察者对象有很多的直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间。</li>
<li>如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。 </li>
<li>观察者模式没有相应的机制让观察者知道所观察的目标对象是怎么发生变化的，而仅仅只是知道观察目标发生了变化。</li>
</ul>
<p>一只神奇的猫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 一直神奇的猫，猫叫之后触发：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Baby cry</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Brother turn</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Dog woof</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Father roar</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Mother whisper</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Mouse run</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Neighbor awake</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Stealer hide</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Cat</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Meow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> meow...&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> Brother().Turn();</span><br><span class="line">        <span class="keyword">new</span> Dog().Woof();</span><br><span class="line">        <span class="keyword">new</span> Father().Roar();</span><br><span class="line">        <span class="keyword">new</span> Mother().Whisper();</span><br><span class="line">        <span class="keyword">new</span> Mouse().Run();</span><br><span class="line">        <span class="keyword">new</span> Neighbor().Awake();</span><br><span class="line">        <span class="keyword">new</span> Stealer().Hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> Action MeowHandler;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MeowEvent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> meow...&quot;</span>);</span><br><span class="line">        MeowHandler?.Invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">List</span>&lt;<span class="title">IObserver</span>&gt; _listObserver</span> = <span class="keyword">new</span> List&lt;IObserver&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _listObserver.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Remove</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _listObserver.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MeowObserver</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> meow...&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _listObserver)</span><br><span class="line">        &#123;</span><br><span class="line">            item.Action();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************普通方法************&quot;</span>);</span><br><span class="line">        Cat cat = <span class="keyword">new</span> Cat();</span><br><span class="line">        cat.Meow();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************ 事  件 ************&quot;</span>);</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Brother().Turn();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Dog().Woof();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Father().Roar();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Mother().Whisper();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Mouse().Run();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Neighbor().Awake();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Stealer().Hide();</span><br><span class="line">        cat.MeowEvent();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************观 察 者************&quot;</span>);</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Brother());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Dog());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Father());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Mother());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Mouse());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Neighbor());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Stealer());</span><br><span class="line">        cat.MeowObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Baby</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Cry();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Cry</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> cry...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Brother</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Turn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Turn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> turn...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Dog</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Woof();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Woof</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> Woof...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Father</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Roar();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Roar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> roar...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mother</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Whisper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Whisper</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> whisper...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mouse</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> Run...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Neighbor</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Awake();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> awake...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Stealer</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Hide</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> hide...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/23-design-patterns-and-common-design-patterns/" data-id="cklc4t81i00d1zuqm9r5l2fa3" data-title="23种设计模式与常用设计模式" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190407-six-principles-of-design-mode" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/six-principles-of-design-mode/" class="article-date">
  <time class="dt-published" datetime="2019-04-07T02:48:40.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/six-principles-of-design-mode/">设计模式六大原则</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h2><p>（<code>Single Responsibility Principle</code> 简称 ：<code>SRP</code>）</p>
<p>定义：应该有且仅有一个原因引起类的变更。</p>
<p>接口的职责在设计时应该做到单一，降低类的复杂性，实现的职责都有明确的定义，提高了可读性、可维护性、可扩展性；</p>
<p>变更引起的风险降低，如果接口隔离性做的好，一个接口的修改只对相应实现类有影响，对其它接口没有影响，降低了耦合性。</p>
<blockquote>
<p>单一职责提出了一个编写程序的标准，用“职责”或“变化原因”来衡量接口或类设计的是否优良，但是“职责”或“变化原因”都是不可度量的，因项目而异，因环境而异。</p>
</blockquote>
<h2 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a>里氏替换原则</h2><p>（<code>Liskov Substitution Principle</code> 简称：<code>LSP</code>）</p>
<p>定义：是面向对象设计的基本原则之一，只要父类能出现的地方子类就能出现，而且替换为子类也不会产生任何错误或异常。</p>
<ul>
<li>子类必须完全实现父类的方法</li>
<li>子类可以有自己的个性</li>
<li>覆盖或实现父类的方法时输入参数可以被放大</li>
<li>覆盖或实现父类的方法时输出结果可以被缩小</li>
</ul>
<p>优点：</p>
<ul>
<li>代码共享，减少创建类的工作量</li>
<li>提高代码的重用性</li>
<li>子类可以形似父类，但又异于父类</li>
<li>提高代码的可扩展性</li>
<li>提高产品或项目的开放性</li>
</ul>
<p>缺点：</p>
<ul>
<li>继承是侵入性的，只要继承就必须拥有父类的所有属性和方法</li>
<li>降低代码的灵活性</li>
<li>增强了耦合性，父类的常量、变量、方法被修改时，要考虑到子类的修改，在缺乏规范的环境下，可能有许多代码需要重构。</li>
</ul>
<blockquote>
<p><code>LSP</code> 原则是继承复用的基石，只有当子类能够替换掉父类，软件单位功能不受影响时，父类才能被真正复用。<code>LSP</code> 原则是对开闭原则的补充，实现开闭原则的关键步骤就是抽象化，而父类与子类的继承关  系就是抽象化的具体实现，所以里氏代换原则是对实现抽象化的具体步骤的规范。</p>
</blockquote>
<h2 id="依赖倒置原则"><a href="#依赖倒置原则" class="headerlink" title="依赖倒置原则"></a>依赖倒置原则</h2><p>（<code>Dependence  Inversion Principle</code> 简称：<code>DIP</code>）</p>
<p>定义：是“面向接口编程” –面向对象设计的精髓之一，是六个原则中最难实现的一个原则，是实现开闭原则的重要途径。</p>
<ul>
<li>模块间的依赖通过抽象发生，实现类之间不发生直接的依赖关系，其依赖是通过接口和抽象类发生的</li>
<li>接口或抽象类不依赖于实现类</li>
<li>实现类依赖于接口或抽象类</li>
</ul>
<p>优点：</p>
<ul>
<li>可以减少类之间的耦合性，提高系统的稳定性</li>
<li>降低并行开发引起的风险</li>
<li>提高代码的可读性和可维护性</li>
</ul>
<p>依赖的三种写法：</p>
<ul>
<li>构造函数传递依赖对象</li>
<li>setter方法传递依赖对象</li>
<li>接口声明依赖对象</li>
</ul>
<p>本质是通过抽象使各个类或模块的实现彼此独立，不互相影响，实现模块间的松耦合，应遵循的原则：</p>
<ul>
<li>每个类尽量都有接口或抽象类</li>
<li>变量的表面类型尽量是接口或者抽象类</li>
<li>任何类都不应从具体类中派生</li>
<li>尽量不要复写基类的方法</li>
<li>结合里氏替换原则使用</li>
</ul>
<p>依赖倒置原则是设计模式；<br>控制反转(<code>IoC</code>:将组件间的依赖关系从程序内部提到外部来管理)是目的；<br>依赖注入(<code>DI</code>:将组件的依赖通过外部以参数或其他形式注入)是实现控制反转的方式。</p>
<h2 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h2><p>（<code>Interface Segregation Principle</code> 简称：<code>ISP</code>）</p>
<p>定义：客户端不应依赖它不需要的接口，类间的依赖关系应建立在最小的接口上（降低耦合度）</p>
<ul>
<li>接口尽量小（拆分接口时，首先必须满足单一职责原则）</li>
<li>接口要高内聚（尽量少公布 <code>public</code> 方法）</li>
<li>定制服务（模块间必然会有耦合，有耦合就要有相互访问的接口，设计时应为访问者提供定制服务）</li>
<li>接口的设计是有限度的（接口的设计粒度越小，接口越灵活，要把握一个度）</li>
</ul>
<p>实践中可根据以下几个规则衡量：</p>
<ul>
<li>一个接口只服务于一个子模块或业务逻辑</li>
<li>通过业务逻辑压缩接口中的public方法</li>
<li>已经被污染的接口，尽量去修改，若变更风险较大，则采用适配器模式进行转化处理</li>
<li>了解环境，拒绝盲从，环境不同，接口拆分的标准就不同，应深入了解业务逻辑，设计出灵活的接口</li>
</ul>
<h2 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h2><p>（<code>Law of Demeter</code> 简称：<code>LoD</code>）又称最少知识原则</p>
<p>定义：一个类应该对自己需要耦合或调用的类知道的最少</p>
<ul>
<li>只和直接的朋友交流</li>
<li>朋友之间也是有距离的</li>
<li>是自己的就是自己的（如果一个方法放在本类中，既不增加类间的关系，也对本类不产生负面影响，那就放在本类中）</li>
<li>谨慎使用 <code>Serializable</code> (远程调用传个vo，必须实现 <code>Serializable</code> 接口，如果有一天修改了访问权限，权限扩大了，但是服务器上没有做相应的变更，就会报序列化失败)</li>
</ul>
<h2 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h2><p>（Open-Closed Principle 简称：OCP）</p>
<p>定义：对扩展开放，对修改关闭，在程序需要扩展的时候，不能修改原有的代码，实现热插拔的效果。为了使程序的扩展性好，易于维护和升级，需要使用接口和抽象类。  </p>
<p>注意事项：</p>
<ul>
<li>通过对接口或者抽象类约束扩展，对扩展进行边界限定，不允许出现在接口或抽象类中不存在的public方法</li>
<li>参数类型、引用对象尽量使用接口或抽象类，而不是实现类</li>
<li>抽象层尽量保持稳定，一旦确定不允许修改</li>
</ul>
<p>如何使用：</p>
<ul>
<li>抽象约束（实现对扩展开放的首要前提，对扩展进行边界限定）</li>
<li>元数据控制模块行为</li>
<li>制定项目章程（对项目来说，规定优于配置）</li>
<li>封装变化<ul>
<li>将相同的变化封装到一个接口或抽象类中；</li>
<li>将不同的变化封装到不同的接口或抽象类中；</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/six-principles-of-design-mode/" data-id="cklc4t7xp001fzuqm3508g6rk" data-title="设计模式六大原则" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/C/ASP-NET-Core/">ASP.NET Core</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/C/WPF/">WPF</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1/">业务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/Oracle/">Oracle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/SQLite/">SQLite</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%9D%82%E8%B0%88/">杂谈</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MacOS/">MacOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BD%AF%E4%BB%B6/">软件</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/%E5%85%AC%E5%91%8A/">公告</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/%E5%BC%80%E7%AE%B1/">开箱</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/%E6%9D%82%E8%B0%88/">杂谈</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET-Standard/" rel="tag">.NET Standard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/" rel="tag">AOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASCII/" rel="tag">ASCII</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveX/" rel="tag">ActiveX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Attribute/" rel="tag">Attribute</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Autofac/" rel="tag">Autofac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BFG/" rel="tag">BFG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCProxy/" rel="tag">CCProxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DBeaver/" rel="tag">DBeaver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Expression/" rel="tag">Expression</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fody/" rel="tag">Fody</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDI/" rel="tag">GDI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/" rel="tag">GitHub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitea/" rel="tag">Gitea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HIS/" rel="tag">HIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HongYang/" rel="tag">HongYang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDE/" rel="tag">IDE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IE/" rel="tag">IE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jint/" rel="tag">Jint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/" rel="tag">Json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kindle/" rel="tag">Kindle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LIS/" rel="tag">LIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LODOP/" rel="tag">LODOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC/" rel="tag">MVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/" rel="tag">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NHibernate/" rel="tag">NHibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nexus3/" rel="tag">Nexus3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Note/" rel="tag">Note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NuGet/" rel="tag">NuGet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/" rel="tag">OOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SOA/" rel="tag">SOA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/" rel="tag">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/" rel="tag">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Telegram/" rel="tag">Telegram</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TreeView/" rel="tag">TreeView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tuple/" rel="tag">Tuple</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/" rel="tag">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UML/" rel="tag">UML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VS/" rel="tag">VS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/" rel="tag">VSCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ValueTuple/" rel="tag">ValueTuple</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WCF/" rel="tag">WCF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WPF/" rel="tag">WPF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebApi/" rel="tag">WebApi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebService/" rel="tag">WebService</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WinForm/" rel="tag">WinForm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/" rel="tag">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows-XP/" rel="tag">Windows XP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xml/" rel="tag">Xml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decimal/" rel="tag">decimal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/frp/" rel="tag">frp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdbc/" rel="tag">jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mstsc/" rel="tag">mstsc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%B2%E5%8F%A3/" rel="tag">串口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" rel="tag">依赖注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%83%E7%BB%84/" rel="tag">元组</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E5%AF%86/" rel="tag">加密</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/" rel="tag">动态链接库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%B0%84/" rel="tag">反射</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A7%94%E6%89%98/" rel="tag">委托</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B4%E9%BE%84/" rel="tag">年龄</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">序列化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%83%E5%85%83/" rel="tag">弃元</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8D%B0/" rel="tag">打印</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E5%BF%97/" rel="tag">日志</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/" rel="tag">构造函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/" rel="tag">析构函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%9A%E4%B8%BE/" rel="tag">枚举</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99/" rel="tag">正则</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%9B%E5%9E%8B/" rel="tag">泛型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%91%9E%E7%BE%8E/" rel="tag">瑞美</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A1%80%E7%90%83%E4%BB%AA/" rel="tag">血球仪</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%A3%E6%9E%84%E5%87%BD%E6%95%B0/" rel="tag">解构函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9D%E5%85%8B%E6%9B%BC/" rel="tag">贝克曼</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BA%AB%E4%BB%BD%E8%AF%81%E8%AF%BB%E5%8D%A1/" rel="tag">身份证读卡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6/" rel="tag">软件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9C%E7%A8%8B/" rel="tag">远程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AA%E9%80%80/" rel="tag">闪退</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Standard/" style="font-size: 10px;">.NET Standard</a> <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/ASCII/" style="font-size: 10px;">ASCII</a> <a href="/tags/ActiveX/" style="font-size: 10px;">ActiveX</a> <a href="/tags/Attribute/" style="font-size: 10px;">Attribute</a> <a href="/tags/Autofac/" style="font-size: 10px;">Autofac</a> <a href="/tags/BFG/" style="font-size: 10px;">BFG</a> <a href="/tags/CCProxy/" style="font-size: 10px;">CCProxy</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/DBeaver/" style="font-size: 12.5px;">DBeaver</a> <a href="/tags/Expression/" style="font-size: 10px;">Expression</a> <a href="/tags/Fody/" style="font-size: 10px;">Fody</a> <a href="/tags/GDI/" style="font-size: 10px;">GDI</a> <a href="/tags/Git/" style="font-size: 12.5px;">Git</a> <a href="/tags/GitHub/" style="font-size: 12.5px;">GitHub</a> <a href="/tags/Gitea/" style="font-size: 10px;">Gitea</a> <a href="/tags/HIS/" style="font-size: 12.5px;">HIS</a> <a href="/tags/HongYang/" style="font-size: 10px;">HongYang</a> <a href="/tags/IDE/" style="font-size: 10px;">IDE</a> <a href="/tags/IE/" style="font-size: 10px;">IE</a> <a href="/tags/JavaScript/" style="font-size: 12.5px;">JavaScript</a> <a href="/tags/Jint/" style="font-size: 12.5px;">Jint</a> <a href="/tags/Json/" style="font-size: 10px;">Json</a> <a href="/tags/Kindle/" style="font-size: 10px;">Kindle</a> <a href="/tags/LIS/" style="font-size: 15px;">LIS</a> <a href="/tags/LODOP/" style="font-size: 10px;">LODOP</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/Math/" style="font-size: 10px;">Math</a> <a href="/tags/NHibernate/" style="font-size: 10px;">NHibernate</a> <a href="/tags/Nexus3/" style="font-size: 10px;">Nexus3</a> <a href="/tags/Note/" style="font-size: 10px;">Note</a> <a href="/tags/NuGet/" style="font-size: 10px;">NuGet</a> <a href="/tags/OOP/" style="font-size: 10px;">OOP</a> <a href="/tags/Oracle/" style="font-size: 10px;">Oracle</a> <a href="/tags/SOA/" style="font-size: 17.5px;">SOA</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Telegram/" style="font-size: 10px;">Telegram</a> <a href="/tags/TreeView/" style="font-size: 10px;">TreeView</a> <a href="/tags/Tuple/" style="font-size: 10px;">Tuple</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/UML/" style="font-size: 10px;">UML</a> <a href="/tags/Unity/" style="font-size: 10px;">Unity</a> <a href="/tags/VS/" style="font-size: 10px;">VS</a> <a href="/tags/VSCode/" style="font-size: 10px;">VSCode</a> <a href="/tags/ValueTuple/" style="font-size: 10px;">ValueTuple</a> <a href="/tags/WCF/" style="font-size: 12.5px;">WCF</a> <a href="/tags/WPF/" style="font-size: 10px;">WPF</a> <a href="/tags/WebApi/" style="font-size: 15px;">WebApi</a> <a href="/tags/WebService/" style="font-size: 15px;">WebService</a> <a href="/tags/WinForm/" style="font-size: 10px;">WinForm</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Windows-XP/" style="font-size: 12.5px;">Windows XP</a> <a href="/tags/Xml/" style="font-size: 10px;">Xml</a> <a href="/tags/decimal/" style="font-size: 10px;">decimal</a> <a href="/tags/frp/" style="font-size: 10px;">frp</a> <a href="/tags/jdbc/" style="font-size: 10px;">jdbc</a> <a href="/tags/mstsc/" style="font-size: 10px;">mstsc</a> <a href="/tags/%E4%B8%B2%E5%8F%A3/" style="font-size: 10px;">串口</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 12.5px;">代理</a> <a href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">依赖注入</a> <a href="/tags/%E5%85%83%E7%BB%84/" style="font-size: 12.5px;">元组</a> <a href="/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 10px;">加密</a> <a href="/tags/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/" style="font-size: 10px;">动态链接库</a> <a href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 10px;">反射</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 20px;">多线程</a> <a href="/tags/%E5%A7%94%E6%89%98/" style="font-size: 10px;">委托</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E5%B9%B4%E9%BE%84/" style="font-size: 10px;">年龄</a> <a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 10px;">序列化</a> <a href="/tags/%E5%BC%83%E5%85%83/" style="font-size: 10px;">弃元</a> <a href="/tags/%E6%89%93%E5%8D%B0/" style="font-size: 10px;">打印</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 10px;">日志</a> <a href="/tags/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/" style="font-size: 10px;">构造函数</a> <a href="/tags/%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/" style="font-size: 10px;">析构函数</a> <a href="/tags/%E6%9E%9A%E4%B8%BE/" style="font-size: 10px;">枚举</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 15px;">正则</a> <a href="/tags/%E6%B3%9B%E5%9E%8B/" style="font-size: 12.5px;">泛型</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 10px;">爬虫</a> <a href="/tags/%E7%91%9E%E7%BE%8E/" style="font-size: 10px;">瑞美</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 12.5px;">虚拟机</a> <a href="/tags/%E8%A1%80%E7%90%83%E4%BB%AA/" style="font-size: 10px;">血球仪</a> <a href="/tags/%E8%A7%A3%E6%9E%84%E5%87%BD%E6%95%B0/" style="font-size: 10px;">解构函数</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12.5px;">设计模式</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E8%B4%9D%E5%85%8B%E6%9B%BC/" style="font-size: 10px;">贝克曼</a> <a href="/tags/%E8%BA%AB%E4%BB%BD%E8%AF%81%E8%AF%BB%E5%8D%A1/" style="font-size: 10px;">身份证读卡</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">软件</a> <a href="/tags/%E8%BF%9C%E7%A8%8B/" style="font-size: 10px;">远程</a> <a href="/tags/%E9%97%AA%E9%80%80/" style="font-size: 10px;">闪退</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 10px;">项目</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/back-in-2020/">回顾2020年</a>
          </li>
        
          <li>
            <a href="/csharp-expression-script-evaluation-problems/">C# 中表达式计算问题</a>
          </li>
        
          <li>
            <a href="/aspnet-core-001-source-code-compilation-and-debugging/">ASP.NET Core - 001 源码编译与调试</a>
          </li>
        
          <li>
            <a href="/aspnet-core-000-development-environment-configuration/">ASP.NET Core - 000 开发环境配置</a>
          </li>
        
          <li>
            <a href="/dotnet-core-migration-web-service/">迁移 Web Service 项目到 .NET Core</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 hd2y<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>