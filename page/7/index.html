<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>华灯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="盈月舞清风，华灯自摇曳。">
<meta property="og:type" content="website">
<meta property="og:title" content="华灯">
<meta property="og:url" content="https://hd2y.github.io/page/7/index.html">
<meta property="og:site_name" content="华灯">
<meta property="og:description" content="盈月舞清风，华灯自摇曳。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="hd2y">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="华灯" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">华灯</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hd2y.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-190521-the-debugging-and-development-of-serial-communication" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/the-debugging-and-development-of-serial-communication/" class="article-date">
  <time class="dt-published" datetime="2019-05-21T09:44:00.000Z" itemprop="datePublished">2019-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/the-debugging-and-development-of-serial-communication/">串口通讯调试与开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>工作中，LIS系统经常需要开发接口与仪器或流水线对接，串口通讯应该是最常见的几种通讯方式之一了。</p>
<p>至于串口是什么、串口通讯又是什么，这些基本概念就不多做介绍了。</p>
<p>这里就针对于我在串口开发中碰到过的一些问题，做一个简单的分享。</p>
<h2 id="串口模拟"><a href="#串口模拟" class="headerlink" title="串口模拟"></a>串口模拟</h2><p>无论是开发还是测试，肯定都离不开串口的模拟测试，我们不大可能直接在电脑上安装两个串口，所以模拟串口就是最优解了，从网上可以很轻松的搜索到模拟串口的软件。</p>
<p>这里我建议使用<code>Virtual Serial Port Driver</code>，大家可以搜索<code>VSPD</code>下载：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport0_1562753721959.png" alt="serialport0"></p>
<p>安装什么的就不过多解释了，安装完成后我们可以打开并添加模拟串口或者删除模拟的串口，界面如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport1_1562753721959.png" alt="serialport1"></p>
<p>如果对应的串口被使用，也可以从这里看出其串口的状态：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport2_1562753721959.png" alt="serialport2"></p>
<p>当然我们可以在我们的电脑中查看现有的串口，设备管理器中可以查看：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport3_1562753721967.png" alt="serialport3"></p>
<h2 id="串口调试工具"><a href="#串口调试工具" class="headerlink" title="串口调试工具"></a>串口调试工具</h2><p>串口调试工具就是用于串口数据接收/发送的工具软件，比较简单易用的是“串口调试助手V2.2”。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport4_1562753721978.png" alt="serialport4"></p>
<p>但是使用中有几点需要注意：</p>
<ol>
<li>偶尔会发生崩溃，这是串口调试工具的问题；</li>
<li>只能使用COM1-COM4这几个串口，有局限性；</li>
<li>与某些需要检测串口监听状态的仪器连接，虽然已经打开串口但是可能仪器仍然提示连接失败；</li>
</ol>
<p>如果碰到以上问题，那就只能只能自己找解决方案，另外如果具备一定开发经验后，建议根据自身需求来定制自己的串口调试工具，可以避免以上问题。</p>
<h2 id="串口监视精灵"><a href="#串口监视精灵" class="headerlink" title="串口监视精灵"></a>串口监视精灵</h2><p>除了串口调试助手以外，另外比较推荐的工具就是串口监视精灵了，顾名思义其就是类似于网口通讯中的抓包工具。</p>
<p>当初从网上找到这个工具的原因是之前LIS系统替换第三方LIS系统，有一个仪器的双工接口开发一直存在问题，所以想看一下第三方LIS怎么实现的双工通讯消息的交互。</p>
<p>当然如果开发的串口通讯工具中没有输出日志，也可以使用该工具进行监听。</p>
<p>一般我们网上能够找到的分为无DLL版和安装版，这里建议使用安装版。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport5_1562753721992.png" alt="serialport5"></p>
<p>上图为无Dll版，需要选择监听串口所在的进程，中文会乱码，能监听到串口的关闭但是打开的事件则没有输出。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport6_1562753722038.png" alt="serialport6"></p>
<p>上图是安装版，使用安装版需要注意如果系统是x64，第一次使用需要点击软件界面上的“启用64位系统驱动签名”，另外重启。如果监听不到数据，尝试先关闭通讯软件，打开监听后再打开通讯软件。</p>
<p>安装版能够监听到的数据就更完整一些，且每次数据的收发都统一显示为一条记录，这就比无Dll版本的更加友好，但是同样存在的问题是因为是ASC编码所以中文仍然是乱码，需要自己使用HEX编码进行转换。</p>
<p>另外安装版也附带有一个串口调试工具可以使用：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport7_1562753722078.png" alt="serialport7"></p>
<h2 id="串口通讯开发"><a href="#串口通讯开发" class="headerlink" title="串口通讯开发"></a>串口通讯开发</h2><h3 id="获取当前电脑的串口"><a href="#获取当前电脑的串口" class="headerlink" title="获取当前电脑的串口"></a>获取当前电脑的串口</h3><p>引入<code>System.IO.Ports</code>命名空间，然后可以使用<code>SerialPort.GetPortNames()</code>获取当前电脑的所有串行端口名称。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO.Ports;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SerialPortTestConsole</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">string</span>[] ports = SerialPort.GetPortNames();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="built_in">string</span> port <span class="keyword">in</span> ports)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(port);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="串口数据收发"><a href="#串口数据收发" class="headerlink" title="串口数据收发"></a>串口数据收发</h3><p>引入<code>System.IO.Ports</code>命名空间，然后实例化<code>SerialPort</code>对象，使用<code>Open</code>方法打开串口，<code>DataReceived</code>事件进行数据接收，<code>Write</code>方法可以进行数据发送。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO.Ports;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SerialPortTestConsole</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//注意：以下为串口初始化常用的属性，赋值为默认值，如果没有赋值属性默认也是这些值</span></span><br><span class="line">            SerialPort port = <span class="keyword">new</span> SerialPort()</span><br><span class="line">            &#123;</span><br><span class="line">                PortName = <span class="string">&quot;COM1&quot;</span>,<span class="comment">//端口号</span></span><br><span class="line">                BaudRate = <span class="number">9600</span>,<span class="comment">//波特率</span></span><br><span class="line">                DataBits = <span class="number">8</span>,<span class="comment">//数据位</span></span><br><span class="line">                Parity = Parity.None,<span class="comment">//校验位</span></span><br><span class="line">                StopBits = StopBits.One,<span class="comment">//停止位</span></span><br><span class="line">                Encoding = Encoding.ASCII,<span class="comment">//文本转换编码</span></span><br><span class="line">                WriteBufferSize = <span class="number">2048</span>,<span class="comment">//输出缓存</span></span><br><span class="line">                ReadBufferSize = <span class="number">4096</span>,<span class="comment">//输入缓存</span></span><br><span class="line">                WriteTimeout = <span class="number">-1</span>,<span class="comment">//写超时</span></span><br><span class="line">                ReadTimeout = <span class="number">-1</span>,<span class="comment">//读超时</span></span><br><span class="line">                RtsEnable = <span class="literal">false</span>,<span class="comment">//RTS信号：建议启用</span></span><br><span class="line">                DtrEnable = <span class="literal">false</span>,<span class="comment">//DTR信号：建议启用</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//数据接收事件 输出到控制台</span></span><br><span class="line">            port.DataReceived += <span class="keyword">new</span> SerialDataReceivedEventHandler((sender, e) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (port.BytesToRead &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> length = port.BytesToRead;</span><br><span class="line">                    <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[length];</span><br><span class="line">                    port.Read(buffer, <span class="number">0</span>, length);</span><br><span class="line">                    Console.WriteLine(port.Encoding.GetString(buffer));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//打开串口</span></span><br><span class="line">            <span class="keyword">if</span> (!port.IsOpen)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    port.Open();</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;串口打开成功：<span class="subst">&#123;port.PortName&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception exception)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;打开串口失败：<span class="subst">&#123;exception.Message&#125;</span>&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (port.IsOpen)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//输入串口发送内容</span></span><br><span class="line">                <span class="built_in">string</span> input = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">do</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;请输入要发送的内容：&quot;</span>);</span><br><span class="line">                    input = Console.ReadLine();</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">byte</span>[] buffer = port.Encoding.GetBytes(input);</span><br><span class="line">                        port.Write(buffer, <span class="number">0</span>, buffer.Length);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.IsNullOrEmpty(input));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//关闭串口释放资源</span></span><br><span class="line">                port.Close();</span><br><span class="line">            &#125;</span><br><span class="line">            port.Dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一个简单的调试工具"><a href="#一个简单的调试工具" class="headerlink" title="一个简单的调试工具"></a>一个简单的调试工具</h3><p>通过以上例子基本上对串口数据手法有个简单的了解，这里我们设计一个工具，来实现串口调试工具的基本功能。</p>
<p><code>SerialPort</code>的属性/方法/事件基本没有什么好说的了，这里主要需要了解HEX数据的转换：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 字符串拓展方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">StringExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将指定字符串转换为十六进制Hex字符串形式。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>要转换的原始字符串。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span>编码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>转换后的内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToHex</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> input, Encoding e = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        e = e ?? Encoding.UTF8;</span><br><span class="line">        <span class="built_in">byte</span>[] byteArray = e.GetBytes(input);</span><br><span class="line">        <span class="keyword">return</span> BitConverter.ToString(byteArray).Replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将十六进制Hex字符串转换为原始字符串。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>十六进制字符串内容<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span>编码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>原始字符串内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ReHex</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> input, Encoding e = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        e = e ?? Encoding.UTF8;</span><br><span class="line">        input = Regex.Replace(input, <span class="string">&quot;[^0-9A-F]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (input.Length &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="built_in">byte</span>[] vBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[input.Length / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vBytes.Length; i++)</span><br><span class="line">            vBytes[i] = <span class="built_in">byte</span>.Parse(input.Substring(i * <span class="number">2</span>, <span class="number">2</span>), NumberStyles.HexNumber);</span><br><span class="line">        <span class="keyword">return</span> e.GetString(vBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将十六进制Hex字符串转换为二进制数据。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>十六进制字符串内容<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>原始字符串内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">ReHexToBuffer</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> input</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        input = Regex.Replace(input, <span class="string">&quot;[^0-9A-F]&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">byte</span>[] vBytes = <span class="keyword">new</span> <span class="built_in">byte</span>[input.Length / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vBytes.Length; i++)</span><br><span class="line">            vBytes[i] = <span class="built_in">byte</span>.Parse(input.Substring(i * <span class="number">2</span>, <span class="number">2</span>), NumberStyles.HexNumber);</span><br><span class="line">        <span class="keyword">return</span> vBytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 二进制数据拓展方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">BufferExtension</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 将指定二进制数据转换为十六进制Hex字符串形式。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>要转换的二进制数据。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>转换后的内容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToHex</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">byte</span>[] input</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> BitConverter.ToString(input).Replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就是简单实现后的效果：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/serialport8_1562753722104.png" alt="serialport8"></p>
<p>源代码下载：<a target="_blank" rel="noopener" href="https://github.com/hd2y/SerialPortTest">https://github.com/hd2y/SerialPortTest</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/the-debugging-and-development-of-serial-communication/" data-id="ckn5z34c4001q15qc8bsn6ifz" data-title="串口通讯调试与开发" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%B2%E5%8F%A3/" rel="tag">串口</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190521-how-to-repair-corrupted-sqlite-database-files" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/how-to-repair-corrupted-sqlite-database-files/" class="article-date">
  <time class="dt-published" datetime="2019-05-21T03:39:38.000Z" itemprop="datePublished">2019-05-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/SQLite/">SQLite</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/how-to-repair-corrupted-sqlite-database-files/">如何修复损坏的SQLite数据库文件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近处理过一个SQLite数据库因为未知原因损坏，无法进行数据操作的而导致软件无法正常使用的问题。</p>
<p>虽然工具软件是基于<code>Code First</code>开发，可以直接删除数据库来重新生成数据文件，但是因为里面存储了很多基本参数，运维人员认为重新设置这些参数比较麻烦，所以希望能够提供一个方案来修复已经损坏的数据库。</p>
<p>和运维沟通后将数据库文件导回，尝试跟踪问题。从网上查询到解决方案，这里简单做一个记录。</p>
<h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><p>使用SQLite数据库管理工具<code>SQLite Studio</code>进行数据查询操作，访问正常，尝试直接删除某一个表的数据出现如下错误提示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[10:42:22] Error while executing SQL query on database &#x27;data&#x27;: database disk image is malformed</span><br></pre></td></tr></table></figure>
<p>从网上查找如何排查错误，发现一个语句可以对SQLite数据库进行检测：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA integrity_check;</span><br></pre></td></tr></table></figure>
<p>以上语句是执行整个库的完全性检查，会查看错序的记录、丢失的页，毁坏的索引等。 </p>
<p>执行后我获得的信息是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">&quot;*** in database main ***</span><br><span class="line">Main freelist: freelist leaf count too big on page 138339</span><br><span class="line">Main freelist: invalid page number 218103808</span><br><span class="line">On tree page 42 cell 176: 2nd reference to page 138339</span><br><span class="line">Page 18 is never used</span><br><span class="line">Page 20 is never used</span><br><span class="line">Page 23 is never used</span><br><span class="line">Page 25 is never used</span><br><span class="line">Page 26 is never used</span><br><span class="line">Page 27 is never used</span><br><span class="line">Page 28 is never used</span><br><span class="line">Page 29 is never used</span><br><span class="line">Page 30 is never used</span><br><span class="line">Page 31 is never used</span><br><span class="line">Page 32 is never used</span><br><span class="line">Page 33 is never used</span><br><span class="line">Page 34 is never used</span><br><span class="line">Page 35 is never used</span><br><span class="line">Page 36 is never used</span><br><span class="line">Page 37 is never used</span><br><span class="line">Page 38 is never used</span><br><span class="line">Page 39 is never used</span><br><span class="line">Page 40 is never used</span><br><span class="line">Page 41 is never used</span><br><span class="line">Page 43 is never used</span><br><span class="line">Page 44 is never used</span><br><span class="line">Page 45 is never used</span><br><span class="line">Page 46 is never used</span><br><span class="line">Page 47 is never used</span><br><span class="line">Page 48 is never used</span><br><span class="line">Page 49 is never used</span><br><span class="line">Page 50 is never used</span><br><span class="line">Page 51 is never used</span><br><span class="line">Page 52 is never used</span><br><span class="line">Page 53 is never used</span><br><span class="line">Page 54 is never used</span><br><span class="line">Page 55 is never used</span><br><span class="line">Page 56 is never used</span><br><span class="line">Page 57 is never used</span><br><span class="line">Page 58 is never used</span><br><span class="line">Page 59 is never used</span><br><span class="line">Page 60 is never used</span><br><span class="line">Page 61 is never used</span><br><span class="line">Page 62 is never used</span><br><span class="line">Page 63 is never used</span><br><span class="line">Page 64 is never used</span><br><span class="line">Page 65 is never used</span><br><span class="line">Page 66 is never used</span><br><span class="line">Page 67 is never used</span><br><span class="line">Page 68 is never used</span><br><span class="line">Page 69 is never used</span><br><span class="line">Page 70 is never used</span><br><span class="line">Page 71 is never used</span><br><span class="line">Page 73 is never used</span><br><span class="line">Page 74 is never used</span><br><span class="line">Page 75 is never used</span><br><span class="line">Page 76 is never used</span><br><span class="line">Page 77 is never used</span><br><span class="line">Page 78 is never used</span><br><span class="line">Page 79 is never used</span><br><span class="line">Page 80 is never used</span><br><span class="line">Page 81 is never used</span><br><span class="line">Page 82 is never used</span><br><span class="line">Page 83 is never used</span><br><span class="line">Page 84 is never used</span><br><span class="line">Page 85 is never used</span><br><span class="line">Page 86 is never used</span><br><span class="line">Page 88 is never used</span><br><span class="line">Page 89 is never used</span><br><span class="line">Page 90 is never used</span><br><span class="line">Page 91 is never used</span><br><span class="line">Page 92 is never used</span><br><span class="line">Page 93 is never used</span><br><span class="line">Page 94 is never used</span><br><span class="line">Page 95 is never used</span><br><span class="line">Page 96 is never used</span><br><span class="line">Page 97 is never used</span><br><span class="line">Page 98 is never used</span><br><span class="line">Page 99 is never used</span><br><span class="line">Page 100 is never used</span><br><span class="line">Page 101 is never used</span><br><span class="line">Page 102 is never used</span><br><span class="line">Page 103 is never used</span><br><span class="line">Page 104 is never used</span><br><span class="line">Page 105 is never used</span><br><span class="line">Page 106 is never used</span><br><span class="line">Page 107 is never used</span><br><span class="line">Page 108 is never used</span><br><span class="line">Page 110 is never used</span><br><span class="line">Page 111 is never used</span><br><span class="line">Page 112 is never used</span><br><span class="line">Page 113 is never used</span><br><span class="line">Page 114 is never used</span><br><span class="line">Page 115 is never used</span><br><span class="line">Page 116 is never used</span><br><span class="line">Page 117 is never used</span><br><span class="line">Page 118 is never used</span><br><span class="line">Page 119 is never used</span><br><span class="line">Page 120 is never used</span><br><span class="line">Page 121 is never used</span><br><span class="line">Page 122 is never used&quot;</span><br></pre></td></tr></table></figure>
<p>后面的问题就简单了，从网上搜索这个错误可以获得解决方案，基本原理就是将数据库内容导出脚本，然后通过这个脚本重新构建数据库。</p>
<p>可以参考：<a target="_blank" rel="noopener" href="https://techblog.dorogin.com/sqliteexception-database-disk-image-is-malformed-77e59d547c50">https://techblog.dorogin.com/sqliteexception-database-disk-image-is-malformed-77e59d547c50</a></p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>首先我们需要下载SQLite数据库的命令行管理工具：sqlite3.exe，命令行工具如何使用可以参考：<a target="_blank" rel="noopener" href="https://www.sqlite.org/cli.html">https://www.sqlite.org/cli.html</a></p>
<p>我们可以SQLite官网下载命令行工具，比如我下载的是<code>sqlite-tools-win32-x86-3280000.zip</code>，可以在这里找到：<a target="_blank" rel="noopener" href="https://www.sqlite.org/download.html">https://www.sqlite.org/download.html</a></p>
<p>解压文件，并将数据文件拷贝到同级目录。</p>
<p>执行导出：</p>
<ol>
<li>双击<code>sqlite3.exe</code>运行SQLite数据库命令行工具。</li>
<li>执行<code>.open data.db</code>打开我们需要导出数据脚本的数据文件。</li>
<li>执行<code>.mode insert</code>将导出脚本模式修改为用于执行INSERT。</li>
<li>执行<code>.output dump_all.sql</code>指定导出文件的未知与文件名。</li>
<li>执行<code>.dump</code>执行导出。（需要注意的是如果数据库文件较大，可能需要耐心等待一段时间。）</li>
</ol>
<p>如果内容较多，可能执行导出耗时会比较长，需要耐心等待。</p>
<p>执行完成后可以在文件夹下找到导出的脚本文件。</p>
<p>使用SQL文件生成数据库文件：</p>
<ol>
<li>关闭原有的命令行工具，重新打开。</li>
<li>执行<code>.open data.fixed.db</code>，<code>data.fixed.db</code>就是我们恢复后数据库的数据库名。</li>
<li>执行<code>.read dump_all.sql</code>将数据脚本加载到创建的数据库中，等待执行完成即完成数据库的修复。</li>
</ol>
<p>执行成功会生成了一个数据库文件。</p>
<p>我们可以使用文章开篇所使用数据库管理工具尝试检索数据库的状态，如果反馈数据正常，则恢复工作完成。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRAGMA integrity_check;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/how-to-repair-corrupted-sqlite-database-files/" data-id="ckn5z34c2001o15qcfhhwaguh" data-title="如何修复损坏的SQLite数据库文件" class="article-share-link">分享</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-190516-lodop-the-best-print-control-for-printing-experience-under-web" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/lodop-the-best-print-control-for-printing-experience-under-web/" class="article-date">
  <time class="dt-published" datetime="2019-05-16T07:32:56.000Z" itemprop="datePublished">2019-05-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/lodop-the-best-print-control-for-printing-experience-under-web/">Web下打印体验最好的打印控件LODOP</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="什么是LODOP"><a href="#什么是LODOP" class="headerlink" title="什么是LODOP"></a>什么是LODOP</h2><p>LODOP是BS架构打印的解决方案，支持绝大多数浏览器，如果网站上有打印的需求，推荐使用该工具进行打印。</p>
<p>选择LODOP的原因不仅仅在于其对于web打印有着比原生打印更好的打印体验，主要是其还提供了丰富的API，让开发者可以访问打印任务的状态以及打印机的状态，设置打印机与打印输出的属性等等，让开发者可以通过这些实现更多的用户需求。</p>
<p>另外看了官网云打印，之前一直以为必须安装控件才能打印，所以应该是对于设备和系统有要求，但是目前来看也是不限制的，甚至可以使用移动端发送打印请求，但是我没有这方面的使用需求，这里仅仅讨论Windows平台下的打印使用经验。</p>
<p>官方网站：<a target="_blank" rel="noopener" href="http://www.lodop.net/">http://www.lodop.net/</a></p>
<h3 id="LODOP安装使用"><a href="#LODOP安装使用" class="headerlink" title="LODOP安装使用"></a>LODOP安装使用</h3><p>在官网里<a target="_blank" rel="noopener" href="http://www.lodop.net/download.html">下载中心</a>中我们可以下载到打印控件(产品下载)与JS调用打印控件的API(技术手册)，并且产品下载的内容包含测试的样例。</p>
<p>因为官方给的例子中已经有详细的安装以及使用说明，所以这里不做赘述，可以进入下载中心下载解压后直接查看样例，样例1就是安装以及基本的使用说明，其他的样例是一些常见的使用场景。</p>
<p>强烈建议加入售后群，LODOP的售后人员回答问题都很专业且及时，有很好的售后体验。如果使用时发现了以上测试用例之外的使用场景，或者发现一些使用问题，基本都能在技术人员那里得到优质的反馈。</p>
<h2 id="打印场景说明"><a href="#打印场景说明" class="headerlink" title="打印场景说明"></a>打印场景说明</h2><p>使用LODOP打印应该也有两年多了，主要用于条码打印/检验报告单/报表，这里简单聊以下我的使用场景。</p>
<h3 id="条码打印"><a href="#条码打印" class="headerlink" title="条码打印"></a>条码打印</h3><p>因为系统架构是BS的，早期使用ScriptX进行打印主要有这么几个痛点：</p>
<ul>
<li>打印Html内容格式很难固定，需要设置条码打印机来控制纸张大小，而且这个过程非常繁琐，经常出现问题；</li>
<li>不能跨浏览器，只能支持IE浏览器，而且一般需要开启兼容模式并添加受信任站点；</li>
<li>如果需要设置打印场景的默认打印机，需要读取注册表来读取当前系统的打印机，这也是浏览器不兼容的一个主要问题；</li>
<li>不弹出提示直接执行打印任务可能需要安装一些打印控件，但是这些打印控件安装繁琐，且部分系统支持有限；</li>
<li>分页是个问题，内容一旦溢出，即使设置了打印纸张也没用；</li>
<li>条码输出需要后端来支持，生成图片；</li>
</ul>
<p>当然以上只是一部分，但是实际在没有LODOP前打印体验还更差，工程实施与运维在这里踩出过很多坑，而且很多问题会和打印环境也就是电脑系统/IE版本有关，出现问题也很难排查。</p>
<p>因为有打印条形码的需求，并且不想使用后端来生成条形码图片，所以这里我不推荐全部使用HTML设置打印内容。文本建议使用<code>ADD_PRINT_TEXT</code>或<code>ADD_PRINT_TEXTA</code>，区别是后者可以可以针对性的设置打印样式。条码输出建议使用<code>ADD_PRINT_BARCODE</code>。</p>
<p>因为LODOP没有提供直接适用于浏览器的样式设置工具，所以建议自己配置一个模块维护样式。（样例中有使用设置工具生成模板的例子，但是不够相对来说不够直观）。</p>
<p>我这边的设计是BarcodeDesign(条码样式设计表)、BarcodeDesignDetail(条码样式设计明细表)、BarcodeDesignDetailStyle(条码样式设计明细样式表)。</p>
<p>BarcodeDesign是主表，控制打印的基本样式，维护基本的信息主要是样式名称、打印纸张大小、打印方向、样式说明等。</p>
<p>BarcodeDesignDetail是BarcodeDesign的从表，用于维护打印的具体内容，例如数据源、类型(条形码、文本、图片、图形、HTML内容、分页符等LODOP支持输出的格式)、顺序(结合类型中的分页符实现分页效果)等、内容的位置信息和宽高。</p>
<p>BarcodeDesignDetailStyle是BarcodeDesignDetail的从表，用于维护打印内容的样式信息，也就是SET_PRINT_STYLEA可以针对不同的内容类型设置的样式。</p>
<h3 id="检验报告"><a href="#检验报告" class="headerlink" title="检验报告"></a>检验报告</h3><p>检验报告单的打印，相对条码打印要复杂很多，因为基本样式是不固定的。公司在前期没有考虑用报表控件，开始是xsl输出，因为学习成本较高不利于维护，后面改用Html打印，除常见格式外，余下的每种报告单样式对应一个页面。</p>
<p>开始没有考虑FastReport是因为BS架构下兼容有问题，加上报告单的样式比较复杂，数据源比较复杂，分页/数据表设计/排版 在这些报表控件中很难设计出理想的效果，另外就是报表控件设计工具的使用对于我来说也有一定的学习成本，所以基于此干脆继续使用Html打印，而这恰好也是LODOP最擅长的。</p>
<p>设计主要就两个表：LabReportDesign(实验室检验报告单设计表)与LabReportDesignDetail(实验室检验报告单设计明细表)。</p>
<p>LabReportDesign是主表，主要用来配置报告单的基本信息，包括报告单名称、打印纸张信息、输出内容的宽度与边距、使用的字体大小与样式、是否使用特殊样式(默认走普通样式)、每页显示的数据行数等等。</p>
<p>LabReportDesignDetail是LabReportDesign的从表，主要用于配置一些基础的数据源信息，包括行头展示的病人与检验信息/页脚展示的病人与检验信息/报告单主题内容显示哪些结果信息/注脚显示的信息等。</p>
<p>这里如果是普通报告单，从以上两张表的设置，可以从后台拼接一份Html用于打印。</p>
<p>如果是特殊样式的报告单，这里也没有考虑使用页面，一方面不方便打印，另外就是考虑到检验医师签名后要将数据静态化到数据表中，供其他系统查阅，这里使用的Razor引擎解析指定目录下的<code>cshtml</code>文件，这里是可以返回一份Html内容的。</p>
<p>另外将Html内容静态化的另外一个好处就是，我们还可以使用一些工具例如<code>wkhtmltopdf</code>将文件生成PDF文件。</p>
<h3 id="报表"><a href="#报表" class="headerlink" title="报表"></a>报表</h3><p>普通报表打印输出问题不大，问题是一些报表的某些数据列，内容长度变化较大不方便分页，之前设计的打印都是每一页固定行数，就会出现某些内容打印超出纸张，某些内容只占了纸张的一半。</p>
<p>这里建议参考一下样例中数据表格分页打印的样例，但是需要注意的是表格数据内容较多时，打印控件进行数据装载的时间会比较长。</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><p>优点：</p>
<ul>
<li>BS架构实现CS架构下的打印体验，这一点是目前市面上打印控件做的最好的；</li>
<li>浏览器兼容性较好，支持现代浏览器；</li>
<li>样例完善，基本覆盖所有的打印场景；</li>
<li>售后技术人员反馈回复及时，回复内容也比较专业；</li>
<li>价格方面比较友好；</li>
</ul>
<p>缺点：</p>
<ul>
<li>打印依赖IE浏览器解析，LODOP客户端或CLODOP服务端IE浏览器版本较低可能会出现一些问题；</li>
<li>目前设计功能开发还不够，需要进一步完善；</li>
<li>仅仅适用于打印样式比较简单的场景；</li>
<li>如果需要将内容输出为PDF等格式文档文件可能需要依赖虚拟打印机等；</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol>
<li>打印的Html内容如果需要加载媒体资源例如图片，建议通过<code>SET_PRINT_STYLEA</code>设置<code>HtmWaitMilSecs</code>即超文本下载延迟，避免图片没有下载完成即执行打印；</li>
<li>尽量避免打印内容的媒体资源，例如图片<code>404</code>，否则可能出现任务响应缓慢；</li>
<li>打印Html内容一定要检查内容开闭标签是否有缺失，否则可能出现很奇怪的问题；</li>
<li>打印Html内容如果是外联样式，并且要使用该样式，注意打印的时候要加入到打印内容中；</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/lodop-the-best-print-control-for-printing-experience-under-web/" data-id="ckn5z34c0001m15qcg7gicjvh" data-title="Web下打印体验最好的打印控件LODOP" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LODOP/" rel="tag">LODOP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%89%93%E5%8D%B0/" rel="tag">打印</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190506-using-jint-to-run-js-in-csharp-and-implement-simple-calculator" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/using-jint-to-run-js-in-csharp-and-implement-simple-calculator/" class="article-date">
  <time class="dt-published" datetime="2019-05-06T09:45:00.000Z" itemprop="datePublished">2019-05-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/using-jint-to-run-js-in-csharp-and-implement-simple-calculator/">利用Jint在C#中运行JS脚本并实现简单计算器</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="关于Jint"><a href="#关于Jint" class="headerlink" title="关于Jint"></a>关于Jint</h2><p>Jint是一个开源的JS脚本引擎，可以让我们在dotnet平台运行js代码，这使我们可以通过这一特性处理很多工作。</p>
<p>关于Jint的更多信息和用例可以参考：<a target="_blank" rel="noopener" href="https://github.com/sebastienros/jint">https://github.com/sebastienros/jint</a></p>
<h2 id="Jint的用途"><a href="#Jint的用途" class="headerlink" title="Jint的用途"></a>Jint的用途</h2><h3 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h3><p>在日常工作中存在一个需求：用户自己定义表达式，系统根据表达式替换表达式中项目的数值，计算生成另外一个项目的结果。</p>
<p>例如：<code>[GLO] = [TP] - [ALB]</code>，已知<code>[TP]</code>与<code>[ALB]</code>的结果，需要我们求出<code>[GLO]</code>的结果。</p>
<p>这个表达式初看其实很简单，但是实际业务中，可能存在多层级的嵌套甚至次幂/开根号/自然对数等的运算，这样如果通过程序来解析表达式进行运算工作量比较大。</p>
<p>过去程序设计是在Web端触发特定事件后通过正则替换表达式中参与运算项目为实际数值，使用<code>eval</code>函数执行表达式，获取结果并保存到数据库。但是随着系统不断升级，仅仅依靠前端来更新结果，在某些情况下不够人性化而且不能满足需求。</p>
<p>检索关于算术运算，网上普遍推荐的方案是：</p>
<ol>
<li>使用数据库拼接SQL语句；</li>
<li>通过C#反射实现类似js的<code>eval</code>函数效果；</li>
</ol>
<p>但是这些方案的缺点都很明显：数据库方案需要保持数据库连接，消耗数据库性能，并且不能使用特殊的函数运算比如对数等求解；C#的反射数值中如果存在整数运算，则会取整，需要手动替换数值增加浮点型数字的标记比较麻烦。</p>
<p>几次碰壁以后，就在想，是不是可以在C#中运行js代码？在网上检索相关资料果然有戏。不过首先尝试的是Microsoft.JScript库，不过这个已经被微软标记为<code>Obsolete</code>，并且对于一些语法支持的不完善，所以这里不推荐。</p>
<p>首先我们来实现一个简单的计算器：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取算术式结果</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>原始算术式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Calculator</span>(<span class="params"><span class="built_in">string</span> input = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//算式为空提示输入算式</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;请输入一个算术式(退出输入Q)：&quot;</span>);</span><br><span class="line">            input = Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非退出该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//使用Jint执行算式</span></span><br><span class="line">                Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">                <span class="built_in">object</span> result = engine.Execute(input).GetCompletionValue().ToObject();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;算术式：<span class="subst">&#123;input&#125;</span> 输出：<span class="subst">&#123;result&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception exc)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;算术式：<span class="subst">&#123;input&#125;</span> 运算出现异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//赋值空让用户循环输入</span></span><br><span class="line">            input = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试一下效果，已经满足了我们的需求：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/jint1_1562755045285.png" alt="jint1"></p>
<blockquote>
<p>需要注意的是，JavaScript中对于浮点数的支持精度较低，建议运算后设定小数位数进行转换。</p>
</blockquote>
<p>通过以上，我们进一步实现上面我们业务中需要的功能，下面是一个简单的实现：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取表达式结果</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>原始表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetResultFromExpression</span>(<span class="params"><span class="built_in">string</span> input = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> oldInput;</span><br><span class="line">    Regex regex = <span class="keyword">new</span> Regex(<span class="string">@&quot;\[([A-Za-z0-9]+)\]&quot;</span>);<span class="comment">//表达式中项目由字母和数字组成</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//表达式为空提示输入表达式</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;请输入表达式(退出输入Q)：&quot;</span>);</span><br><span class="line">            input = Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于输出原始表达式</span></span><br><span class="line">        oldInput = input;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于判断表达式项目是否已经替换</span></span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; items = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非退出该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//匹配表达式中项目并替换</span></span><br><span class="line">            MatchCollection matches = regex.Matches(input);</span><br><span class="line">            <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> matches)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//已经替换的跳过</span></span><br><span class="line">                <span class="keyword">if</span> (items.Contains(match.Value))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                items.Add(match.Value);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;请为项目：<span class="subst">&#123;match.Value&#125;</span> 赋值：&quot;</span>);</span><br><span class="line">                <span class="built_in">string</span> item = Console.ReadLine();</span><br><span class="line">                input = input.Replace(match.Value, item);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//使用Jint执行表达式</span></span><br><span class="line">                Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">                <span class="built_in">object</span> result = engine.Execute(input).GetCompletionValue().ToObject();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;表达式：<span class="subst">&#123;oldInput&#125;</span> 算术式：<span class="subst">&#123;input&#125;</span> 输出：<span class="subst">&#123;result&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception exc)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;表达式：<span class="subst">&#123;oldInput&#125;</span> 算术式：<span class="subst">&#123;input&#125;</span> 运算出现异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//赋值空让用户循环输入</span></span><br><span class="line">            input = <span class="literal">null</span>;</span><br><span class="line">            oldInput = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/jint2_1562755045287.png" alt="jint2"></p>
<h3 id="自定义脚本"><a href="#自定义脚本" class="headerlink" title="自定义脚本"></a>自定义脚本</h3><p>系统中某些位置，可能需要比较大的自由度去处理业务数据，例如文档的输出，我们能从数据库中读取到结果是数值型，但是实施人员希望我们能处理成文本型，并且设定的条件较多，自由度很大。</p>
<p>当然最直接的方案就是我们将这些集成到业务代码中，友好一点的设置一个参数表，由工程人员维护。但是当这里的业务逻辑复杂或者存在很多的不定因素，这里的维护更新就变得困难。</p>
<p>而这个时候，我们可以通过写一些js脚本，来处理复杂逻辑的问题，例如文档中我们配置了一下内容：</p>
<p><code>[ItemName]的结果为[ResultValue]，临床意义为：[Descript]。</code></p>
<p>当<code>[ItemName]</code>显示的内容是“HIV”时，<code>[ResultValue]</code>的值小于1判定<code>[Descript]</code>为“阴性”，否则为待复查。若<code>[ItemName]</code>不是“HIV”时，<code>[ResultValue]</code>的值小于1判定<code>[Descript]</code>为“阴性”，否则为阳性。如果<code>[ResultValue]</code>中存在非数字部分，则只取数字部分内容。</p>
<p>这里如果用业务代码或者参数来写，可能复杂一些，因为像这样的业务逻辑还有很多，而且可能随时需要调整，但是我们可以将以上的内容稍稍进行调整，我们定义<code>$#*[JS代码]*#</code>来包括一段代码，将以上的内容进行调整：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ItemName]的结果为[ResultValue]，临床意义为：$#*</span><br><span class="line">var n &#x3D; &#39;[ItemName]&#39;;</span><br><span class="line">var r &#x3D; &#39;[ResultValue]&#39;.replace(&#x2F;[^0-9\+\-\.]&#x2F;, &#39;&#39;);</span><br><span class="line">var d &#x3D; &#39;&#39;;</span><br><span class="line">if (r !&#x3D;&#x3D; &#39;&#39; &amp;&amp; !isNaN(r)) &#123;</span><br><span class="line">    if (n &#x3D;&#x3D;&#x3D; &#39;HIV&#39; &amp;&amp; r &gt;&#x3D; 1) &#123;</span><br><span class="line">        d &#x3D; &#39;待复查&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (r &gt;&#x3D; 1) &#123;</span><br><span class="line">        d &#x3D; &#39;阳性&#39;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        d &#x3D; &#39;阴性&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">d;*#。</span><br></pre></td></tr></table></figure>
<p>那么我们写一个测试用例实现以下对以上内容的解析：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行自定义脚本获取内容</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;input&quot;&gt;</span>脚本<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ExecuteCustomScript</span>(<span class="params"><span class="built_in">string</span> input = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> oldInput;</span><br><span class="line">    Regex regex1 = <span class="keyword">new</span> Regex(<span class="string">@&quot;\[([A-Za-z0-9]+)\]&quot;</span>);<span class="comment">//脚本中项目由字母和数字组成</span></span><br><span class="line">    Regex regex2 = <span class="keyword">new</span> Regex(<span class="string">@&quot;\$#\*(.+)\*#&quot;</span>, RegexOptions.Singleline);<span class="comment">//匹配自定义脚本</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//脚本为空提示输入</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(input))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;请输入脚本(退出输入Q)：&quot;</span>);</span><br><span class="line">            input = Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于输出原始脚本</span></span><br><span class="line">        oldInput = input;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于判断脚本项目是否已经替换</span></span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; items = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于判断脚本内容是否已经替换</span></span><br><span class="line">        List&lt;<span class="built_in">string</span>&gt; scripts = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非退出该方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//匹配脚本中项目并替换</span></span><br><span class="line">            &#123;</span><br><span class="line">                MatchCollection matches = regex1.Matches(input);</span><br><span class="line">                <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> matches)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//已经替换的跳过</span></span><br><span class="line">                    <span class="keyword">if</span> (items.Contains(match.Value))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    items.Add(match.Value);</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;请为项目：<span class="subst">&#123;match.Value&#125;</span> 赋值：&quot;</span>);</span><br><span class="line">                    <span class="built_in">string</span> item = Console.ReadLine();</span><br><span class="line">                    input = input.Replace(match.Value, item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//匹配内容中自定义脚本并执行替换</span></span><br><span class="line">            &#123;</span><br><span class="line">                MatchCollection matches = regex2.Matches(input);</span><br><span class="line">                <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> matches)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//已经替换的跳过</span></span><br><span class="line">                    <span class="keyword">if</span> (scripts.Contains(match.Value))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    scripts.Add(match.Value);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//使用Jint执行内容中自定义脚本</span></span><br><span class="line">                        Engine engine = <span class="keyword">new</span> Engine();</span><br><span class="line">                        <span class="built_in">object</span> result = engine.Execute(match.Groups[<span class="number">1</span>].Value).GetCompletionValue().ToObject();</span><br><span class="line">                        input = input.Replace(match.Value, result.ToString());</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (Exception exc)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Console.WriteLine(<span class="string">$&quot;脚本：<span class="subst">&#123;match.Groups[<span class="number">1</span>].Value&#125;</span>\r\n执行出现异常：<span class="subst">&#123;exc.Message&#125;</span>&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;**********************\r\n原始脚本：<span class="subst">&#123;oldInput&#125;</span>\r\n输出内容：<span class="subst">&#123;input&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//还原公式让用户重新赋值</span></span><br><span class="line">            input = oldInput;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">string</span>.Equals(input, <span class="string">&quot;Q&quot;</span>, StringComparison.OrdinalIgnoreCase));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">JintTest.ExecuteCustomScript(<span class="string">@&quot;[ItemName]的结果为[ResultValue]，临床意义为：$#*</span></span><br><span class="line"><span class="string">var n = &#x27;[ItemName]&#x27;;</span></span><br><span class="line"><span class="string">var r = &#x27;[ResultValue]&#x27;.replace(/[^0-9\+\-\.]/, &#x27;&#x27;);</span></span><br><span class="line"><span class="string">var d = &#x27;&#x27;;</span></span><br><span class="line"><span class="string">if (r !== &#x27;&#x27; &amp;&amp; !isNaN(r)) &#123;</span></span><br><span class="line"><span class="string">    if (n === &#x27;HIV&#x27; &amp;&amp; r &gt;= 1) &#123;</span></span><br><span class="line"><span class="string">        d = &#x27;待复查&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else if (r &gt;= 1) &#123;</span></span><br><span class="line"><span class="string">        d = &#x27;阳性&#x27;;</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">        d = &#x27;阴性&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">d;*#。&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>测试效果如下：</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/jint3_1562755045286.png" alt="jint3"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/using-jint-to-run-js-in-csharp-and-implement-simple-calculator/" data-id="ckn5z34by001j15qc88k535rh" data-title="利用Jint在C#中运行JS脚本并实现简单计算器" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jint/" rel="tag">Jint</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190410-implementing-a-simple-crawler-project-in-csharp" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/implementing-a-simple-crawler-project-in-csharp/" class="article-date">
  <time class="dt-published" datetime="2019-04-10T12:55:33.000Z" itemprop="datePublished">2019-04-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/implementing-a-simple-crawler-project-in-csharp/">C#中实现简单爬虫项目</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="什么是爬虫"><a href="#什么是爬虫" class="headerlink" title="什么是爬虫"></a>什么是爬虫</h2><p>爬虫即网络爬虫（又被称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。另外一些不常使用的名字还有蚂蚁、自动索引、模拟程序或者蠕虫。</p>
<p>我们日常使用的搜索引擎、比价网站等都是通过爬虫技术获取数据，而后经数据提取、分析、优化后供用户使用。当然日常生活中，我们也可以使用爬虫技术，获取我们感兴趣的网站进行数据解析分析，做出来一些有意思的功能或小工具，比如新闻提醒、事项通知、资料整理等。</p>
<p>这方面我们需要了解的技术主要是：Http请求、XPath、正则等。以下是一个简单的例子，用于获取京东商城的数据，例子仅供学习。</p>
<h2 id="抓取京东所有商品类别"><a href="#抓取京东所有商品类别" class="headerlink" title="抓取京东所有商品类别"></a>抓取京东所有商品类别</h2><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ul>
<li>分析京东商品类别页面<blockquote>
<p>Chrome浏览器打开页面：<a target="_blank" rel="noopener" href="https://www.jd.com/allsort.aspx">https://www.jd.com/allsort.aspx</a></p>
</blockquote>
</li>
<li>查看页面源代码<blockquote>
<p>用XPath分析商品类别信息，包括分类ID、分类名、链接，XPath语法可参考：<a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/xpath_syntax.asp">http://www.w3school.com.cn/xpath/xpath_syntax.asp</a></p>
</blockquote>
</li>
<li>获取数据<blockquote>
<p>使用 <code>System.Net.WebRequest</code>/<code>System.Net.WebClient</code>/<code>HtmlAgilityPack.HtmlWeb</code> 获取数据 (<code>HtmlAgilityPack</code> 可以通过 <code>nuget</code> 添加引用)</p>
</blockquote>
</li>
<li>解析数据<blockquote>
<p>使用 <code>HtmlAgilityPack.HtmlDocument</code> 解析包含商品类别信息的链接</p>
</blockquote>
</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><p>使用 <code>System.Net.WebRequest/System.Net.HttpWebRequest</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HtmlAgilityPack.HtmlDocument document = <span class="literal">null</span>;</span><br><span class="line">WebRequest request = WebRequest.Create(<span class="string">&quot;https://www.jd.com/allsort.aspx&quot;</span>);</span><br><span class="line"><span class="keyword">using</span> (WebResponse response = request.GetResponse())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (Stream stream = response.GetResponseStream())</span><br><span class="line">    &#123;</span><br><span class="line">        document = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">        document.Load(stream, Encoding.UTF8);</span><br><span class="line">        <span class="comment">//MemoryStream memoryStream = (MemoryStream)stream;</span></span><br><span class="line">        <span class="comment">//document.LoadHtml(Encoding.UTF8.GetString(memoryStream.ToArray()));</span></span><br><span class="line">        <span class="comment">//memoryStream.Dispose();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>System.Net.Client</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HtmlAgilityPack.HtmlDocument document = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">using</span> (WebClient client = <span class="keyword">new</span> WebClient())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> (Stream stream = client.OpenRead(<span class="string">&quot;https://www.jd.com/allsort.aspx&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        document = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">        document.Load(stream, Encoding.UTF8);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>HtmlAgilityPack.HtmlWeb</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HtmlWeb web = <span class="keyword">new</span> HtmlWeb</span><br><span class="line">&#123;</span><br><span class="line">    OverrideEncoding = Encoding.UTF8</span><br><span class="line">&#125;;</span><br><span class="line">HtmlAgilityPack.HtmlDocument document = web.Load(<span class="string">&quot;https://www.jd.com/allsort.aspx&quot;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="解析数据"><a href="#解析数据" class="headerlink" title="解析数据"></a>解析数据</h4><p>实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> JDId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> URL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Category&gt; listCategory = <span class="keyword">new</span> List&lt;Category&gt;();</span><br><span class="line"><span class="keyword">if</span> (document != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> iId = <span class="number">1</span>;<span class="comment">//编号</span></span><br><span class="line">    Regex regex = <span class="keyword">new</span> Regex(<span class="string">&quot;cat=(\\d+(\\,\\d+)*)&quot;</span>);<span class="comment">//匹配与提取类别ID正则</span></span><br><span class="line">    <span class="comment">//取出所有链接</span></span><br><span class="line">    HtmlNodeCollection collection = document.DocumentNode.SelectNodes(<span class="string">&quot;//a[@href]&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> collection)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//正则匹配出是商品类别的链接</span></span><br><span class="line">        Match match = regex.Match(item.Attributes[<span class="string">&quot;href&quot;</span>].Value.ToLower());</span><br><span class="line">        <span class="keyword">if</span> (match.Success)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//提取商品类别ID 商品类别链接 商品类别名称</span></span><br><span class="line">            listCategory.Add(<span class="keyword">new</span> Category() &#123; Id = iId++, JDId = match.Groups[<span class="number">1</span>].Value, Name = item.InnerText, URL = item.Attributes[<span class="string">&quot;href&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? item.Attributes[<span class="string">&quot;href&quot;</span>].Value : <span class="string">&quot;https:&quot;</span> + item.Attributes[<span class="string">&quot;href&quot;</span>].Value &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="抓取京东商品信息"><a href="#抓取京东商品信息" class="headerlink" title="抓取京东商品信息"></a>抓取京东商品信息</h2><h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><ul>
<li>选择一个商品类别页面分析<blockquote>
<p>Chrome浏览器打开页面：<a target="_blank" rel="noopener" href="https://list.jd.com/list.html?cat=1713,4855,4859">https://list.jd.com/list.html?cat=1713,4855,4859</a></p>
</blockquote>
</li>
<li>使用Chrome分析元素<blockquote>
<p>使用“F12 -&gt; Elements -&gt; 审查元素(Ctrl+Shift+C) -&gt; 右键 -&gt; Copy -&gt; Copy XPath”分析商品总页数、商品DIV解析的XPath语法</p>
</blockquote>
</li>
<li>换页分析不同页码连接特点<blockquote>
<p><code>GET</code> 参数 <code>page</code> 指定页面：<a target="_blank" rel="noopener" href="https://list.jd.com/list.html?cat=1713,4855,4859&amp;page=2">https://list.jd.com/list.html?cat=1713,4855,4859&amp;page=2</a></p>
</blockquote>
</li>
<li>获取数据<blockquote>
<p>同抓取商品类别</p>
</blockquote>
</li>
<li>解析数据<blockquote>
<p>使用 <code>HtmlAgilityPack.HtmlDocument</code> 解析商品信息</p>
</blockquote>
</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><h4 id="获取数据-1"><a href="#获取数据-1" class="headerlink" title="获取数据"></a>获取数据</h4><p>见类别获取部分实现。</p>
<h4 id="解析数据-1"><a href="#解析数据-1" class="headerlink" title="解析数据"></a>解析数据</h4><p>实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> JDId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ImageURL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> URL &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (document != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取页码信息</span></span><br><span class="line">    <span class="built_in">string</span> sCurrentPager = <span class="built_in">string</span>.Empty;<span class="comment">//当前页数</span></span><br><span class="line">    <span class="built_in">string</span> sAllPager = <span class="built_in">string</span>.Empty;<span class="comment">//总页数</span></span><br><span class="line">    <span class="comment">//List&lt;Product&gt; listProduct = new List&lt;Product&gt;();//商品</span></span><br><span class="line">    <span class="comment">//获取页数信息</span></span><br><span class="line">    HtmlNodeCollection currentPagerNode = document.DocumentNode.SelectNodes(<span class="string">&quot;//*[@id=\&quot;J_topPage\&quot;]/span/b&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (currentPagerNode.Count != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;加载当前页码失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sCurrentPager = currentPagerNode[<span class="number">0</span>].InnerText;</span><br><span class="line">    &#125;</span><br><span class="line">    HtmlNodeCollection allPagersNode = document.DocumentNode.SelectNodes(<span class="string">&quot;//*[@id=\&quot;J_topPage\&quot;]/span/i&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (allPagersNode.Count != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;加载总页数失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sAllPager = allPagersNode[<span class="number">0</span>].InnerText;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取商品信息</span></span><br><span class="line">    <span class="built_in">int</span> iId = <span class="number">1</span>;<span class="comment">//编号</span></span><br><span class="line">    HtmlNodeCollection productNode = document.DocumentNode.SelectNodes(<span class="string">&quot;//*[@id=\&quot;plist\&quot;]/ul/li&quot;</span>);<span class="comment">//符合条件的商品XPath语法</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> productNode)</span><br><span class="line">    &#123;</span><br><span class="line">        Product product = <span class="keyword">new</span> Product();</span><br><span class="line">        HtmlAgilityPack.HtmlDocument tempDocument = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">        tempDocument.LoadHtml(item.OuterHtml);</span><br><span class="line">        <span class="comment">//商品图片链接</span></span><br><span class="line">        HtmlNodeCollection imageNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//*[@class=\&quot;p-img\&quot;]/a/img&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (imageNode.Count &gt; <span class="number">0</span> &amp;&amp; imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;src&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(imageNode[<span class="number">0</span>].Attributes   [<span class="string">&quot;src&quot;</span>].Value))<span class="comment">// 正常加载图片链接</span></span><br><span class="line">        &#123;</span><br><span class="line">            product.ImageURL = imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;src&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? imageNode[<span class="number">0</span>].Attributes [<span class="string">&quot;src&quot;</span>].Value :    <span class="string">&quot;https:&quot;</span> + imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;src&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (imageNode.Count &gt; <span class="number">0</span> &amp;&amp; imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-lazy-img&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(imageNode [<span class="number">0</span>].Attributes   [<span class="string">&quot;data-lazy-img&quot;</span>].Value))<span class="comment">//懒加载图片链接</span></span><br><span class="line">        &#123;</span><br><span class="line">            product.ImageURL = imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-lazy-img&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? imageNode[<span class="number">0</span>].Attributes   [<span class="string">&quot;data- lazy-img&quot;</span>].Value : <span class="string">&quot;https:&quot;</span> + imageNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-lazy-img&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品ID</span></span><br><span class="line">        HtmlNodeCollection idNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//li/div&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (idNode.Count &gt; <span class="number">0</span> &amp;&amp; idNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-sku&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(idNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-  sku&quot;</span>].Value))</span><br><span class="line">        &#123;</span><br><span class="line">            product.JDId = idNode[<span class="number">0</span>].Attributes[<span class="string">&quot;data-sku&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品名称</span></span><br><span class="line">        HtmlNodeCollection nameNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//*[@class=\&quot;p-name\&quot;]/a/em&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (nameNode.Count &gt; <span class="number">0</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(nameNode[<span class="number">0</span>].InnerText.Trim()))</span><br><span class="line">        &#123;</span><br><span class="line">            product.Name = nameNode[<span class="number">0</span>].InnerText.Trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//商品链接</span></span><br><span class="line">        HtmlNodeCollection urlNode = tempDocument.DocumentNode.SelectNodes(<span class="string">&quot;//*[@class=\&quot;p-name\&quot;]/a&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (urlNode.Count &gt; <span class="number">0</span> &amp;&amp; urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>] != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value))</span><br><span class="line">        &#123;</span><br><span class="line">            product.URL = urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value.ToLower().StartsWith(<span class="string">&quot;http&quot;</span>) ? urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value :    <span class="string">&quot;https:&quot;</span>  + urlNode[<span class="number">0</span>].Attributes[<span class="string">&quot;href&quot;</span>].Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        product.Id = iId++;</span><br><span class="line">        listProduct.Add(product);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>图片懒加载，如果解析src属性可能解析不到，需要调试查看懒加载图片属性。</li>
<li>价格信息抓取会发现为空，观察会发现其calss属性为“J_price”，怀疑为ajax请求获取，下一部分说明获取方法。</li>
</ul>
<h2 id="抓取京东商品价格信息"><a href="#抓取京东商品价格信息" class="headerlink" title="抓取京东商品价格信息"></a>抓取京东商品价格信息</h2><h3 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h3><ul>
<li>使用Chrome分析网络请求<blockquote>
<p>使用“F12 -&gt; Network -&gt; JS”分析页面刷新时的ajax请求，发现：<a target="_blank" rel="noopener" href="https://p.3.cn/prices/mgets">https://p.3.cn/prices/mgets</a> 的请求，怀疑为查询价格的请求信息</p>
</blockquote>
</li>
<li>分析请求链接<blockquote>
<p>过滤GET参数，发现传递参数skuIds即可获取信息，多个用“%2C”分隔即可，例如：<a target="_blank" rel="noopener" href="https://p.3.cn/prices/mgets?skuIds=J_4609652,J_5830869">https://p.3.cn/prices/mgets?skuIds=J_4609652%2CJ_5830869</a> ，获取的数据位JSON格式</p>
</blockquote>
</li>
<li>获取数据<blockquote>
<p>同抓取商品类别</p>
</blockquote>
</li>
<li>解析数据<blockquote>
<p>使用 <code>Newtonsoft.Json</code> 解析(<code>Newtonsoft.Json</code> 可以通过 <code>nuget</code> 添加引用)</p>
</blockquote>
</li>
</ul>
<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><h4 id="获取数据-2"><a href="#获取数据-2" class="headerlink" title="获取数据"></a>获取数据</h4><p>见类别获取部分实现。</p>
<h4 id="解析数据-2"><a href="#解析数据-2" class="headerlink" title="解析数据"></a>解析数据</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 通过京东商品ID获取价格</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;listJDId&quot;&gt;</span>商品ID<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>商品ID对应价格的字典<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; <span class="title">GetPrice</span>(<span class="params">List&lt;<span class="built_in">string</span>&gt; listJDId</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; dicPrice = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;();</span><br><span class="line">    <span class="keyword">if</span> (listJDId.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//按照ajax请求连接格式拼接skuID</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; listJDId.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            listJDId[i] = <span class="string">&quot;J_&quot;</span> + listJDId[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//循环每10条查询一次 避免数量过多链接过长</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; (listJDId.Count + <span class="number">9</span>) / <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获取数据</span></span><br><span class="line">            HtmlAgilityPack.HtmlDocument document = <span class="keyword">new</span> HtmlAgilityPack.HtmlDocument();</span><br><span class="line">            WebRequest request = WebRequest.Create(<span class="string">&quot;https://p.3.cn/prices/mgets?skuIds=&quot;</span> + <span class="built_in">string</span>.Join(<span class="string">&quot;%2C&quot;</span>, listJDId.Skip(i * <span class="number">10</span>).Take(<span class="number">10</span>)));</span><br><span class="line">            <span class="keyword">using</span> (Stream stream = request.GetResponse().GetResponseStream())</span><br><span class="line">            &#123;</span><br><span class="line">                document.Load(stream, Encoding.UTF8);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//解析数据</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(document.Text))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">object</span> oPrice = Newtonsoft.Json.JsonConvert.DeserializeObject(document.Text);<span class="comment">//转换成对象</span></span><br><span class="line">                <span class="keyword">if</span> (oPrice <span class="keyword">is</span> JArray)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> oPrice <span class="keyword">as</span> JArray)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (item <span class="keyword">is</span> JObject &amp;&amp; (item <span class="keyword">as</span> JObject).ContainsKey(<span class="string">&quot;id&quot;</span>) &amp;&amp; (item <span class="keyword">as</span> JObject).ContainsKey(<span class="string">&quot;p&quot;</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//提取符合条件的数据</span></span><br><span class="line">                            <span class="keyword">if</span> ((item <span class="keyword">as</span> JObject)[<span class="string">&quot;id&quot;</span>] <span class="keyword">is</span> JValue jId &amp;&amp; (item <span class="keyword">as</span> JObject)[<span class="string">&quot;p&quot;</span>] <span class="keyword">is</span> JValue jPrice &amp;&amp; listJDId.Contains(jId.Value.ToString()) &amp;&amp; !dicPrice.ContainsKey(jId.Value.ToString().TrimStart(<span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)))</span><br><span class="line">                            &#123;</span><br><span class="line">                                dicPrice.Add(jId.Value.ToString().TrimStart(<span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;_&#x27;</span>), jPrice.Value.ToString());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dicPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>若想使用jQuery选择器可以结合Fizzlerex使用：<a target="_blank" rel="noopener" href="https://archive.codeplex.com/?p=fizzlerex">https://archive.codeplex.com/?p=fizzlerex</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/implementing-a-simple-crawler-project-in-csharp/" data-id="ckn5z34bx001i15qcc0xy2plt" data-title="C#中实现简单爬虫项目" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190407-kindle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/kindle/" class="article-date">
  <time class="dt-published" datetime="2019-04-07T10:17:37.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a>►<a class="article-category-link" href="/categories/%E6%97%A5%E5%BF%97/%E5%BC%80%E7%AE%B1/">开箱</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/kindle/">入手Kindle</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="“好读书”"><a href="#“好读书”" class="headerlink" title="“好读书”"></a>“好读书”</h2><p>从小到大，自认为自己是一个不爱看书的人（网文除外），但是身为一个程序员，誓要向<code>dalao</code>看齐的人一直想培养一个良好的阅读习惯。</p>
<p>在工作的前期曾经购置了很多书，包括<code>C#</code>、<code>JavaScript</code>、<code>Oracle</code>的工具书还有一些名著、散文、豆瓣推荐等很多书，但是因为不方便携带，很多都在搬家的过程中遗失了，或者带回老家垫桌脚了。</p>
<p>从那以后，每次京东和当当有活动，都要纠结着要不要再剁手买几本，最后都忍了，因为这些书并不方便携带，而且选择困难症的我经常会纠结外出的时候带哪本书好。</p>
<h2 id="“Kindle”软件"><a href="#“Kindle”软件" class="headerlink" title="“Kindle”软件"></a>“Kindle”软件</h2><p>Kindle其实已经流行了好多年，但是身边认识的小伙伴几乎没有上手过的，所以也只是听说，知道有个“墨水屏”的技术。</p>
<p>真正用Kindle，是因为之前在Telegram发现了一个群，每天都会分享一些好书。开始用一个PC版基于<code>Python</code>开发的阅读软件，但是体验不好，使用没多久就放弃了。后来想起来Kindle好像可以在PC或移动设备上安装，于是便下载体验了一下，不得不说——真香，在手机、平板、PC上都安装了Kindle的软件。</p>
<p>而在体验了一段时间，很正常的操作是，买了<code>Kindle Unlimited</code>电子书包月服务，而且买了一年，哈哈。</p>
<p>当然买了以后，也并没有老老实实读书，啃了一本《白鹿原》后，渐渐又回到了上班摸鱼下班摸鱼的生活。</p>
<h2 id="学习的“冲动”"><a href="#学习的“冲动”" class="headerlink" title="学习的“冲动”"></a>学习的“冲动”</h2><p>一直想系统的学习一下平时接触的技术，并且了解一些一直感兴趣的领域。</p>
<p>比如系统的看一下<code>JavaScript</code>、<code>C#</code>、<code>MVC</code>、<code>数据结构与算法</code>、<code>23种设计模式</code>等的工具书与教材。想要学习一下<code>Git</code>、<code>Docker</code>、<code>Python</code>、<code>PowerShell</code>等比较热门的技术。</p>
<p>这些书一般厚且贵，当然优选还是找电子书，先是在当当和京东选择了几本，但是后来想到了自己安装的Kindle，又放弃了下单。</p>
<p>纠结了很久，要不要买以及要不要考虑京东/iReader/当当家的电纸书阅读器，最终还在京东将Kindle加入了购物车。</p>
<h2 id="购置"><a href="#购置" class="headerlink" title="购置"></a>购置</h2><p>电子产品当然要在京东上购买才比较舒服，因为速度、售后、价格等服务上还是有一些优势的，而且……plus会员不能白买了。/(ㄒoㄒ)/~~</p>
<p>之前在知乎别人推荐，如果知识体验电纸书，推荐买入门版，但是为了“奖励”一下自己的上进心（钱都花了，不能白花一定要好好读书好好学习），果断——当然买不起3k+的版本，割肉买了32G的版本。</p>
<p>当然最终的价格是1288(买了个皮套)-50(plus会员满1200减50优惠券)，入手价格是1238。（买之前忘记比价看一下这个点买有没有亏，买之后上去查了一下，感觉还好，价格一直很稳定。）</p>
<h2 id="开箱"><a href="#开箱" class="headerlink" title="开箱"></a>开箱</h2><p>京东的服务就是快，上午十点下单，下午三点快递员就给我打了电话。当然比较不愉快的是之前都有送货上楼，这次居然让我去蜂巢自己取快递。😔</p>
<p>当然，Kindle的到来，开箱的喜悦，这些小插曲都是浮云哦。小心翼翼的开箱中……</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle1_1562726351240.jpg" alt="kindle1"></p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle2_1562726351248.jpg" alt="kindle2"></p>
<p>啊？忘记了两个快递包裹，因为顺便补充了一下洗面奶的存货，看到大的盒子想当然的以为是Kindle，结果并不是，于是开另外一个包裹。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle3_1562726351244.jpg" alt="kindle3"></p>
<p>包装很“节约”，盒子的大小感觉也就比Kindle本身大一点点。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle4_1562726351243.jpg" alt="kindle4"></p>
<p>盒子上的图形刚开始还以为是水渍，后来才发现原来是平时Kindle上见到的封面图。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle5_1562726351243.jpg" alt="kindle5"></p>
<p>一家人当然要整整齐齐的，6寸的大小和手掌的大小差不多，可以装进衣兜里。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle6_1562726351242.jpg" alt="kindle6"></p>
<p>刚开始以为那些提示是贴膜，差点把屏幕掀起来……直接开机就好了。</p>
<p><img src="https://hd2y.oss-cn-beijing.aliyuncs.com/kindle7_1562726351247.jpg" alt="kindle7"></p>
<p>最终进系统就没什么好说的了，意料之中的延迟，可以接受。另外登录Amazon账号会有点问题，登录现有账号下面按钮显示的却是注册，而且回车以后一直提示失败，最终发现邮箱里躺着Amazon发送的“验证码”，用这个就可以登录。</p>
<h2 id="阅读体验"><a href="#阅读体验" class="headerlink" title="阅读体验"></a>阅读体验</h2><p>刚到手剩余“50%”的电量，在将阅读灯开了20+的情况下，使用了大概八九个小时。感觉在续航上，不太满意，我理想的是充满电工作30h左右。</p>
<p>后面充了电，并将阅读灯关了再使用一下看看没有开阅读灯的续航怎么样，比较不理解的是为什么电纸书阅读器这个体积不提升一下电池，1500mAh还是有一些进步空间的。</p>
<p>因为本身有些近视，所以使用电子设备喜欢靠屏幕很近观看，长时间用Kindle阅读，明显没有用手机或者电脑那种眩目的感觉，体验非常不错。</p>
<p>不多说了，去看书了。😄</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/kindle/" data-id="ckn5z34bu001d15qcbrzcbjay" data-title="入手Kindle" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kindle/" rel="tag">Kindle</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190407-23-design-patterns-and-common-design-patterns" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/23-design-patterns-and-common-design-patterns/" class="article-date">
  <time class="dt-published" datetime="2019-04-07T03:09:36.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/23-design-patterns-and-common-design-patterns/">23种设计模式与常用设计模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h3 id="设计模式-1"><a href="#设计模式-1" class="headerlink" title="设计模式"></a>设计模式</h3><p>设计模式(<code>Design Pattern</code>)是一套被反复使用、多数人知晓的、经过分类的、代码设计经验的总结。</p>
<p>目的是为了代码可重用性、让代码更容易被他人理解、保证代码可靠性。</p>
<h3 id="设计模式三大类型"><a href="#设计模式三大类型" class="headerlink" title="设计模式三大类型"></a>设计模式三大类型</h3><p>设计模式分为三种类型，共23类。</p>
<ul>
<li>创建型模式：创建型模式用来处理对象的创建过程，单例模式、抽象工厂模式、建造者模式、工厂模式、原型模式。</li>
<li>结构型模式：结构型模式用来处理类或者对象的组合，适配器模式、桥接模式、装饰模式、组合模式、外观模式、享元模式、代理模式。</li>
<li>行为型模式：行为型模式用来对类或对象怎样交互和怎样分配职责进行描述，模版方法模式、命令模式、迭代器模式、观察者模式、中介者模式、备忘录模式、解释器模式、状态模式、策略模式、职责链模式、访问者模式。</li>
</ul>
<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式(<code>Singleton Pattern</code>)保证系统中，应用该模式的类一个类只有一个实例。即一个类只有一个对象实例。</p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><h4 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h4><p>第一时间创建实例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 静态构造函数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *该方法由CLR保证，程序第一次使用这个类型前被调用，且只调用一次</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Singleton2</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">Singleton2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton2)&#125;</span>\t构造成功\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//测试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton2)&#125;</span>\t单例模式测试开始\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">        Singleton2 singleton = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = <span class="keyword">new</span> Singleton2();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton2)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 静态字段</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *该方法由CLR保证，程序第一次使用这个类型前被初始化，且只初始化一次</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Singleton3</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton3</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton3)&#125;</span>\t构造成功\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton3 _singleton = <span class="keyword">new</span> Singleton3();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton3 <span class="title">CreateInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> _singleton;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//测试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton3)&#125;</span>\t单例模式测试开始\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">        Singleton3 singleton = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = CreateInstance();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton3)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="懒汉式"><a href="#懒汉式" class="headerlink" title="懒汉式"></a>懒汉式</h4><p>需要才创建实例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 双if判断加锁</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *内层if判断保证单例模式</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *外层if判断避免加锁阻碍多线程运行</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> *加锁避免多线程对象被多次创建</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Singleton1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t构造成功\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton1 _singleton = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> Singleton_Lock = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton1 <span class="title">CreateInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_singleton == <span class="literal">null</span>)<span class="comment">//不为空才去等待锁</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (Singleton_Lock)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t等待锁之后释放\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">                Thread.Sleep(<span class="number">500</span>);</span><br><span class="line">                <span class="keyword">if</span> (_singleton == <span class="literal">null</span>)<span class="comment">//保证不被重复创建</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _singleton = <span class="keyword">new</span> Singleton1();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//测试</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t单例模式测试开始\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">        Singleton1 singleton = <span class="literal">null</span>;</span><br><span class="line">        List&lt;Task&gt; listTask = <span class="keyword">new</span> List&lt;Task&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            listTask.Add(Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = CreateInstance();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        Task.WaitAll(listTask.ToArray());</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Task.Factory.StartNew(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                singleton = CreateInstance();</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;DateTime.Now.ToString(<span class="string">&quot;HH:mm:ss&quot;</span>)&#125;</span>: <span class="subst">&#123;<span class="keyword">nameof</span>(Singleton1)&#125;</span>\t获取单例\t线程ID为<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>。&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三种工厂模式"><a href="#三种工厂模式" class="headerlink" title="三种工厂模式"></a>三种工厂模式</h2><p>简单工厂、工厂方法、抽象工厂都属于设计模式中的创建型模式。其主要功能都是帮助我们把对象的实例化部分抽象取了出来，优化了系统的架构，并且增强了系统的扩展性。</p>
<h3 id="简单工厂"><a href="#简单工厂" class="headerlink" title="简单工厂"></a>简单工厂</h3><p>简单工厂(<code>Simple Factory</code>)：简单工厂模式的工厂类一般是使用静态方法，通过接收的参数不同来返回不同的对象实例。不修改代码的话，是无法扩展的。  </p>
<ul>
<li>优点：客户端可以免除直接创建产品对象的责任，而仅仅是“消费”产品。简单工厂模式通过这种做法实现了对责任的分割。</li>
<li>缺点：由于工厂类集中了所有实例的创建逻辑，违反了高内聚责任分配原则，将全部创建逻辑集中到了一个工厂类中；它所能创建的类只能是事先考虑到的，如果需要添加新的类，则就需要改变工厂类了。</li>
</ul>
<p>配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;BallType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Test.exe,Test.Factory.Basketball&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appSettings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实体与枚举</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sportsman</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sportsman</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">bool</span> gender, <span class="built_in">int</span> age, <span class="built_in">string</span> country</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Name = name;</span><br><span class="line">        Gender = gender;</span><br><span class="line">        Age = age;</span><br><span class="line">        Country = country;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Country &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PlayGame</span>(<span class="params">IBall ball</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;You&#x27;re watching <span class="subst">&#123;ball.PlayGame()&#125;</span> The name of the sportsman is <span class="subst">&#123;Name&#125;</span>. <span class="subst">&#123;(Gender ? <span class="string">&quot;He&quot;</span> : <span class="string">&quot;She&quot;</span>)&#125;</span> is a <span class="subst">&#123;Age&#125;</span> years old <span class="subst">&#123;(Gender ? <span class="string">&quot;boy&quot;</span> : <span class="string">&quot;girl&quot;</span>)&#125;</span> from <span class="subst">&#123;Country&#125;</span>.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> BallType</span><br><span class="line">&#123;</span><br><span class="line">    Basketball,</span><br><span class="line">    Football,</span><br><span class="line">    Baseball,</span><br><span class="line">    Volleyball</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>简单工厂</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SimpleFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sportsman sportsman = <span class="keyword">new</span> Sportsman(<span class="string">&quot;Kangkang&quot;</span>, <span class="literal">true</span>, <span class="number">17</span>, <span class="string">&quot;China&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            Basketball basketball = <span class="keyword">new</span> Basketball();<span class="comment">//1.左右都是细节</span></span><br><span class="line">            sportsman.PlayGame(basketball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            IBall ball = <span class="keyword">new</span> Football();<span class="comment">//2.左边是抽象 右边是细节</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//遵循依赖倒置 但是违背了单一职责</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-转移细节********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallGame(BallType.Volleyball);<span class="comment">//3.没有细节 细节被转移</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//结合配置项+反射 IOC雏形</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-配置项********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallFromConfiguration();</span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> **集中了矛盾**</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 细节没有消失只是转移</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转移了矛盾并没有消除矛盾</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallGame</span>(<span class="params">BallType type</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IBall ball = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> BallType.Basketball:</span><br><span class="line">                ball = <span class="keyword">new</span> Basketball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Football:</span><br><span class="line">                ball = <span class="keyword">new</span> Football();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Baseball:</span><br><span class="line">                ball = <span class="keyword">new</span> Baseball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Volleyball:</span><br><span class="line">                ball = <span class="keyword">new</span> Volleyball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;unknown ball type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IOC的雏形</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallFromConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] aTemp = ConfigurationManager.AppSettings.Get(<span class="string">&quot;BallType&quot;</span>).Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        Assembly assembly = Assembly.LoadFrom(aTemp[<span class="number">0</span>]);</span><br><span class="line">        Type type = assembly.GetType(aTemp[<span class="number">1</span>]);</span><br><span class="line">        IBall ball = Activator.CreateInstance(type) <span class="keyword">as</span> IBall;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Baseball</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a baseball tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Football</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a football tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Baseball</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a baseball tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Volleyball</span> : <span class="title">IBall</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">PlayGame</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;a volleyball tv show.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单工厂实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SimpleFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sportsman sportsman = <span class="keyword">new</span> Sportsman(<span class="string">&quot;Kangkang&quot;</span>, <span class="literal">true</span>, <span class="number">17</span>, <span class="string">&quot;China&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            Basketball basketball = <span class="keyword">new</span> Basketball();<span class="comment">//1.左右都是细节</span></span><br><span class="line">            sportsman.PlayGame(basketball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            IBall ball = <span class="keyword">new</span> Football();<span class="comment">//2.左边是抽象 右边是细节</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//遵循依赖倒置 但是违背了单一职责</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-转移细节********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallGame(BallType.Volleyball);<span class="comment">//3.没有细节 细节被转移</span></span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//结合配置项+反射 IOC雏形</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********简单工厂-配置项********&quot;</span>);</span><br><span class="line">            IBall ball = CreateBallFromConfiguration();</span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> **集中了矛盾**</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 细节没有消失只是转移</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转移了矛盾并没有消除矛盾</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;type&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallGame</span>(<span class="params">BallType type</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IBall ball = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> BallType.Basketball:</span><br><span class="line">                ball = <span class="keyword">new</span> Basketball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Football:</span><br><span class="line">                ball = <span class="keyword">new</span> Football();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Baseball:</span><br><span class="line">                ball = <span class="keyword">new</span> Baseball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> BallType.Volleyball:</span><br><span class="line">                ball = <span class="keyword">new</span> Volleyball();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;unknown ball type.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> IOC的雏形</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBall <span class="title">CreateBallFromConfiguration</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span>[] aTemp = ConfigurationManager.AppSettings.Get(<span class="string">&quot;BallType&quot;</span>).Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        Assembly assembly = Assembly.LoadFrom(aTemp[<span class="number">0</span>]);</span><br><span class="line">        Type type = assembly.GetType(aTemp[<span class="number">1</span>]);</span><br><span class="line">        IBall ball = Activator.CreateInstance(type) <span class="keyword">as</span> IBall;</span><br><span class="line">        <span class="keyword">return</span> ball;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h3><p>工厂方法(<code>Factory Method</code>)：工厂方法是针对每一种产品提供一个工厂类。通过不同的工厂实例来创建不同的产品实例。在同一等级结构中，支持增加任意产品。</p>
<ul>
<li>优点：允许系统在不修改具体工厂角色的情况下引进新产品。</li>
<li>缺点：由于每加一个产品，就需要加一个产品工厂的类，增加了额外的开发量。</li>
</ul>
<p>提供工厂类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Baseball();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FootballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Football();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Baseball();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VolleyballFactory</span> : <span class="title">IFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBall <span class="title">CreateBall</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Volleyball();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>工厂方法实现</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FactoryMethod</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sportsman sportsman = <span class="keyword">new</span> Sportsman(<span class="string">&quot;Kangkang&quot;</span>, <span class="literal">true</span>, <span class="number">17</span>, <span class="string">&quot;China&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//每个业务对应一个工厂 将业务细节的依赖转移到中间层（工厂）</span></span><br><span class="line">            <span class="comment">//优点：允许系统在不修改具体工厂角色的情况下引进新产品</span></span><br><span class="line">            <span class="comment">//缺点：由于每加一个产品，就需要加一个产品工厂的类，增加了额外的开发量</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;********工厂方法********&quot;</span>);</span><br><span class="line">            IFactory factory = <span class="keyword">new</span> BasketballFactory();</span><br><span class="line">            IBall ball = factory.CreateBall();</span><br><span class="line">            sportsman.PlayGame(ball);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><p>抽象工厂(<code>Abstract Factory</code>)：抽象工厂是应对产品族概念的。应对产品族概念而生，增加新的产品线很容易，但是无法增加新的产品。比如，每个汽车公司可能要同时生产轿车、货车、客车，那么每一个工厂都要有创建轿车、货车和客车的方法。</p>
<ul>
<li>优点：向客户端提供一个接口，使得客户端在不必指定产品具体类型的情况下，创建多个产品族中的产品对象。</li>
<li>缺点：增加新的产品等级结构很复杂，需要修改抽象工厂和所有的具体工厂类，对“开闭原则”的支持呈现倾斜性。</li>
</ul>
<p>例如游戏加载需要英雄、资源、技能等</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbstractFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> IHero <span class="title">CreateHero</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ISkill <span class="title">CreateSkill</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> IResource <span class="title">CreateResource</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> IWeapon <span class="title">CreateWeapon</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IHero</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowHero</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISkill</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowSkill</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IResource</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowResource</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IWeapon</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">ShowWeapon</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h2><p>装饰器模式(Decorator Pattern)：允许向一个现有的对象添加新的功能，同时又不改变其结构。这种类型的设计模式属于结构型模式，它是作为现有的类的一个包装。这种模式创建了一个装饰类，用来包装原有的类，并在保持类方法签名完整性的前提下，提供了额外的功能。动态地给一个对象添加一些额外的职责。</p>
<p>就增加功能来说，装饰器模式相比生成子类更为灵活。一般的，我们为了扩展一个类经常使用继承方式实现，由于继承为类引入静态特征，并且随着扩展功能的增多，子类会很膨胀。</p>
<p><strong>类与类之间的关系：</strong> 纵向有继承和实现，横向有依赖、关联、组合、聚合。<strong>结构型设计模式：组合优于继承</strong>。</p>
<ul>
<li>优点：装饰类和被装饰类可以独立发展，不会相互耦合，装饰模式是继承的一个替代模式，装饰模式可以动态扩展一个实现类的功能。</li>
<li>缺点：多层装饰比较复杂。</li>
</ul>
<p>学生学习免费或付费课程享有不同的权利，除享受免费课程外，付费学生还有课前资料预习、课后作业指导、资料复习。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbstractStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        AbstractStudent student = <span class="keyword">new</span> VIPStudent() &#123; Id = <span class="number">999</span>, Name = <span class="string">&quot;Kangkang&quot;</span> &#125;;</span><br><span class="line">        student.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        StudentPreviewDecorator previewStudent = <span class="keyword">new</span> StudentPreviewDecorator(student);</span><br><span class="line">        previewStudent.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        AbstractStudent abstractStudent = <span class="keyword">new</span> StudentPreviewDecorator(student);</span><br><span class="line">        abstractStudent.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        student = <span class="keyword">new</span> StudentPayDecorator(student);</span><br><span class="line">        student = <span class="keyword">new</span> StudentPreviewDecorator(student);</span><br><span class="line">        student = <span class="keyword">new</span> StudentHomeworkDecorator(student);</span><br><span class="line">        student = <span class="keyword">new</span> StudentReviewDecorator(student);</span><br><span class="line">        student.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PoolStudent</span> : <span class="title">AbstractStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Take free courses.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">VIPStudent</span> : <span class="title">AbstractStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Take free and paid courses.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继承也可以实现，但是不够灵活</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseStudentInherit</span> : <span class="title">VIPStudent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Pay.&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Preview.&quot;</span>);</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>付费、预习、作业、复习等装饰器</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentPayDecorator</span> : <span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentPayDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Pay.&quot;</span>);</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentPreviewDecorator</span> : <span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentPreviewDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Preview.&quot;</span>);</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentHomeworkDecorator</span> : <span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentHomeworkDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Do homework.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentReviewDecorator</span>:<span class="title">BaseStudentDecorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StudentReviewDecorator</span>(<span class="params">AbstractStudent student</span>) : <span class="title">base</span>(<span class="params">student</span>)</span></span><br><span class="line"><span class="function"></span>    &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Study</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.Study();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Review.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>代理模式(<code>Proxy Pattern</code>)：一个类代表另一个类的功能，为其他对象提供一种代理以控制对这个对象的访问。主要解决在直接访问对象时带来的问题，比如说：要访问的对象在远程的机器上。</p>
<p>在面向对象系统中，有些对象由于某些原因（比如对象创建开销很大，或者某些操作需要安全控制，或者需要进程外的访问），直接访问会给使用者或者系统结构带来很多麻烦，我们可以在访问此对象时加上一个对此对象的访问层。</p>
<p>优点：</p>
<ul>
<li>职责清晰。 </li>
<li>高扩展性。</li>
<li>智能化。</li>
</ul>
<p>缺点：</p>
<ul>
<li>由于在客户端和真实主题之间增加了代理对象，因此有些类型的代理模式可能会造成请求的处理速度变慢。</li>
<li>实现代理模式需要额外的工作，有些代理模式的实现非常复杂。</li>
</ul>
<p>代理模式：只能传达原有逻辑，不能新增业务逻辑。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">GetSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RealSubject</span> : <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Passenger by train.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">GetSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Passengers buy tickets.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProxySubject</span> : <span class="title">ISubject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> ISubject _subject = <span class="keyword">new</span> RealSubject();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DoSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Before do something.&quot;</span>);</span><br><span class="line">        <span class="built_in">bool</span> result = _subject.DoSomething();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;After do something.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">GetSomething</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Before get something.&quot;</span>);</span><br><span class="line">        <span class="built_in">bool</span> result = _subject.GetSomething();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;After get something.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ISubject realSubject = <span class="keyword">new</span> RealSubject();</span><br><span class="line">        realSubject.GetSomething();</span><br><span class="line">        realSubject.DoSomething();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************************&quot;</span>);</span><br><span class="line">        ISubject proxySubject = <span class="keyword">new</span> ProxySubject();</span><br><span class="line">        proxySubject.GetSomething();</span><br><span class="line">        proxySubject.DoSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>观察者模式(<code>Observer Pattern</code>)：当对象间存在一对多关系时，则使用观察者模式。比如，当一个对象被修改时，则会自动通知它的依赖对象。</p>
<p>观察者模式属于行为型模式。定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</p>
<p>主要解决一个对象状态改变给其他对象通知的问题，而且要考虑到易用和低耦合，保证高度的协作。</p>
<p>优点：</p>
<ul>
<li>观察者和被观察者是抽象耦合的。</li>
<li>建立一套触发机制。</li>
</ul>
<p>缺点：</p>
<ul>
<li>如果一个被观察者对象有很多的直接和间接的观察者的话，将所有的观察者都通知到会花费很多时间。</li>
<li>如果在观察者和观察目标之间有循环依赖的话，观察目标会触发它们之间进行循环调用，可能导致系统崩溃。 </li>
<li>观察者模式没有相应的机制让观察者知道所观察的目标对象是怎么发生变化的，而仅仅只是知道观察目标发生了变化。</li>
</ul>
<p>一只神奇的猫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 一直神奇的猫，猫叫之后触发：</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Baby cry</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Brother turn</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Dog woof</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Father roar</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Mother whisper</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Mouse run</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Neighbor awake</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Stealer hide</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Cat</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Meow</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> meow...&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> Brother().Turn();</span><br><span class="line">        <span class="keyword">new</span> Dog().Woof();</span><br><span class="line">        <span class="keyword">new</span> Father().Roar();</span><br><span class="line">        <span class="keyword">new</span> Mother().Whisper();</span><br><span class="line">        <span class="keyword">new</span> Mouse().Run();</span><br><span class="line">        <span class="keyword">new</span> Neighbor().Awake();</span><br><span class="line">        <span class="keyword">new</span> Stealer().Hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> Action MeowHandler;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MeowEvent</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> meow...&quot;</span>);</span><br><span class="line">        MeowHandler?.Invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">List</span>&lt;<span class="title">IObserver</span>&gt; _listObserver</span> = <span class="keyword">new</span> List&lt;IObserver&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _listObserver.Add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Remove</span>(<span class="params">IObserver observer</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _listObserver.Remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MeowObserver</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> meow...&quot;</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> _listObserver)</span><br><span class="line">        &#123;</span><br><span class="line">            item.Action();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************普通方法************&quot;</span>);</span><br><span class="line">        Cat cat = <span class="keyword">new</span> Cat();</span><br><span class="line">        cat.Meow();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************ 事  件 ************&quot;</span>);</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Brother().Turn();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Dog().Woof();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Father().Roar();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Mother().Whisper();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Mouse().Run();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Neighbor().Awake();</span><br><span class="line">        cat.MeowHandler += () =&gt; <span class="keyword">new</span> Stealer().Hide();</span><br><span class="line">        cat.MeowEvent();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;************观 察 者************&quot;</span>);</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Brother());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Dog());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Father());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Mother());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Mouse());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Neighbor());</span><br><span class="line">        cat.Add(<span class="keyword">new</span> Stealer());</span><br><span class="line">        cat.MeowObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Baby</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Cry();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Cry</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> cry...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Brother</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Turn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Turn</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> turn...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Dog</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Woof();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Woof</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> Woof...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Father</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Roar();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Roar</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> roar...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mother</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Whisper();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Whisper</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> whisper...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mouse</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> Run...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Neighbor</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Awake();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> awake...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Stealer</span> : <span class="title">IObserver</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Action</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Hide</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetType().Name&#125;</span> hide...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/23-design-patterns-and-common-design-patterns/" data-id="ckn5z34g700e915qc0gv5hru5" data-title="23种设计模式与常用设计模式" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190407-six-principles-of-design-mode" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/six-principles-of-design-mode/" class="article-date">
  <time class="dt-published" datetime="2019-04-07T02:48:40.000Z" itemprop="datePublished">2019-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/six-principles-of-design-mode/">设计模式六大原则</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h2><p>（<code>Single Responsibility Principle</code> 简称 ：<code>SRP</code>）</p>
<p>定义：应该有且仅有一个原因引起类的变更。</p>
<p>接口的职责在设计时应该做到单一，降低类的复杂性，实现的职责都有明确的定义，提高了可读性、可维护性、可扩展性；</p>
<p>变更引起的风险降低，如果接口隔离性做的好，一个接口的修改只对相应实现类有影响，对其它接口没有影响，降低了耦合性。</p>
<blockquote>
<p>单一职责提出了一个编写程序的标准，用“职责”或“变化原因”来衡量接口或类设计的是否优良，但是“职责”或“变化原因”都是不可度量的，因项目而异，因环境而异。</p>
</blockquote>
<h2 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a>里氏替换原则</h2><p>（<code>Liskov Substitution Principle</code> 简称：<code>LSP</code>）</p>
<p>定义：是面向对象设计的基本原则之一，只要父类能出现的地方子类就能出现，而且替换为子类也不会产生任何错误或异常。</p>
<ul>
<li>子类必须完全实现父类的方法</li>
<li>子类可以有自己的个性</li>
<li>覆盖或实现父类的方法时输入参数可以被放大</li>
<li>覆盖或实现父类的方法时输出结果可以被缩小</li>
</ul>
<p>优点：</p>
<ul>
<li>代码共享，减少创建类的工作量</li>
<li>提高代码的重用性</li>
<li>子类可以形似父类，但又异于父类</li>
<li>提高代码的可扩展性</li>
<li>提高产品或项目的开放性</li>
</ul>
<p>缺点：</p>
<ul>
<li>继承是侵入性的，只要继承就必须拥有父类的所有属性和方法</li>
<li>降低代码的灵活性</li>
<li>增强了耦合性，父类的常量、变量、方法被修改时，要考虑到子类的修改，在缺乏规范的环境下，可能有许多代码需要重构。</li>
</ul>
<blockquote>
<p><code>LSP</code> 原则是继承复用的基石，只有当子类能够替换掉父类，软件单位功能不受影响时，父类才能被真正复用。<code>LSP</code> 原则是对开闭原则的补充，实现开闭原则的关键步骤就是抽象化，而父类与子类的继承关  系就是抽象化的具体实现，所以里氏代换原则是对实现抽象化的具体步骤的规范。</p>
</blockquote>
<h2 id="依赖倒置原则"><a href="#依赖倒置原则" class="headerlink" title="依赖倒置原则"></a>依赖倒置原则</h2><p>（<code>Dependence  Inversion Principle</code> 简称：<code>DIP</code>）</p>
<p>定义：是“面向接口编程” –面向对象设计的精髓之一，是六个原则中最难实现的一个原则，是实现开闭原则的重要途径。</p>
<ul>
<li>模块间的依赖通过抽象发生，实现类之间不发生直接的依赖关系，其依赖是通过接口和抽象类发生的</li>
<li>接口或抽象类不依赖于实现类</li>
<li>实现类依赖于接口或抽象类</li>
</ul>
<p>优点：</p>
<ul>
<li>可以减少类之间的耦合性，提高系统的稳定性</li>
<li>降低并行开发引起的风险</li>
<li>提高代码的可读性和可维护性</li>
</ul>
<p>依赖的三种写法：</p>
<ul>
<li>构造函数传递依赖对象</li>
<li>setter方法传递依赖对象</li>
<li>接口声明依赖对象</li>
</ul>
<p>本质是通过抽象使各个类或模块的实现彼此独立，不互相影响，实现模块间的松耦合，应遵循的原则：</p>
<ul>
<li>每个类尽量都有接口或抽象类</li>
<li>变量的表面类型尽量是接口或者抽象类</li>
<li>任何类都不应从具体类中派生</li>
<li>尽量不要复写基类的方法</li>
<li>结合里氏替换原则使用</li>
</ul>
<p>依赖倒置原则是设计模式；<br>控制反转(<code>IoC</code>:将组件间的依赖关系从程序内部提到外部来管理)是目的；<br>依赖注入(<code>DI</code>:将组件的依赖通过外部以参数或其他形式注入)是实现控制反转的方式。</p>
<h2 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h2><p>（<code>Interface Segregation Principle</code> 简称：<code>ISP</code>）</p>
<p>定义：客户端不应依赖它不需要的接口，类间的依赖关系应建立在最小的接口上（降低耦合度）</p>
<ul>
<li>接口尽量小（拆分接口时，首先必须满足单一职责原则）</li>
<li>接口要高内聚（尽量少公布 <code>public</code> 方法）</li>
<li>定制服务（模块间必然会有耦合，有耦合就要有相互访问的接口，设计时应为访问者提供定制服务）</li>
<li>接口的设计是有限度的（接口的设计粒度越小，接口越灵活，要把握一个度）</li>
</ul>
<p>实践中可根据以下几个规则衡量：</p>
<ul>
<li>一个接口只服务于一个子模块或业务逻辑</li>
<li>通过业务逻辑压缩接口中的public方法</li>
<li>已经被污染的接口，尽量去修改，若变更风险较大，则采用适配器模式进行转化处理</li>
<li>了解环境，拒绝盲从，环境不同，接口拆分的标准就不同，应深入了解业务逻辑，设计出灵活的接口</li>
</ul>
<h2 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h2><p>（<code>Law of Demeter</code> 简称：<code>LoD</code>）又称最少知识原则</p>
<p>定义：一个类应该对自己需要耦合或调用的类知道的最少</p>
<ul>
<li>只和直接的朋友交流</li>
<li>朋友之间也是有距离的</li>
<li>是自己的就是自己的（如果一个方法放在本类中，既不增加类间的关系，也对本类不产生负面影响，那就放在本类中）</li>
<li>谨慎使用 <code>Serializable</code> (远程调用传个vo，必须实现 <code>Serializable</code> 接口，如果有一天修改了访问权限，权限扩大了，但是服务器上没有做相应的变更，就会报序列化失败)</li>
</ul>
<h2 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h2><p>（Open-Closed Principle 简称：OCP）</p>
<p>定义：对扩展开放，对修改关闭，在程序需要扩展的时候，不能修改原有的代码，实现热插拔的效果。为了使程序的扩展性好，易于维护和升级，需要使用接口和抽象类。  </p>
<p>注意事项：</p>
<ul>
<li>通过对接口或者抽象类约束扩展，对扩展进行边界限定，不允许出现在接口或抽象类中不存在的public方法</li>
<li>参数类型、引用对象尽量使用接口或抽象类，而不是实现类</li>
<li>抽象层尽量保持稳定，一旦确定不允许修改</li>
</ul>
<p>如何使用：</p>
<ul>
<li>抽象约束（实现对扩展开放的首要前提，对扩展进行边界限定）</li>
<li>元数据控制模块行为</li>
<li>制定项目章程（对项目来说，规定优于配置）</li>
<li>封装变化<ul>
<li>将相同的变化封装到一个接口或抽象类中；</li>
<li>将不同的变化封装到不同的接口或抽象类中；</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/six-principles-of-design-mode/" data-id="ckn5z34bv001f15qch3gnf85r" data-title="设计模式六大原则" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190406-aop" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/aop/" class="article-date">
  <time class="dt-published" datetime="2019-04-06T05:36:00.000Z" itemprop="datePublished">2019-04-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/aop/">AOP 面向切面编程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="AOP-面向切面编程"><a href="#AOP-面向切面编程" class="headerlink" title="AOP 面向切面编程"></a><code>AOP</code> 面向切面编程</h2><h3 id="与-OOP-面向对象编程的关系"><a href="#与-OOP-面向对象编程的关系" class="headerlink" title="与 OOP 面向对象编程的关系"></a>与 <code>OOP</code> 面向对象编程的关系</h3><p><code>AOP</code>（<code>Aspect-Oriented Programming</code>，面向方面编程），可以说是 <code>OOP（Object-Oriented Programing</code> ，面向对象编程）的补充和完善。  </p>
<p><code>OOP</code> 引入封装、继承和多态性等概念来建立一种对象层次结构，用以模拟公共行为的一个集合。当我们需要为分散的对象引入公共行为的时候，<code>OOP</code> 则显得无能为力。也就是说， <code>OOP</code> 允许你定义从上到下的关系，但并不适合定义从左到右的关系。例如日志功能。日志代码往往水平地散布在所有对象层次中，而与它所散布到的对象的核心功能毫无关系。对于其他类型的代码，如安全性、异常处理和透明的持续性也是如此。这种散布在各处的无关的代码被称为横切（<code>cross-cutting</code>）代码，在 <code>OOP</code> 设计中，它导致了大量代码的重复，而不利于各个模块的重用。  </p>
<p>而 <code>AOP</code> 技术则恰恰相反，它利用一种称为“横切”的技术，剖解开封装的对象内部，并将那些影响了多个类的公共行为封装到一个可重用模块，并将其名为“<code>Aspect</code>”，即方面。  </p>
<p>所谓“方面”，简单地说，就是将那些与业务无关，却为业务模块所共同调用的逻辑或责任封装起来，便于减少系统的重复代码，降低模块间的耦合度，并有利于未来的可操作性和可维护性。<code>AOP</code> 代表的是一个横向的关系，如果说“对象”是一个空心的圆柱体，其中封装的是对象的属性和行为；那么面向方面编程的方法，就仿佛一把利刃，将这些空心圆柱体剖开，以获得其内部的消息。而剖开的切面，也就是所谓的“方面”了。然后它又以巧夺天功的妙手将这些剖开的切面复原，不留痕迹。  </p>
<p>使用“横切”技术，<code>AOP</code> 把软件系统分为两个部分：核心关注点和横切关注点。业务处理的主要流程是核心关注点，与之关系不大的部分是横切关注点。横切关注点的一个特点是，他们经常发生在核心关注点的多处，而各处都基本相似。比如权限认证、日志、事务处理。<code>Aop</code> 的作用在于分离系统中的各种关注点，将核心关注点和横切关注点分离开来。正如 <code>Avanade</code> 公司的高级方案构架师 <code>Adam Magee</code> 所说，<code>AOP</code> 的核心思想就是“将应用程序中的商业逻辑同对其提供支持的通用服务进行分离。”</p>
<h2 id="AOP-技术的实现"><a href="#AOP-技术的实现" class="headerlink" title="AOP 技术的实现"></a><code>AOP</code> 技术的实现</h2><p>主要分为两大类：一是采用动态代理技术，利用截取消息的方式，对该消息进行装饰，以取代原有对象行为的执行；二是采用静态织入的方式，引入特定的语法创建“方面”，从而使得编译器可以在编译期间织入有关“方面”的代码。然而殊途同归，实现 <code>AOP</code> 的技术特性却是相同的。</p>
<h3 id="装饰器模式实现静态代理"><a href="#装饰器模式实现静态代理" class="headerlink" title="装饰器模式实现静态代理"></a>装饰器模式实现静态代理</h3><p><code>AOP</code> 在方法的前后增加自定义的方法。详见：<code>Decorator.Show()</code> 方法，静态装饰器实现，并不推荐。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Decorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User() &#123; Name = <span class="string">&quot;John&quot;</span>, Password = <span class="string">&quot;12345678&quot;</span> &#125;;</span><br><span class="line">        IUserProcessor processor = <span class="keyword">new</span> UserProcessor();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用普通方法完成注册******&quot;</span>);</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用装饰器模式完成注册******&quot;</span>);</span><br><span class="line">        processor = <span class="keyword">new</span> UserProcessorDecorator(processor);</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserProcessor</span> : <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;成功注册用户：<span class="subst">&#123;user.Name&#125;</span> 密码：<span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 装饰器模式去提供一个AOP功能</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserProcessorDecorator</span> : <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> IUserProcessor UserProcessor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserProcessorDecorator</span>(<span class="params">IUserProcessor processor</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            UserProcessor = processor;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            PreProceed(user);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.UserProcessor.RegistUser(user);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            PostProced(user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PreProceed</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;注册用户：<span class="subst">&#123;user.Name&#125;</span> 密码：<span class="subst">&#123;user.Password&#125;</span> 之前&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PostProced</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;注册用户：<span class="subst">&#123;user.Name&#125;</span> 密码：<span class="subst">&#123;user.Password&#125;</span> 之后&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用-Net-Remoting-RealProxy-实现动态代理"><a href="#使用-Net-Remoting-RealProxy-实现动态代理" class="headerlink" title="使用 .Net Remoting/RealProxy 实现动态代理"></a>使用 <code>.Net Remoting/RealProxy</code> 实现动态代理</h3><p>详见 <code>Proxy.Show()</code> 方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Proxy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User() &#123; Name = <span class="string">&quot;John&quot;</span>, Password = <span class="string">&quot;12345678&quot;</span> &#125;;</span><br><span class="line">        IUserProcessor processor = <span class="keyword">new</span> UserProcessor();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用普通方法完成注册******&quot;</span>);</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用动态代理完成注册******&quot;</span>);</span><br><span class="line">        UserProcessor userProcessor = TransparentProxy.Create&lt;UserProcessor&gt;();</span><br><span class="line">        userProcessor.RegistUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserProcessor</span> : <span class="title">MarshalByRefObject</span>, <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;成功注册用户：<span class="subst">&#123;user.Name&#125;</span> 密码：<span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyRealProxy</span>&lt;<span class="title">T</span>&gt; : <span class="title">RealProxy</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> T tTarget;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyRealProxy</span>(<span class="params">T target</span>) : <span class="title">base</span>(<span class="params"><span class="keyword">typeof</span>(T</span>))</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.tTarget = target;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> IMessage <span class="title">Invoke</span>(<span class="params">IMessage msg</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            PreProceed(msg);</span><br><span class="line">            IMethodCallMessage callMessage = (IMethodCallMessage)msg;</span><br><span class="line">            <span class="built_in">object</span> returnValue = callMessage.MethodBase.Invoke(<span class="keyword">this</span>.tTarget, callMessage.Args);</span><br><span class="line">            PostProced(msg);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReturnMessage(returnValue, <span class="keyword">new</span> <span class="built_in">object</span>[<span class="number">0</span>], <span class="number">0</span>, <span class="literal">null</span>, callMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PreProceed</span>(<span class="params">IMessage msg</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IMethodCallMessage callMessage = (IMethodCallMessage)msg;</span><br><span class="line">            StringBuilder sbInfo = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">if</span> (callMessage.Args.Length &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PropertyInfo[] props = callMessage.Args[<span class="number">0</span>].GetType().GetProperties();</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; props.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    sbInfo.Append(<span class="string">$&quot;<span class="subst">&#123;props[i].Name&#125;</span>:<span class="subst">&#123;props[i].GetValue(callMessage.Args[<span class="number">0</span>], <span class="literal">null</span>)&#125;</span> &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;方法执行前：<span class="subst">&#123;sbInfo.ToString().TrimEnd()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PostProced</span>(<span class="params">IMessage msg</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IMethodCallMessage callMessage = (IMethodCallMessage)msg;</span><br><span class="line">            StringBuilder sbInfo = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">if</span> (callMessage.Args.Length &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PropertyInfo[] props = callMessage.Args[<span class="number">0</span>].GetType().GetProperties();</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; props.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    sbInfo.Append(<span class="string">$&quot;<span class="subst">&#123;props[i].Name&#125;</span>:<span class="subst">&#123;props[i].GetValue(callMessage.Args[<span class="number">0</span>], <span class="literal">null</span>)&#125;</span> &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;方法执行后：<span class="subst">&#123;sbInfo.ToString().TrimEnd()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> TransparentProxy</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">TransparentProxy</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Create</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            T instance = Activator.CreateInstance&lt;T&gt;();</span><br><span class="line">            MyRealProxy&lt;T&gt; proxy = <span class="keyword">new</span> MyRealProxy&lt;T&gt;(instance);</span><br><span class="line">            T transparentProxy = (T)proxy.GetTransparentProxy();</span><br><span class="line">            <span class="keyword">return</span> transparentProxy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用-Castle-DynamicProxy-实现动态代理"><a href="#使用-Castle-DynamicProxy-实现动态代理" class="headerlink" title="使用 Castle/DynamicProxy 实现动态代理"></a>使用 <code>Castle/DynamicProxy</code> 实现动态代理</h3><p>详见 <code>CastleProxy.Show()</code> 方法。（<code>nuget</code> 安装 <code>Castle.DynamicProxy</code> 或 <code>Castle.Core</code>）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CastleProxy</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User() &#123; Name = <span class="string">&quot;John&quot;</span>, Password = <span class="string">&quot;12345678&quot;</span> &#125;;</span><br><span class="line">        IUserProcessor processor = <span class="keyword">new</span> UserProcessor();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用普通方法完成注册******&quot;</span>);</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用动态代理完成注册******&quot;</span>);</span><br><span class="line">        ProxyGenerator generator = <span class="keyword">new</span> ProxyGenerator();</span><br><span class="line">        MyInterceptor interceptor = <span class="keyword">new</span> MyInterceptor();</span><br><span class="line">        processor = generator.CreateClassProxy&lt;UserProcessor&gt;(interceptor);</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserProcessor</span> : <span class="title">MarshalByRefObject</span>, <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 必须是虚方法</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;user&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;成功注册用户：<span class="subst">&#123;user.Name&#125;</span> 密码：<span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyInterceptor</span> : <span class="title">IInterceptor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            PreProceed(invocation);</span><br><span class="line">            invocation.Proceed();</span><br><span class="line">            PostProced(invocation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PreProceed</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            StringBuilder sbInfo = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">if</span> (invocation.Arguments.Length &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PropertyInfo[] props = invocation.Arguments[<span class="number">0</span>].GetType().GetProperties();</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; props.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    sbInfo.Append(<span class="string">$&quot;<span class="subst">&#123;props[i].Name&#125;</span>:<span class="subst">&#123;props[i].GetValue(invocation.Arguments[<span class="number">0</span>], <span class="literal">null</span>)&#125;</span> &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;方法执行前：<span class="subst">&#123;sbInfo.ToString().TrimEnd()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PostProced</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            StringBuilder sbInfo = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">if</span> (invocation.Arguments.Length &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                PropertyInfo[] props = invocation.Arguments[<span class="number">0</span>].GetType().GetProperties();</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; props.Length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    sbInfo.Append(<span class="string">$&quot;<span class="subst">&#123;props[i].Name&#125;</span>:<span class="subst">&#123;props[i].GetValue(invocation.Arguments[<span class="number">0</span>], <span class="literal">null</span>)&#125;</span> &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;方法执行后：<span class="subst">&#123;sbInfo.ToString().TrimEnd()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用-EntLib-PIBA-Unity-实现动态代理"><a href="#使用-EntLib-PIBA-Unity-实现动态代理" class="headerlink" title="使用 EntLib/PIBA Unity 实现动态代理"></a>使用 <code>EntLib/PIBA Unity</code> 实现动态代理</h3><p>详见 <code>UnityAOP.Show()</code> 方法。（<code>nuget</code> 安装<code>Unity 4.0.1</code> 与 <code>Unity.Interception</code>）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnityAOP</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User() &#123; Name = <span class="string">&quot;John&quot;</span>, Password = <span class="string">&quot;12345678&quot;</span> &#125;;</span><br><span class="line">        IUserProcessor processor = <span class="keyword">new</span> UserProcessor();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用普通方法完成注册******&quot;</span>);</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;******使用动态代理完成注册******&quot;</span>);</span><br><span class="line">        IUnityContainer container = <span class="keyword">new</span> UnityContainer();<span class="comment">//声明一个容器</span></span><br><span class="line">        container.RegisterType&lt;IUserProcessor, UserProcessor&gt;();<span class="comment">//声明UnityContainer</span></span><br><span class="line">        processor = container.Resolve&lt;IUserProcessor&gt;();</span><br><span class="line">        processor.RegistUser(user);<span class="comment">//调用</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//AOP</span></span><br><span class="line">        container.AddNewExtension&lt;Interception&gt;().Configure&lt;Interception&gt;().SetInterceptorFor&lt;IUserProcessor&gt;(<span class="keyword">new</span> InterfaceInterceptor());</span><br><span class="line">        processor = container.Resolve&lt;IUserProcessor&gt;();</span><br><span class="line">        processor.RegistUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 特性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserHanlerAttribute</span> : <span class="title">HandlerAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ICallHandler <span class="title">CreateHandler</span>(<span class="params">IUnityContainer container</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ICallHandler handler = <span class="keyword">new</span> UserHandler() &#123; Order = <span class="keyword">this</span>.Order &#125;;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogHandlerAttribute</span> : <span class="title">HandlerAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ICallHandler <span class="title">CreateHandler</span>(<span class="params">IUnityContainer container</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ICallHandler handler = <span class="keyword">new</span> LogHandler() &#123; Order = <span class="keyword">this</span>.Order &#125;;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExceptionHandlerAttribute</span> : <span class="title">HandlerAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ICallHandler <span class="title">CreateHandler</span>(<span class="params">IUnityContainer container</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ICallHandler handler = <span class="keyword">new</span> ExceptionHandler() &#123; Order = <span class="keyword">this</span>.Order &#125;;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AfterLogHandlerAttributeAttribute</span> : <span class="title">HandlerAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ICallHandler <span class="title">CreateHandler</span>(<span class="params">IUnityContainer container</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            ICallHandler handler = <span class="keyword">new</span> AfterLogHandler() &#123; Order = <span class="keyword">this</span>.Order &#125;;</span><br><span class="line">            <span class="keyword">return</span> handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 特性对应的行为</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserHandler</span> : <span class="title">ICallHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IMethodReturn <span class="title">Invoke</span>(<span class="params">IMethodInvocation input, GetNextHandlerDelegate getNext</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;this is the user handler.&quot;</span>);</span><br><span class="line">            User user = input.Arguments[<span class="number">0</span>] <span class="keyword">as</span> User;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;regist user Name: <span class="subst">&#123;user.Name&#125;</span> Password: <span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(user.Name))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;user name can&#x27;t be null, empty or white space.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(user.Password) || user.Password.Length &lt; <span class="number">8</span> || user.Password.Length &gt; <span class="number">32</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;user password can&#x27;t be null, empty or white space, and the password&#x27;s length must between 8-32.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//return getNext.Invoke().Invoke(input, getNext);</span></span><br><span class="line">            <span class="keyword">return</span> getNext()(input, getNext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LogHandler</span> : <span class="title">ICallHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IMethodReturn <span class="title">Invoke</span>(<span class="params">IMethodInvocation input, GetNextHandlerDelegate getNext</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;this is the log handler.&quot;</span>);</span><br><span class="line">            User user = input.Arguments[<span class="number">0</span>] <span class="keyword">as</span> User;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Name: <span class="subst">&#123;user.Name&#125;</span> Password: <span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> getNext()(input, getNext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExceptionHandler</span> : <span class="title">ICallHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IMethodReturn <span class="title">Invoke</span>(<span class="params">IMethodInvocation input, GetNextHandlerDelegate getNext</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IMethodReturn methodReturn = getNext()(input, getNext);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;this is the exception handler.&quot;</span>);</span><br><span class="line">            User user = input.Arguments[<span class="number">0</span>] <span class="keyword">as</span> User;</span><br><span class="line">            <span class="keyword">if</span> (methodReturn.Exception == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;end regist user. Name: <span class="subst">&#123;user.Name&#125;</span> Password: <span class="subst">&#123;user.Password&#125;</span> don&#x27;t have exception.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;end regist user. Name: <span class="subst">&#123;user.Name&#125;</span> Password: <span class="subst">&#123;user.Password&#125;</span> have a exception: <span class="subst">&#123;methodReturn.Exception.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> methodReturn;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AfterLogHandler</span> : <span class="title">ICallHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IMethodReturn <span class="title">Invoke</span>(<span class="params">IMethodInvocation input, GetNextHandlerDelegate getNext</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;this is the end log handler.&quot;</span>);</span><br><span class="line">            User user = input.Arguments[<span class="number">0</span>] <span class="keyword">as</span> User;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;end regist user. Name: <span class="subst">&#123;user.Name&#125;</span> Password: <span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> getNext()(input, getNext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">UserHanler(Order = 1), ExceptionHandler(Order = 3), LogHandler(Order = 2), AfterLogHandlerAttribute(Order = 5)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">GetUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserProcessor</span> : <span class="title">IUserProcessor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RegistUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;成功注册用户：<span class="subst">&#123;user.Name&#125;</span> 密码：<span class="subst">&#123;user.Password&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * TransparentProxyInterceptor：直接在类的方法上进行标记，但是这个类必须继承MarshalByRefObject，不建议使用。</span></span><br><span class="line"><span class="comment">     * VirtualMethod：直接在类的方法上进行标记，但是这个方法必须是虚方法。</span></span><br><span class="line"><span class="comment">     * InterfaceInterceptor：在接口的方法上进行标记，这样继承这个接口的类里实现这个接口方法的方法就能被拦截。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>以上四种方式，前三种理解，第四种需要掌握。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/aop/" data-id="ckn5z34g500e515qcbbck75co" data-title="AOP 面向切面编程" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AOP/" rel="tag">AOP</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-190406-attribute" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/attribute/" class="article-date">
  <time class="dt-published" datetime="2019-04-06T05:24:00.000Z" itemprop="datePublished">2019-04-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a>►<a class="article-category-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/attribute/">Attribute特性简介</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Attribute-特性"><a href="#Attribute-特性" class="headerlink" title="Attribute 特性"></a>Attribute 特性</h2><h3 id="特性简介"><a href="#特性简介" class="headerlink" title="特性简介"></a>特性简介</h3><p>特性（<code>Attribute</code>）是用于在运行时传递程序中各种元素（比如类、方法、结构、枚举、组件等）的行为信息的声明性标签。您可以通过使用特性向程序添加声明性信息。一个声明性标签是通过放置在它所应用的元素前面的方括号（<code>[ ]</code>）来描述的。  </p>
<p> 特性（<code>Attribute</code>）用于添加元数据，如编译器指令和注释、描述、方法、类等其他信息。<code>.Net</code> 框架提供了两种类型的特性：预定义特性和自定义特性。  </p>
<p><strong>与注释的区别：</strong> 注释仅在 <code>IDE</code> 环境中使用，特性可以影响编译器或程序运行，可以在不破坏类型封装的前提下，为对象增加额外的信息，执行额外的行为。</p>
<h3 id="特性语法"><a href="#特性语法" class="headerlink" title="特性语法"></a>特性语法</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">attribute(positional_parameters, name_parameter = value, ...)</span>]  </span><br><span class="line">element</span><br></pre></td></tr></table></figure>
<p>特性（<code>Attribute</code>）的名称和值是在方括号内规定的，放置在它所应用的元素之前。<code>positional_parameters</code> 规定必需的信息，<code>name_parameter</code> 规定可选的信息。</p>
<h2 id="预定义特性"><a href="#预定义特性" class="headerlink" title="预定义特性"></a>预定义特性</h2><h3 id="AttributeUsage"><a href="#AttributeUsage" class="headerlink" title="AttributeUsage"></a><code>AttributeUsage</code></h3><p>预定义特性 <code>AttributeUsage</code> 描述了如何使用一个自定义特性类。它规定了特性可应用到的项目的类型。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(validon, AllowMultiple=allowmultiple, Inherited=inherited)</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>参数 <code>validon</code> 规定特性可被放置的语言元素。它是枚举器 AttributeTargets 的值的组合。默认值是 <code>AttributeTargets.All</code>。  </li>
<li>参数 <code>allowmultiple</code>（可选的）为该特性的 <code>AllowMultiple</code> 属性（<code>property</code>）提供一个布尔值。如果为 <code>true</code>，则该特性是多用的。默认值是 <code>false</code>（单用的）。  </li>
<li>参数 <code>inherited</code>（可选的）为该特性的 <code>Inherited</code> 属性（<code>property</code>）提供一个布尔值。如果为 <code>true</code>，则该特性可被派生类继承。默认值是 <code>false</code>（不被继承）。</li>
</ul>
<p>例如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class | ttributeTargets.Constructor | AttributeTargets.Field | AttributeTargets.Method | AttributeTargets.Property, AllowMultiple = true)</span>]</span><br></pre></td></tr></table></figure>
<h3 id="Conditional"><a href="#Conditional" class="headerlink" title="Conditional"></a><code>Conditional</code></h3><p>这个预定义特性标记了一个条件方法，其执行依赖于它顶的预处理标识符。它会引起方法调用的条件编译，取决于指定的值，比如 <code>Debug</code> 或 <code>Trace</code>。例如，当调试代码时显示变量的值。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Conditional(conditionalSymbol)</span>]</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Conditional(<span class="meta-string">&quot;DEBUG&quot;</span>)</span>]</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> <code>Conditional</code> 特性的方式与 <code>#if...#endif</code>，<code>Conditional</code> 特性的方法是否生效是取决于调用方，而用 <code>#if</code> 方式是否生效是取决于方法定义所在的程序集。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Conditional(<span class="meta-string">&quot;Conditional&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TestOne</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//需要设置项目 属性 -&gt; 生成 -&gt; 条件编译符号 为：Conditional</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;this is test function one.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TestTwo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//需要设置项目 属性 -&gt; 生成 -&gt; 条件编译符号 为：Conditional</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> Conditional</span></span><br><span class="line">    Console.WriteLine(<span class="string">&quot;this is test function two.&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong><code>Conditional</code> 特性可以多个，同时使用多个多个编译符号，多个之间是“或”的关系。</p>
<h3 id="Obsolete"><a href="#Obsolete" class="headerlink" title="Obsolete"></a>Obsolete</h3><p>这个预定义特性标记了不应被使用的程序实体。它可以让您通知编译器丢弃某个特定的目标元素。例如，当一个新方法被用在一个类中，但是您仍然想要保持类中的旧方法，您可以通过显示一个应该使用新方法，而不是旧方法的消息，来把它标记为 <code>obsolete</code>（过时的）。  </p>
<p>规定该特性的语法如下：</p>
<p><code>[Obsolete(message)]</code> 或 <code>[Obsolete(message, iserror)]</code>  </p>
<ul>
<li>参数 <code>message</code>，是一个字符串，描述项目为什么过时的原因以及该替代使用什么。  </li>
<li>参数 <code>iserror</code>，是一个布尔值。如果该值为 <code>true</code>，编译器应把该项目的使用当作一个错误。默认值是 <code>false</code>（编译器生成一个警告）。</li>
</ul>
<h2 id="自定义特性"><a href="#自定义特性" class="headerlink" title="自定义特性"></a>自定义特性</h2><p><code>.Net</code> 框架允许创建自定义特性，用于存储声明性的信息，且可在运行时被检索。该信息根据设计标准和应用程序需要，可与任何目标元素相关。  </p>
<p>创建并使用自定义特性包含四个步骤：</p>
<ul>
<li>声明自定义特性；构建自定义特性；</li>
<li>在目标程序元素上应用自定义特性；</li>
<li>通过反射访问特性；</li>
<li>最后一个步骤包含编写一个简单的程序来读取元数据以便查找各种符号。元数据是用于描述其他数据的数据和信息。该程序应使用反射来在运行时访问特性。</li>
</ul>
<h3 id="声明自定义特性"><a href="#声明自定义特性" class="headerlink" title="声明自定义特性"></a>声明自定义特性</h3><p>一个新的自定义特性应派生自 System.Attribute 类。例如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Constructor | AttributeTargets.Field | AttributeTargets.Method | AttributeTargets.Property, AllowMultiple = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeveloperInfoAttribute</span> : <span class="title">Attribute</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="构建自定义特性"><a href="#构建自定义特性" class="headerlink" title="构建自定义特性"></a>构建自定义特性</h3><p>每个特性必须至少有一个构造函数。必需的定位（<code>positional</code>）参数应通过构造函数传递。例如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Class | AttributeTargets.Constructor | AttributeTargets.Field | AttributeTargets.Method | AttributeTargets.Property, AllowMultiple = true)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeveloperInfoAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DeveloperInfoAttribute</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> date</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        DeveloperName = name;</span><br><span class="line">        DeveloperDate = date;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DeveloperName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> DeveloperDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Describe &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="应用自定义特性"><a href="#应用自定义特性" class="headerlink" title="应用自定义特性"></a>应用自定义特性</h3><p>通过把特性放置在紧接着它的目标之前，来应用该特性。例如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DeveloperInfo(<span class="meta-string">&quot;John&quot;</span>, <span class="meta-string">&quot;2018-06-23&quot;</span>, Describe = <span class="meta-string">&quot;this is a test class.&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Business</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">DeveloperInfo(<span class="meta-string">&quot;John&quot;</span>, <span class="meta-string">&quot;2018-06-23&quot;</span>, Describe = <span class="meta-string">&quot;this is a test property.&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> TestProperty &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    [<span class="meta">DeveloperInfo(<span class="meta-string">&quot;John&quot;</span>, <span class="meta-string">&quot;2018-06-23&quot;</span>, Describe = <span class="meta-string">&quot;this is a test method.&quot;</span>)</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TestMethod</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="通过反射访问特性"><a href="#通过反射访问特性" class="headerlink" title="通过反射访问特性"></a>通过反射访问特性</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="built_in">object</span>[] attr = <span class="keyword">typeof</span>(Business).GetCustomAttributes(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; attr.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (attr[i] <span class="keyword">is</span> DeveloperInfoAttribute)</span><br><span class="line">        &#123;</span><br><span class="line">            DeveloperInfoAttribute developer = attr[i] <span class="keyword">as</span> DeveloperInfoAttribute;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Name:<span class="subst">&#123;developer.DeveloperName&#125;</span> Date:<span class="subst">&#123;developer.DeveloperDate&#125;</span> Describe:<span class="subst">&#123;developer.Describe&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    MethodInfo[] method = <span class="keyword">typeof</span>(Business).GetMethods();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; method.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">object</span>[] attr = method[i].GetCustomAttributes(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; attr.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (attr[j] <span class="keyword">is</span> DeveloperInfoAttribute)</span><br><span class="line">            &#123;</span><br><span class="line">                DeveloperInfoAttribute developer = attr[j] <span class="keyword">as</span> DeveloperInfoAttribute;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Name:<span class="subst">&#123;developer.DeveloperName&#125;</span> Date:<span class="subst">&#123;developer.DeveloperDate&#125;</span> Describe:<span class="subst">&#123;developer.Describe&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    PropertyInfo[] property = <span class="keyword">typeof</span>(Business).GetProperties();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; property.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">object</span>[] attr = property[i].GetCustomAttributes(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; attr.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (attr[j] <span class="keyword">is</span> DeveloperInfoAttribute)</span><br><span class="line">            &#123;</span><br><span class="line">                DeveloperInfoAttribute developer = attr[j] <span class="keyword">as</span> DeveloperInfoAttribute;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Name:<span class="subst">&#123;developer.DeveloperName&#125;</span> Date:<span class="subst">&#123;developer.DeveloperDate&#125;</span> Describe:<span class="subst">&#123;developer.Describe&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>自定义的 <code>Attribute</code> 必须直接或者间接继承 <code>System.Attribute</code>。</li>
<li>这里有一个约定：所有自定义的特性名称都应该有个 <code>Attribute</code> 后缀。因为当你的 <code>Attribute</code> 施加到一个程序的元素上的时候，编译器先查找你的 <code>Attribute</code> 的定义，如果没有找到，那么它就会查找 特性名称 + <code>Attribute</code> 的定义。如果都没有找到，那么编译器就报错。</li>
<li><code>Attribute</code> 可以关联的元素包括：程序集(<code>assembly</code>)、模块(<code>module</code>)、类型(<code>type</code>)、属性(<code>property</code>)、事件(<code>event</code>)、字段(<code>field</code>)、方法(<code>method</code>)、参数(<code>param</code>)、返回值(<code>return</code>)。</li>
<li><code>AttributeTargets</code> 目标包括：<ul>
<li><code>All</code>：可以对任何应用程序元素应用属性；</li>
<li><code>Assembly</code>：可以对程序集应用属性；</li>
<li><code>Class</code>：可以对类应用属性；</li>
<li><code>Constructor</code>：可以对构造函数应用属性；</li>
<li><code>Delegate</code>：可以对委托应用属性；</li>
<li><code>Enum</code>：可以对枚举应用属性；</li>
<li><code>Event</code>：可以对事件应用属性；</li>
<li><code>Field</code>：可以对字段应用属性；</li>
<li><code>GenericParameter</code>：可以对泛型参数应用属性；</li>
<li><code>Interface</code>：可以对接口应用属性；</li>
<li><code>Method</code>：可以对方法应用属性；</li>
<li><code>Module</code>：<code>Module</code> 指的是可移植的可执行文件（<code>.dll</code> 或 <code>.exe</code>），而非 <code>Visual Basic</code> 标准模块；</li>
<li><code>Parameter</code>：可以对参数应用属性；</li>
<li><code>Property</code>：可以对属性 (<code>Property</code>) 应用属性 (<code>Attribute</code>)；</li>
<li><code>ReturnValue</code>：可以对返回值应用属性；</li>
<li><code>Struct</code>：可以对结构应用属性，即值类型。</li>
</ul>
</li>
<li><code>AttributeUsageAttribute</code>中的3个属性（<code>Property</code>）说明：<ul>
<li><code>ValidOn</code>：该定位参数指定可在其上放置所指示的属性 (<code>Attribute</code>) 的程序元素。<code>AttributeTargets</code> 枚举数中列出了可在其上放置属性 (<code>Attribute</code>) 的所有可能元素的集合。可通过按位“或”运算组合多个 <code>AttributeTargets</code> 值，以获取所需的有效程序元素组合。</li>
<li><code>AllowMultiple</code>：该命名参数指定能否为给定的程序元素多次指定所指示的属性。</li>
<li><code>Inherited</code>：该命名参数指定所指示的属性能否由派生类和重写成员继承。</li>
</ul>
</li>
<li><code>Attribute</code> 检测方法：<ul>
<li><code>IsDefined</code>：如果至少有一个指定的 <code>Attribute</code> 派生类的实例与目标关联，就返回 <code>true</code>。这个方法效率很高，因为他不构造（反序列化）<code>Attribute</code> 类的任何实例。</li>
<li><code>GetCustomAttributes</code>：返回一个数组，其中每个元素都是应用于目标的指定 <code>Attribute</code> 类的一个实例。</li>
<li><code>GetCustomAttributesData</code>：获取 <code>CustomAttributesData</code> 特性信息。</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hd2y.github.io/attribute/" data-id="ckn5z34bs001a15qc7w6ebvte" data-title="Attribute特性简介" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Attribute/" rel="tag">Attribute</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/6/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/8/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/C/">C#</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/C/ASP-NET-Core/">ASP.NET Core</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/C/WPF/">WPF</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1/">业务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80/">基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/Oracle/">Oracle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/PostgreSQL/">PostgreSQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL-Server/">SQL Server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%BA%93/SQLite/">SQLite</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/%E6%9D%82%E8%B0%88/">杂谈</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/MacOS/">MacOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BD%AF%E4%BB%B6/">软件</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/%E5%85%AC%E5%91%8A/">公告</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/%E5%BC%80%E7%AE%B1/">开箱</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/%E6%9D%82%E8%B0%88/">杂谈</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD/">����</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%EF%BF%BD%EF%BF%BD%EF%BF%BD%EF%BF%BD/C/">C#</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/NET-Standard/" rel="tag">.NET Standard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AOP/" rel="tag">AOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASCII/" rel="tag">ASCII</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveX/" rel="tag">ActiveX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Attribute/" rel="tag">Attribute</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Autofac/" rel="tag">Autofac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BFG/" rel="tag">BFG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CCProxy/" rel="tag">CCProxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confluence/" rel="tag">Confluence</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DBeaver/" rel="tag">DBeaver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Expression/" rel="tag">Expression</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fiddler/" rel="tag">Fiddler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fody/" rel="tag">Fody</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDI/" rel="tag">GDI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/" rel="tag">GitHub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitea/" rel="tag">Gitea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HIS/" rel="tag">HIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HongYang/" rel="tag">HongYang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDE/" rel="tag">IDE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IE/" rel="tag">IE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jint/" rel="tag">Jint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/" rel="tag">Json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kindle/" rel="tag">Kindle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LIS/" rel="tag">LIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LODOP/" rel="tag">LODOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC/" rel="tag">MVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MahApps-Metro/" rel="tag">MahApps.Metro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Math/" rel="tag">Math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NHibernate/" rel="tag">NHibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nexus3/" rel="tag">Nexus3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Note/" rel="tag">Note</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NuGet/" rel="tag">NuGet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/" rel="tag">OOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SOA/" rel="tag">SOA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/" rel="tag">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/" rel="tag">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Telegram/" rel="tag">Telegram</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TreeView/" rel="tag">TreeView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tuple/" rel="tag">Tuple</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/" rel="tag">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UML/" rel="tag">UML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity/" rel="tag">Unity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VS/" rel="tag">VS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/" rel="tag">VSCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ValueTuple/" rel="tag">ValueTuple</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WCF/" rel="tag">WCF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WPF/" rel="tag">WPF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebApi/" rel="tag">WebApi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebService/" rel="tag">WebService</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wiki/" rel="tag">Wiki</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WinForm/" rel="tag">WinForm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/" rel="tag">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows-XP/" rel="tag">Windows XP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xml/" rel="tag">Xml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decimal/" rel="tag">decimal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/frp/" rel="tag">frp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdbc/" rel="tag">jdbc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/" rel="tag">json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mstsc/" rel="tag">mstsc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%B2%E5%8F%A3/" rel="tag">串口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%94%E7%AC%94/" rel="tag">五笔</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" rel="tag">依赖注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%83%E7%BB%84/" rel="tag">元组</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E5%AF%86/" rel="tag">加密</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/" rel="tag">动态链接库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%B0%84/" rel="tag">反射</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9/" rel="tag">图片压缩</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A7%94%E6%89%98/" rel="tag">委托</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B4%E9%BE%84/" rel="tag">年龄</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">序列化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%83%E5%85%83/" rel="tag">弃元</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8D%B0/" rel="tag">打印</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8B%BC%E9%9F%B3/" rel="tag">拼音</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E5%BF%97/" rel="tag">日志</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/" rel="tag">构造函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/" rel="tag">析构函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%9A%E4%B8%BE/" rel="tag">枚举</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99/" rel="tag">正则</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%89%E5%AD%97/" rel="tag">汉字</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%9B%E5%9E%8B/" rel="tag">泛型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%91%9E%E7%BE%8E/" rel="tag">瑞美</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A1%80%E7%90%83%E4%BB%AA/" rel="tag">血球仪</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%A3%E6%9E%84%E5%87%BD%E6%95%B0/" rel="tag">解构函数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9D%E5%85%8B%E6%9B%BC/" rel="tag">贝克曼</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BA%AB%E4%BB%BD%E8%AF%81%E8%AF%BB%E5%8D%A1/" rel="tag">身份证读卡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6/" rel="tag">软件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9C%E7%A8%8B/" rel="tag">远程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AA%E9%80%80/" rel="tag">闪退</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Standard/" style="font-size: 10px;">.NET Standard</a> <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/ASCII/" style="font-size: 10px;">ASCII</a> <a href="/tags/ActiveX/" style="font-size: 10px;">ActiveX</a> <a href="/tags/Attribute/" style="font-size: 10px;">Attribute</a> <a href="/tags/Autofac/" style="font-size: 10px;">Autofac</a> <a href="/tags/BFG/" style="font-size: 10px;">BFG</a> <a href="/tags/CCProxy/" style="font-size: 10px;">CCProxy</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/Confluence/" style="font-size: 10px;">Confluence</a> <a href="/tags/DBeaver/" style="font-size: 12px;">DBeaver</a> <a href="/tags/Expression/" style="font-size: 10px;">Expression</a> <a href="/tags/Fiddler/" style="font-size: 10px;">Fiddler</a> <a href="/tags/Fody/" style="font-size: 10px;">Fody</a> <a href="/tags/GDI/" style="font-size: 12px;">GDI</a> <a href="/tags/Git/" style="font-size: 12px;">Git</a> <a href="/tags/GitHub/" style="font-size: 12px;">GitHub</a> <a href="/tags/Gitea/" style="font-size: 10px;">Gitea</a> <a href="/tags/HIS/" style="font-size: 12px;">HIS</a> <a href="/tags/HongYang/" style="font-size: 10px;">HongYang</a> <a href="/tags/IDE/" style="font-size: 10px;">IDE</a> <a href="/tags/IE/" style="font-size: 10px;">IE</a> <a href="/tags/JavaScript/" style="font-size: 12px;">JavaScript</a> <a href="/tags/Jint/" style="font-size: 12px;">Jint</a> <a href="/tags/Json/" style="font-size: 10px;">Json</a> <a href="/tags/Kindle/" style="font-size: 10px;">Kindle</a> <a href="/tags/LIS/" style="font-size: 20px;">LIS</a> <a href="/tags/LODOP/" style="font-size: 10px;">LODOP</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MahApps-Metro/" style="font-size: 10px;">MahApps.Metro</a> <a href="/tags/Math/" style="font-size: 10px;">Math</a> <a href="/tags/NHibernate/" style="font-size: 10px;">NHibernate</a> <a href="/tags/Nexus3/" style="font-size: 10px;">Nexus3</a> <a href="/tags/Note/" style="font-size: 10px;">Note</a> <a href="/tags/NuGet/" style="font-size: 10px;">NuGet</a> <a href="/tags/OOP/" style="font-size: 10px;">OOP</a> <a href="/tags/Oracle/" style="font-size: 10px;">Oracle</a> <a href="/tags/SOA/" style="font-size: 16px;">SOA</a> <a href="/tags/SSH/" style="font-size: 10px;">SSH</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Telegram/" style="font-size: 10px;">Telegram</a> <a href="/tags/TreeView/" style="font-size: 10px;">TreeView</a> <a href="/tags/Tuple/" style="font-size: 10px;">Tuple</a> <a href="/tags/UI/" style="font-size: 12px;">UI</a> <a href="/tags/UML/" style="font-size: 10px;">UML</a> <a href="/tags/Unity/" style="font-size: 10px;">Unity</a> <a href="/tags/VS/" style="font-size: 10px;">VS</a> <a href="/tags/VSCode/" style="font-size: 10px;">VSCode</a> <a href="/tags/ValueTuple/" style="font-size: 10px;">ValueTuple</a> <a href="/tags/WCF/" style="font-size: 12px;">WCF</a> <a href="/tags/WPF/" style="font-size: 10px;">WPF</a> <a href="/tags/WebApi/" style="font-size: 14px;">WebApi</a> <a href="/tags/WebService/" style="font-size: 16px;">WebService</a> <a href="/tags/Wiki/" style="font-size: 10px;">Wiki</a> <a href="/tags/WinForm/" style="font-size: 10px;">WinForm</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Windows-XP/" style="font-size: 12px;">Windows XP</a> <a href="/tags/Xml/" style="font-size: 10px;">Xml</a> <a href="/tags/decimal/" style="font-size: 10px;">decimal</a> <a href="/tags/frp/" style="font-size: 10px;">frp</a> <a href="/tags/jdbc/" style="font-size: 10px;">jdbc</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/mstsc/" style="font-size: 10px;">mstsc</a> <a href="/tags/%E4%B8%B2%E5%8F%A3/" style="font-size: 12px;">串口</a> <a href="/tags/%E4%BA%94%E7%AC%94/" style="font-size: 10px;">五笔</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 12px;">代理</a> <a href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">依赖注入</a> <a href="/tags/%E5%85%83%E7%BB%84/" style="font-size: 12px;">元组</a> <a href="/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 10px;">加密</a> <a href="/tags/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/" style="font-size: 10px;">动态链接库</a> <a href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 10px;">反射</a> <a href="/tags/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9/" style="font-size: 10px;">图片压缩</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 18px;">多线程</a> <a href="/tags/%E5%A7%94%E6%89%98/" style="font-size: 10px;">委托</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E5%B9%B4%E9%BE%84/" style="font-size: 10px;">年龄</a> <a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 10px;">序列化</a> <a href="/tags/%E5%BC%83%E5%85%83/" style="font-size: 10px;">弃元</a> <a href="/tags/%E6%89%93%E5%8D%B0/" style="font-size: 10px;">打印</a> <a href="/tags/%E6%8B%BC%E9%9F%B3/" style="font-size: 10px;">拼音</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 10px;">日志</a> <a href="/tags/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/" style="font-size: 10px;">构造函数</a> <a href="/tags/%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/" style="font-size: 10px;">析构函数</a> <a href="/tags/%E6%9E%9A%E4%B8%BE/" style="font-size: 10px;">枚举</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 14px;">正则</a> <a href="/tags/%E6%B1%89%E5%AD%97/" style="font-size: 10px;">汉字</a> <a href="/tags/%E6%B3%9B%E5%9E%8B/" style="font-size: 12px;">泛型</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 10px;">爬虫</a> <a href="/tags/%E7%91%9E%E7%BE%8E/" style="font-size: 12px;">瑞美</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 12px;">虚拟机</a> <a href="/tags/%E8%A1%80%E7%90%83%E4%BB%AA/" style="font-size: 10px;">血球仪</a> <a href="/tags/%E8%A7%A3%E6%9E%84%E5%87%BD%E6%95%B0/" style="font-size: 10px;">解构函数</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12px;">设计模式</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E8%B4%9D%E5%85%8B%E6%9B%BC/" style="font-size: 10px;">贝克曼</a> <a href="/tags/%E8%BA%AB%E4%BB%BD%E8%AF%81%E8%AF%BB%E5%8D%A1/" style="font-size: 10px;">身份证读卡</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">软件</a> <a href="/tags/%E8%BF%9C%E7%A8%8B/" style="font-size: 10px;">远程</a> <a href="/tags/%E9%97%AA%E9%80%80/" style="font-size: 10px;">闪退</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 10px;">项目</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/map-json-file-to-entity-class/">ӳ�� JSON �ļ���ʵ����</a>
          </li>
        
          <li>
            <a href="/deploy-the-enterprise-knowledge-base-confluence/">部署企业知识库 Confluence</a>
          </li>
        
          <li>
            <a href="/debugging-web-service-services-using-fiddler/">使用 Fiddler 调试 WebService 服务</a>
          </li>
        
          <li>
            <a href="/get-the-database-password-of-ruimei-system/">获取瑞美系统数据库密码</a>
          </li>
        
          <li>
            <a href="/chinese-helper/">汉字帮助类——获取拼音与五笔简码</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 hd2y<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>